<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Supabase é›†æˆéªŒè¯æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FFFBF5;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        .test-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .icon {
            font-size: 1.5rem;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
            border-color: #28a745;
            background: #f8fff9;
        }
        .error {
            color: #dc3545;
            border-color: #dc3545;
            background: #fff8f8;
        }
        .warning {
            color: #ffc107;
            border-color: #ffc107;
            background: #fffef8;
        }
        .info {
            color: #17a2b8;
            border-color: #17a2b8;
            background: #f8feff;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { 
            background: #ffc107; 
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-top: 30px;
        }
        .summary-card h2 {
            margin-bottom: 15px;
            font-size: 1.8rem;
        }
        .config-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Supabase é›†æˆéªŒè¯æµ‹è¯•</h1>
            <p>å…¨é¢éªŒè¯ Supabase æ•°æ®åº“è¿æ¥ã€å­˜å‚¨æ¡¶é…ç½®å’Œ RLS ç­–ç•¥</p>
        </div>

        <div class="content">
            <!-- é…ç½®ä¿¡æ¯ -->
            <div class="config-info" id="configInfo">
                <strong>å½“å‰é…ç½®:</strong><br>
                URL: åŠ è½½ä¸­...<br>
                Key: åŠ è½½ä¸­...<br>
                çŠ¶æ€: åˆå§‹åŒ–ä¸­...
            </div>

            <!-- æµ‹è¯•ç½‘æ ¼ -->
            <div class="test-grid">
                <!-- æ•°æ®åº“è¿æ¥æµ‹è¯• -->
                <div class="test-card">
                    <h3><span class="icon">ğŸ”—</span>æ•°æ®åº“è¿æ¥æµ‹è¯•</h3>
                    <button class="btn" onclick="testDatabaseConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
                    <div class="result" id="dbResult">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•æ•°æ®åº“è¿æ¥...</div>
                </div>

                <!-- å­˜å‚¨æ¡¶æµ‹è¯• -->
                <div class="test-card">
                    <h3><span class="icon">ğŸ—‚ï¸</span>å­˜å‚¨æ¡¶éªŒè¯</h3>
                    <button class="btn" onclick="testStorageBuckets()">æ£€æŸ¥å­˜å‚¨æ¡¶</button>
                    <div class="result" id="storageResult">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥å­˜å‚¨æ¡¶é…ç½®...</div>
                </div>

                <!-- RLS ç­–ç•¥æµ‹è¯• -->
                <div class="test-card">
                    <h3><span class="icon">ğŸ”’</span>RLS ç­–ç•¥æµ‹è¯•</h3>
                    <button class="btn" onclick="testRLSPolicies()">æµ‹è¯• RLS ç­–ç•¥</button>
                    <div class="result" id="rlsResult">ç‚¹å‡»æŒ‰é’®æµ‹è¯•è¡Œçº§å®‰å…¨ç­–ç•¥...</div>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼ æµ‹è¯• -->
                <div class="test-card">
                    <h3><span class="icon">ğŸ“¤</span>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
                    <button class="btn" onclick="testFileUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </button>
                    <div class="result" id="uploadResult">ç‚¹å‡»æŒ‰é’®æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½...</div>
                </div>

                <!-- æ•°æ®è¡¨æµ‹è¯• -->
                <div class="test-card">
                    <h3><span class="icon">ğŸ“Š</span>æ•°æ®è¡¨éªŒè¯</h3>
                    <button class="btn" onclick="testDatabaseTables()">æ£€æŸ¥æ•°æ®è¡¨</button>
                    <div class="result" id="tablesResult">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥æ•°æ®è¡¨ç»“æ„...</div>
                </div>

                <!-- æƒé™æµ‹è¯• -->
                <div class="test-card">
                    <h3><span class="icon">ğŸ‘¤</span>ç”¨æˆ·æƒé™æµ‹è¯•</h3>
                    <button class="btn" onclick="testUserPermissions()">æµ‹è¯•ç”¨æˆ·æƒé™</button>
                    <div class="result" id="permissionsResult">ç‚¹å‡»æŒ‰é’®æµ‹è¯•ç”¨æˆ·æƒé™é…ç½®...</div>
                </div>
            </div>

            <!-- ç»¼åˆæµ‹è¯• -->
            <div class="test-card">
                <h3><span class="icon">ğŸš€</span>ç»¼åˆé›†æˆæµ‹è¯•</h3>
                <button class="btn" onclick="runFullIntegrationTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <div class="result" id="fullTestResult">ç‚¹å‡»æŒ‰é’®è¿è¡Œå®Œæ•´çš„é›†æˆæµ‹è¯•...</div>
            </div>

            <!-- æµ‹è¯•ç»“æœæ±‡æ€» -->
            <div class="summary-card" id="summaryCard" style="display: none;">
                <h2>ğŸ“‹ æµ‹è¯•ç»“æœæ±‡æ€»</h2>
                <div id="summaryContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                flowType: 'pkce',
            },
        });

        // æµ‹è¯•ç»“æœå­˜å‚¨
        let testResults = {};

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            updateConfigInfo();
        });

        // æ›´æ–°é…ç½®ä¿¡æ¯æ˜¾ç¤º
        function updateConfigInfo() {
            const configDiv = document.getElementById('configInfo');
            configDiv.innerHTML = `
                <strong>å½“å‰é…ç½®:</strong><br>
                URL: ${SUPABASE_URL}<br>
                Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...<br>
                çŠ¶æ€: å·²é…ç½® âœ…
            `;
        }

        // æ—¥å¿—å‡½æ•°
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            
            if (element.innerHTML === 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•æ•°æ®åº“è¿æ¥...' || 
                element.innerHTML.includes('ç‚¹å‡»æŒ‰é’®')) {
                element.innerHTML = '';
            }
            
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        // 1. æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            log('dbResult', 'å¼€å§‹æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                const { data, error } = await supabaseClient
                    .from('preset_categories')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    log('dbResult', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    testResults.database = false;
                    return;
                }
                
                log('dbResult', 'æ•°æ®åº“è¿æ¥æˆåŠŸ âœ…', 'success');
                
                // æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½
                const { data: categories, error: queryError } = await supabaseClient
                    .from('preset_categories')
                    .select('*')
                    .limit(3);
                
                if (queryError) {
                    log('dbResult', `æŸ¥è¯¢æµ‹è¯•å¤±è´¥: ${queryError.message}`, 'error');
                    testResults.database = false;
                    return;
                }
                
                log('dbResult', `æŸ¥è¯¢æµ‹è¯•æˆåŠŸï¼Œæ‰¾åˆ° ${categories.length} ä¸ªåˆ†ç±»`, 'success');
                testResults.database = true;
                
            } catch (error) {
                log('dbResult', `è¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
                testResults.database = false;
            }
        }

        // 2. æµ‹è¯•å­˜å‚¨æ¡¶
        async function testStorageBuckets() {
            log('storageResult', 'å¼€å§‹æ£€æŸ¥å­˜å‚¨æ¡¶é…ç½®...', 'info');
            
            const requiredBuckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
            
            try {
                // é¦–å…ˆå°è¯• listBuckets()
                const { data: buckets, error } = await supabaseClient.storage.listBuckets();
                
                if (error) {
                    log('storageResult', `listBuckets() å¤±è´¥: ${error.message}`, 'warning');
                    log('storageResult', 'å°è¯•é€šè¿‡ç›´æ¥è®¿é—®æµ‹è¯•å­˜å‚¨æ¡¶...', 'info');
                    
                    // å¦‚æœ listBuckets() å¤±è´¥ï¼Œé€šè¿‡ç›´æ¥è®¿é—®æµ‹è¯•å­˜å‚¨æ¡¶
                    let allBucketsExist = true;
                    
                    for (const bucket of requiredBuckets) {
                        try {
                            const { data, error: listError } = await supabaseClient.storage
                                .from(bucket)
                                .list('', { limit: 1 });
                            
                            if (listError) {
                                log('storageResult', `âŒ ${bucket} å­˜å‚¨æ¡¶ä¸å¯è®¿é—®: ${listError.message}`, 'error');
                                allBucketsExist = false;
                            } else {
                                log('storageResult', `âœ… ${bucket} å­˜å‚¨æ¡¶å­˜åœ¨ä¸”å¯è®¿é—®`, 'success');
                            }
                        } catch (err) {
                            log('storageResult', `âŒ ${bucket} å­˜å‚¨æ¡¶æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                            allBucketsExist = false;
                        }
                    }
                    
                    testResults.storage = allBucketsExist;
                    return;
                }
                
                log('storageResult', `æ‰¾åˆ° ${buckets.length} ä¸ªå­˜å‚¨æ¡¶`, 'info');
                
                // å¦‚æœ listBuckets() è¿”å›ç©ºæ•°ç»„ï¼Œä¹Ÿä½¿ç”¨ç›´æ¥è®¿é—®æ–¹æ³•
                if (buckets.length === 0) {
                    log('storageResult', 'listBuckets() è¿”å›ç©ºæ•°ç»„ï¼Œå¯èƒ½æ˜¯è®¤è¯é—®é¢˜', 'warning');
                    log('storageResult', 'å°è¯•é€šè¿‡ç›´æ¥è®¿é—®æµ‹è¯•å­˜å‚¨æ¡¶...', 'info');
                    
                    let allBucketsExist = true;
                    
                    for (const bucket of requiredBuckets) {
                        try {
                            const { data, error: listError } = await supabaseClient.storage
                                .from(bucket)
                                .list('', { limit: 1 });
                            
                            if (listError) {
                                log('storageResult', `âŒ ${bucket} å­˜å‚¨æ¡¶ä¸å¯è®¿é—®: ${listError.message}`, 'error');
                                allBucketsExist = false;
                            } else {
                                log('storageResult', `âœ… ${bucket} å­˜å‚¨æ¡¶å­˜åœ¨ä¸”å¯è®¿é—®`, 'success');
                            }
                        } catch (err) {
                            log('storageResult', `âŒ ${bucket} å­˜å‚¨æ¡¶æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                            allBucketsExist = false;
                        }
                    }
                    
                    if (allBucketsExist) {
                        log('storageResult', 'æ‰€æœ‰å¿…éœ€çš„å­˜å‚¨æ¡¶éƒ½å·²é…ç½® âœ…', 'success');
                        testResults.storage = true;
                    } else {
                        log('storageResult', 'éƒ¨åˆ†å­˜å‚¨æ¡¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ Supabase é…ç½®', 'warning');
                        testResults.storage = false;
                    }
                    return;
                }
                
                const existingBuckets = buckets.map(b => b.id);
                let allBucketsExist = true;
                
                for (const bucket of requiredBuckets) {
                    if (existingBuckets.includes(bucket)) {
                        log('storageResult', `âœ… ${bucket} å­˜å‚¨æ¡¶å­˜åœ¨`, 'success');
                    } else {
                        log('storageResult', `âŒ ${bucket} å­˜å‚¨æ¡¶ç¼ºå¤±`, 'error');
                        allBucketsExist = false;
                    }
                }
                
                if (allBucketsExist) {
                    log('storageResult', 'æ‰€æœ‰å¿…éœ€çš„å­˜å‚¨æ¡¶éƒ½å·²é…ç½® âœ…', 'success');
                    testResults.storage = true;
                } else {
                    log('storageResult', 'éƒ¨åˆ†å­˜å‚¨æ¡¶ç¼ºå¤±ï¼Œè¯·è¿è¡Œ storage-setup.sql', 'warning');
                    testResults.storage = false;
                }
                
            } catch (error) {
                log('storageResult', `å­˜å‚¨æ¡¶æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                testResults.storage = false;
            }
        }

        // 3. æµ‹è¯• RLS ç­–ç•¥
        async function testRLSPolicies() {
            log('rlsResult', 'å¼€å§‹æµ‹è¯• RLS ç­–ç•¥...', 'info');
            
            try {
                // æµ‹è¯•å…¬å¼€æ•°æ®è®¿é—®
                const { data: publicData, error: publicError } = await supabaseClient
                    .from('preset_worlds')
                    .select('*')
                    .eq('is_public', true)
                    .limit(1);
                
                if (publicError) {
                    log('rlsResult', `å…¬å¼€æ•°æ®è®¿é—®å¤±è´¥: ${publicError.message}`, 'error');
                    testResults.rls = false;
                    return;
                }
                
                log('rlsResult', 'å…¬å¼€æ•°æ®è®¿é—®æ­£å¸¸ âœ…', 'success');
                
                // æµ‹è¯•ç®¡ç†å‘˜æƒé™è¡¨è®¿é—®
                const { data: adminData, error: adminError } = await supabaseClient
                    .from('preset_world_admins')
                    .select('*')
                    .limit(1);
                
                if (adminError) {
                    log('rlsResult', `ç®¡ç†å‘˜æ•°æ®è®¿é—®: ${adminError.message}`, 'warning');
                } else {
                    log('rlsResult', 'ç®¡ç†å‘˜æ•°æ®è®¿é—®æ­£å¸¸ âœ…', 'success');
                }
                
                log('rlsResult', 'RLS ç­–ç•¥æµ‹è¯•å®Œæˆ', 'success');
                testResults.rls = true;
                
            } catch (error) {
                log('rlsResult', `RLS æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                testResults.rls = false;
            }
        }

        // 4. æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
        async function testFileUpload() {
            log('uploadResult', 'å¼€å§‹æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½...', 'info');
            
            try {
                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾ç‰‡æ–‡ä»¶ï¼ˆPNGæ ¼å¼ï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾æ¡ˆ
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(0, 0, 100, 100);
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '20px Arial';
                ctx.fillText('TEST', 25, 55);
                
                // è½¬æ¢ä¸º Blob
                const testFile = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/png');
                });
                const fileName = `test-${Date.now()}.png`;
                
                // å°è¯•ä¸Šä¼ åˆ° sticker-images å­˜å‚¨æ¡¶
                const { data, error } = await supabaseClient.storage
                    .from('sticker-images')
                    .upload(fileName, testFile);
                
                if (error) {
                    log('uploadResult', `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                    testResults.upload = false;
                    return;
                }
                
                log('uploadResult', `æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${data.path}`, 'success');
                
                // è·å–å…¬å¼€ URL
                const { data: urlData } = supabaseClient.storage
                    .from('sticker-images')
                    .getPublicUrl(fileName);
                
                log('uploadResult', `å…¬å¼€ URL: ${urlData.publicUrl}`, 'info');
                
                // æ¸…ç†æµ‹è¯•æ–‡ä»¶
                await supabaseClient.storage
                    .from('sticker-images')
                    .remove([fileName]);
                
                log('uploadResult', 'æµ‹è¯•æ–‡ä»¶å·²æ¸…ç† âœ…', 'success');
                testResults.upload = true;
                
            } catch (error) {
                log('uploadResult', `ä¸Šä¼ æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                testResults.upload = false;
            }
        }

        // 5. æµ‹è¯•æ•°æ®è¡¨
        async function testDatabaseTables() {
            log('tablesResult', 'å¼€å§‹æ£€æŸ¥æ•°æ®è¡¨ç»“æ„...', 'info');
            
            const requiredTables = [
                'preset_worlds',
                'preset_categories', 
                'preset_world_admins',
                'preset_world_usage'
            ];
            
            let allTablesExist = true;
            
            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabaseClient
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        log('tablesResult', `âŒ ${table} è¡¨ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®`, 'error');
                        allTablesExist = false;
                    } else {
                        log('tablesResult', `âœ… ${table} è¡¨å­˜åœ¨`, 'success');
                    }
                } catch (error) {
                    log('tablesResult', `âŒ ${table} æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
                    allTablesExist = false;
                }
            }
            
            if (allTablesExist) {
                log('tablesResult', 'æ‰€æœ‰å¿…éœ€çš„æ•°æ®è¡¨éƒ½å­˜åœ¨ âœ…', 'success');
                testResults.tables = true;
            } else {
                log('tablesResult', 'éƒ¨åˆ†æ•°æ®è¡¨ç¼ºå¤±ï¼Œè¯·æ‰§è¡Œ supabase-setup-complete.sql', 'warning');
                testResults.tables = false;
            }
        }

        // 6. æµ‹è¯•ç”¨æˆ·æƒé™
        async function testUserPermissions() {
            log('permissionsResult', 'å¼€å§‹æµ‹è¯•ç”¨æˆ·æƒé™...', 'info');
            
            try {
                // æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€
                const { data: user, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    log('permissionsResult', 'æœªç™»å½•ç”¨æˆ·ï¼Œæµ‹è¯•åŒ¿åè®¿é—®æƒé™', 'info');
                } else {
                    log('permissionsResult', `å½“å‰ç”¨æˆ·: ${user.user?.email || 'åŒ¿å'}`, 'info');
                }
                
                // æµ‹è¯•ç®¡ç†å‘˜æƒé™æ£€æŸ¥
                const { data: adminCheck, error: adminError } = await supabaseClient
                    .from('preset_world_admins')
                    .select('*')
                    .eq('user_id', 'admin-user-1')
                    .single();
                
                if (adminError) {
                    log('permissionsResult', `ç®¡ç†å‘˜æƒé™æ£€æŸ¥: ${adminError.message}`, 'warning');
                } else {
                    log('permissionsResult', `æ‰¾åˆ°ç®¡ç†å‘˜ç”¨æˆ·: ${adminCheck.user_email}`, 'success');
                }
                
                log('permissionsResult', 'ç”¨æˆ·æƒé™æµ‹è¯•å®Œæˆ âœ…', 'success');
                testResults.permissions = true;
                
            } catch (error) {
                log('permissionsResult', `æƒé™æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                testResults.permissions = false;
            }
        }

        // è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•
        async function runFullIntegrationTest() {
            log('fullTestResult', 'å¼€å§‹è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•...', 'info');
            
            testResults = {};
            
            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            await testDatabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testStorageBuckets();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testRLSPolicies();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFileUpload();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDatabaseTables();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUserPermissions();
            
            // æ˜¾ç¤ºæ±‡æ€»ç»“æœ
            showTestSummary();
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœæ±‡æ€»
        function showTestSummary() {
            const summaryCard = document.getElementById('summaryCard');
            const summaryContent = document.getElementById('summaryContent');
            
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const failedTests = totalTests - passedTests;
            
            let summaryHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold;">${totalTests}</div>
                        <div>æ€»æµ‹è¯•æ•°</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #90EE90;">${passedTests}</div>
                        <div>é€šè¿‡æµ‹è¯•</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #FFB6C1;">${failedTests}</div>
                        <div>å¤±è´¥æµ‹è¯•</div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: left;">
                    <h3>è¯¦ç»†ç»“æœ:</h3>
                    <ul style="margin-top: 10px;">
            `;
            
            const testNames = {
                database: 'æ•°æ®åº“è¿æ¥',
                storage: 'å­˜å‚¨æ¡¶é…ç½®',
                rls: 'RLS ç­–ç•¥',
                upload: 'æ–‡ä»¶ä¸Šä¼ ',
                tables: 'æ•°æ®è¡¨ç»“æ„',
                permissions: 'ç”¨æˆ·æƒé™'
            };
            
            for (const [key, result] of Object.entries(testResults)) {
                const status = result ? 'âœ…' : 'âŒ';
                const name = testNames[key] || key;
                summaryHtml += `<li>${status} ${name}</li>`;
            }
            
            summaryHtml += '</ul></div>';
            
            if (failedTests === 0) {
                summaryHtml += '<div style="margin-top: 20px; padding: 15px; background: rgba(144, 238, 144, 0.2); border-radius: 8px;"><strong>ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Supabase é›†æˆé…ç½®æ­£å¸¸ã€‚</strong></div>';
            } else {
                summaryHtml += '<div style="margin-top: 20px; padding: 15px; background: rgba(255, 182, 193, 0.2); border-radius: 8px;"><strong>âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å¹¶æ‰§è¡Œç›¸åº”çš„è®¾ç½®è„šæœ¬ã€‚</strong></div>';
            }
            
            summaryContent.innerHTML = summaryHtml;
            summaryCard.style.display = 'block';
            
            // æ»šåŠ¨åˆ°æ±‡æ€»åŒºåŸŸ
            summaryCard.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>