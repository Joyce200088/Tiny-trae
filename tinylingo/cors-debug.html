<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS 调试工具</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .url-input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 CORS 调试工具</h1>
        <p>诊断 ERR_BLOCKED_BY_ORB 错误</p>
        
        <input type="text" id="testUrl" class="url-input" 
               value="https://knizbnlzwcuniceqvmvd.supabase.co/storage/v1/object/public/world-thumbnails/8adf3209-e805-4798-a859-6a6e19192f00/1759808425186_thumbnail.png"
               placeholder="输入要测试的 URL">
        
        <button onclick="testBasicFetch()">📡 基础 Fetch 测试</button>
        <button onclick="testImageLoad()">🖼️ 图片加载测试</button>
        <button onclick="testCorsHeaders()">🔍 检查 CORS 头部</button>
        <button onclick="testNoCors()">🚫 No-CORS 模式</button>
        
        <div id="results" class="log">等待测试结果...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }

        function clearLog() {
            document.getElementById('results').innerHTML = '';
        }

        async function testBasicFetch() {
            clearLog();
            const url = document.getElementById('testUrl').value;
            log(`开始测试基础 Fetch: ${url}`);
            
            try {
                const response = await fetch(url);
                log(`✅ Fetch 成功! Status: ${response.status}`, 'success');
                log(`Content-Type: ${response.headers.get('content-type')}`);
                log(`Content-Length: ${response.headers.get('content-length')}`);
                
                // 尝试读取响应
                const blob = await response.blob();
                log(`✅ 响应读取成功! Size: ${blob.size} bytes`, 'success');
                
            } catch (error) {
                log(`❌ Fetch 失败: ${error.message}`, 'error');
                log(`Error type: ${error.name}`, 'error');
            }
        }

        async function testImageLoad() {
            clearLog();
            const url = document.getElementById('testUrl').value;
            log(`开始测试图片加载: ${url}`);
            
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                log(`✅ 图片加载成功! 尺寸: ${img.width}x${img.height}`, 'success');
            };
            
            img.onerror = function(e) {
                log(`❌ 图片加载失败`, 'error');
                log(`Error event: ${JSON.stringify(e)}`, 'error');
            };
            
            img.src = url;
        }

        async function testCorsHeaders() {
            clearLog();
            const url = document.getElementById('testUrl').value;
            log(`开始检查 CORS 头部: ${url}`);
            
            try {
                const response = await fetch(url, {
                    method: 'HEAD'
                });
                
                log(`✅ HEAD 请求成功! Status: ${response.status}`, 'success');
                
                // 检查重要的 CORS 头部
                const corsHeaders = [
                    'access-control-allow-origin',
                    'access-control-allow-methods',
                    'access-control-allow-headers',
                    'content-type',
                    'cache-control'
                ];
                
                corsHeaders.forEach(header => {
                    const value = response.headers.get(header);
                    if (value) {
                        log(`${header}: ${value}`);
                    } else {
                        log(`${header}: (未设置)`, 'error');
                    }
                });
                
            } catch (error) {
                log(`❌ HEAD 请求失败: ${error.message}`, 'error');
            }
        }

        async function testNoCors() {
            clearLog();
            const url = document.getElementById('testUrl').value;
            log(`开始测试 No-CORS 模式: ${url}`);
            
            try {
                const response = await fetch(url, {
                    mode: 'no-cors'
                });
                
                log(`✅ No-CORS 请求成功! Status: ${response.status}`, 'success');
                log(`Response type: ${response.type}`);
                
                // 在 no-cors 模式下，我们无法读取响应内容
                log(`注意: no-cors 模式下无法读取响应内容`);
                
            } catch (error) {
                log(`❌ No-CORS 请求失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动运行基础测试
        window.onload = function() {
            log('🚀 CORS 调试工具已加载');
            log('点击按钮开始测试...');
        };
    </script>
</body>
</html>