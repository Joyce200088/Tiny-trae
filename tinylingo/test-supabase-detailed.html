<!DOCTYPE html>
<html>
<head>
    <title>Detailed Supabase Tables Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Detailed Supabase Tables Test</h1>
    <div id="results"></div>
    
    <script>
        const supabaseUrl = "https://knizbnlzwcuniceqvmvd.supabase.co"
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ"
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        function addResult(message, type = 'info') {
            const results = document.getElementById("results")
            results.innerHTML += `<div class="${type}">${message}</div>`
        }
        
        function addSection(title, content) {
            const results = document.getElementById("results")
            results.innerHTML += `<div class="test-section"><h3>${title}</h3>${content}</div>`
        }
        
        async function testConnection() {
            addResult("üîó Testing Supabase connection...", "info")
            
            try {
                // Test basic connection
                const { data, error } = await supabase.from('users').select('count', { count: 'exact', head: true })
                
                if (error) {
                    addResult(`‚ùå Connection test failed: ${error.message}`, "error")
                    addResult(`Error details: ${JSON.stringify(error, null, 2)}`, "error")
                } else {
                    addResult("‚úÖ Basic connection successful", "success")
                }
            } catch (err) {
                addResult(`‚ùå Connection error: ${err.message}`, "error")
            }
        }
        
        async function testTable(tableName) {
            addResult(`üìã Testing table: ${tableName}`, "info")
            
            try {
                // Test table existence and access
                const { data, error, count } = await supabase
                    .from(tableName)
                    .select('*', { count: 'exact', head: true })
                
                if (error) {
                    addResult(`‚ùå Error accessing ${tableName}: ${error.message}`, "error")
                    addResult(`Error code: ${error.code}`, "error")
                    addResult(`Error details: ${error.details}`, "error")
                    addResult(`Error hint: ${error.hint}`, "error")
                    return false
                } else {
                    addResult(`‚úÖ ${tableName} table exists and accessible (${count || 0} rows)`, "success")
                    return true
                }
            } catch (err) {
                addResult(`‚ùå Exception testing ${tableName}: ${err.message}`, "error")
                return false
            }
        }
        
        async function testUserSyncStatus() {
            addResult("üîÑ Testing user_sync_status table specifically...", "info")
            
            try {
                // Test with specific user_id
                const testUserId = 'test-user-123'
                
                // Try to insert a test record
                const { data: insertData, error: insertError } = await supabase
                    .from('user_sync_status')
                    .insert({
                        user_id: testUserId,
                        data_type: 'stickers',
                        last_sync_at: new Date().toISOString(),
                        sync_version: 1,
                        is_syncing: false
                    })
                    .select()
                
                if (insertError) {
                    addResult(`‚ùå Insert test failed: ${insertError.message}`, "error")
                    addResult(`Insert error code: ${insertError.code}`, "error")
                    addResult(`Insert error details: ${insertError.details}`, "error")
                } else {
                    addResult("‚úÖ Insert test successful", "success")
                    
                    // Try to read the record
                    const { data: selectData, error: selectError } = await supabase
                        .from('user_sync_status')
                        .select('*')
                        .eq('user_id', testUserId)
                        .eq('data_type', 'stickers')
                    
                    if (selectError) {
                        addResult(`‚ùå Select test failed: ${selectError.message}`, "error")
                    } else {
                        addResult(`‚úÖ Select test successful: ${JSON.stringify(selectData)}`, "success")
                        
                        // Clean up test record
                        await supabase
                            .from('user_sync_status')
                            .delete()
                            .eq('user_id', testUserId)
                            .eq('data_type', 'stickers')
                    }
                }
            } catch (err) {
                addResult(`‚ùå Exception in user_sync_status test: ${err.message}`, "error")
            }
        }
        
        async function runAllTests() {
            const results = document.getElementById("results")
            results.innerHTML = "<h2>üöÄ Starting comprehensive Supabase tests...</h2>"
            
            // Test connection
            await testConnection()
            
            // Test all tables
            const tables = ['users', 'user_worlds', 'user_stickers', 'user_backgrounds', 'user_sync_status']
            const tableResults = {}
            
            for (const table of tables) {
                tableResults[table] = await testTable(table)
            }
            
            // Summary
            addSection("üìä Test Summary", 
                Object.entries(tableResults)
                    .map(([table, success]) => 
                        `<div class="${success ? 'success' : 'error'}">${table}: ${success ? '‚úÖ OK' : '‚ùå FAILED'}</div>`
                    ).join('')
            )
            
            // Special test for user_sync_status
            if (tableResults['user_sync_status']) {
                await testUserSyncStatus()
            }
            
            addResult("üèÅ All tests completed!", "info")
        }
        
        // Run tests when page loads
        runAllTests()
    </script>
</body>
</html>