<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试世界保存功能</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #FFFBF5;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>世界保存功能测试</h1>
    
    <div class="test-section">
        <h2>1. Supabase 连接测试</h2>
        <button onclick="testSupabaseConnection()">测试连接</button>
        <div id="connection-status"></div>
    </div>

    <div class="test-section">
        <h2>2. 本地存储测试</h2>
        <button onclick="testLocalStorage()">测试本地存储</button>
        <div id="localstorage-status"></div>
    </div>

    <div class="test-section">
        <h2>3. 世界数据保存测试</h2>
        <button onclick="testWorldSave()">测试保存世界</button>
        <div id="worldsave-status"></div>
    </div>

    <div class="test-section">
        <h2>4. 完整保存流程测试</h2>
        <button onclick="testFullSaveFlow()">测试完整流程</button>
        <div id="fullflow-status"></div>
    </div>

    <div class="test-section">
        <h2>测试日志</h2>
        <button onclick="clearLog()">清空日志</button>
        <div id="test-log" class="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const supabaseUrl = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('test-log').textContent = '';
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 测试 Supabase 连接
        async function testSupabaseConnection() {
            log('开始测试 Supabase 连接...');
            showStatus('connection-status', '正在测试连接...', 'info');
            
            try {
                // 测试基本连接
                const { data, error } = await supabaseClient.from('user_worlds').select('count', { count: 'exact', head: true });
                
                if (error) {
                    log(`Supabase 连接错误: ${error.message}`);
                    showStatus('connection-status', `连接失败: ${error.message}`, 'error');
                } else {
                    log('Supabase 连接成功');
                    showStatus('connection-status', '连接成功！', 'success');
                }
            } catch (err) {
                log(`连接异常: ${err.message}`);
                showStatus('connection-status', `连接异常: ${err.message}`, 'error');
            }
        }

        // 测试本地存储
        function testLocalStorage() {
            log('开始测试本地存储...');
            showStatus('localstorage-status', '正在测试本地存储...', 'info');
            
            try {
                const testKey = 'test-world-save';
                const testData = {
                    id: Date.now(),
                    name: '测试世界',
                    timestamp: new Date().toISOString()
                };
                
                // 保存测试数据
                localStorage.setItem(testKey, JSON.stringify(testData));
                log('本地存储写入成功');
                
                // 读取测试数据
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                if (retrieved && retrieved.id === testData.id) {
                    log('本地存储读取成功');
                    showStatus('localstorage-status', '本地存储功能正常！', 'success');
                } else {
                    log('本地存储读取失败');
                    showStatus('localstorage-status', '本地存储读取失败', 'error');
                }
                
                // 清理测试数据
                localStorage.removeItem(testKey);
                log('测试数据已清理');
                
            } catch (err) {
                log(`本地存储测试失败: ${err.message}`);
                showStatus('localstorage-status', `本地存储测试失败: ${err.message}`, 'error');
            }
        }

        // 测试世界数据保存
        async function testWorldSave() {
            log('开始测试世界数据保存...');
            showStatus('worldsave-status', '正在测试世界保存...', 'info');
            
            try {
                // 首先确保用户存在
                log('确保 guest 用户存在...');
                const { data: existingUser, error: userCheckError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('user_id', 'guest')
                    .single();

                if (userCheckError && userCheckError.code === 'PGRST116') {
                    // 用户不存在，创建用户
                    log('创建 guest 用户...');
                    const { data: newUser, error: createUserError } = await supabaseClient
                        .from('users')
                        .insert({
                            user_id: 'guest',
                            username: 'Guest User',
                            email: 'guest@example.com',
                            preferences: {}
                        })
                        .select()
                        .single();

                    if (createUserError) {
                        log(`创建用户失败: ${createUserError.message}`);
                        throw new Error(`创建用户失败: ${createUserError.message}`);
                    }
                    log('Guest 用户创建成功');
                } else if (userCheckError) {
                    log(`检查用户失败: ${userCheckError.message}`);
                    throw new Error(`检查用户失败: ${userCheckError.message}`);
                } else {
                    log('Guest 用户已存在');
                }

                const testWorldData = {
                    id: `test-world-${Date.now()}`,
                    name: '测试世界保存',
                    description: '这是一个测试世界',
                    thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwN2JmZiIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VGVzdDwvdGV4dD48L3N2Zz4=',
                    coverUrl: '',
                    previewImage: '',
                    stickers: [
                        {
                            word: 'test',
                            cn: '测试',
                            pos: 'noun',
                            image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjAiIGZpbGw9IiNmZjAwMDAiLz48L3N2Zz4=',
                            audio: { uk: '', us: '' },
                            examples: [{ en: 'This is a test.', cn: '这是一个测试。' }],
                            mnemonic: ['测试记忆法'],
                            masteryStatus: 'new',
                            tags: ['test'],
                            relatedWords: []
                        }
                    ],
                    stickerCount: 1,
                    uniqueWordCount: 1,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // 保存到本地存储
                const userKey = 'guest-worlds';
                let worlds = [];
                try {
                    const existing = localStorage.getItem(userKey);
                    if (existing) {
                        worlds = JSON.parse(existing);
                    }
                } catch (e) {
                    log('读取现有世界数据失败，使用空数组');
                }

                worlds.push(testWorldData);
                localStorage.setItem(userKey, JSON.stringify(worlds));
                log('世界数据已保存到本地存储');

                // 尝试同步到 Supabase
                try {
                    const { data, error } = await supabaseClient
                        .from('user_worlds')
                        .upsert({
                            user_id: 'guest',
                            world_id: testWorldData.id,
                            name: testWorldData.name,
                            description: testWorldData.description,
                            thumbnail: testWorldData.thumbnail,
                            cover_url: testWorldData.coverUrl,
                            preview_image: testWorldData.previewImage,
                            sticker_count: testWorldData.stickerCount,
                            word_count: testWorldData.uniqueWordCount,
                            canvas_objects: [],
                            canvas_data: {},
                            tags: [],
                            is_public: false,
                            likes: 0,
                            favorites: 0,
                            last_modified: testWorldData.updatedAt
                        });

                    if (error) {
                        log(`Supabase 同步失败: ${error.message}`);
                        showStatus('worldsave-status', `本地保存成功，但 Supabase 同步失败: ${error.message}`, 'error');
                    } else {
                        log('世界数据已成功同步到 Supabase');
                        showStatus('worldsave-status', '世界保存成功！本地和云端都已保存', 'success');
                    }
                } catch (syncError) {
                    log(`Supabase 同步异常: ${syncError.message}`);
                    showStatus('worldsave-status', `本地保存成功，但同步异常: ${syncError.message}`, 'error');
                }

            } catch (err) {
                log(`世界保存测试失败: ${err.message}`);
                showStatus('worldsave-status', `世界保存测试失败: ${err.message}`, 'error');
            }
        }

        // 测试完整保存流程
        async function testFullSaveFlow() {
            log('开始测试完整保存流程...');
            showStatus('fullflow-status', '正在测试完整流程...', 'info');
            
            try {
                // 1. 检查环境
                log('1. 检查运行环境...');
                if (typeof localStorage === 'undefined') {
                    throw new Error('localStorage 不可用');
                }
                if (!supabaseClient) {
                    throw new Error('Supabase 客户端未初始化');
                }

                // 2. 确保用户存在
                log('2. 确保 guest 用户存在...');
                const { data: existingUser, error: userCheckError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('user_id', 'guest')
                    .single();

                if (userCheckError && userCheckError.code === 'PGRST116') {
                    // 用户不存在，创建用户
                    log('创建 guest 用户...');
                    const { data: newUser, error: createUserError } = await supabaseClient
                        .from('users')
                        .insert({
                            user_id: 'guest',
                            username: 'Guest User',
                            email: 'guest@example.com',
                            preferences: {}
                        })
                        .select()
                        .single();

                    if (createUserError) {
                        log(`创建用户失败: ${createUserError.message}`);
                        throw new Error(`创建用户失败: ${createUserError.message}`);
                    }
                    log('Guest 用户创建成功');
                } else if (userCheckError) {
                    log(`检查用户失败: ${userCheckError.message}`);
                    throw new Error(`检查用户失败: ${userCheckError.message}`);
                } else {
                    log('Guest 用户已存在');
                }

                // 3. 模拟创建世界数据
                log('3. 创建测试世界数据...');
                const worldData = {
                    id: `full-test-${Date.now()}`,
                    name: '完整流程测试世界',
                    description: '测试完整的保存流程',
                    thumbnail: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzI4YTc0NSIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RnVsbDwvdGV4dD48L3N2Zz4=',
                    coverUrl: '',
                    previewImage: '',
                    stickers: [],
                    stickerCount: 0,
                    uniqueWordCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // 4. 本地保存
                log('4. 保存到本地存储...');
                const userKey = 'guest-worlds';
                let worlds = [];
                try {
                    const existing = localStorage.getItem(userKey);
                    if (existing) {
                        worlds = JSON.parse(existing);
                    }
                } catch (e) {
                    worlds = [];
                }

                // 检查是否已存在
                const existingIndex = worlds.findIndex(w => w.id === worldData.id);
                if (existingIndex >= 0) {
                    worlds[existingIndex] = worldData;
                    log('更新现有世界数据');
                } else {
                    worlds.push(worldData);
                    log('添加新世界数据');
                }

                localStorage.setItem(userKey, JSON.stringify(worlds));
                log('本地保存完成');

                // 5. 云端同步
                log('5. 同步到 Supabase...');
                const { data, error } = await supabaseClient
                    .from('user_worlds')
                    .upsert({
                        user_id: 'guest',
                        world_id: worldData.id,
                        name: worldData.name,
                        description: worldData.description,
                        thumbnail: worldData.thumbnail,
                        cover_url: worldData.coverUrl,
                        preview_image: worldData.previewImage,
                        sticker_count: worldData.stickerCount,
                        word_count: worldData.uniqueWordCount,
                        canvas_objects: [],
                        canvas_data: {},
                        tags: [],
                        is_public: false,
                        likes: 0,
                        favorites: 0,
                        last_modified: worldData.updatedAt
                    });

                if (error) {
                    log(`云端同步失败: ${error.message}`);
                    showStatus('fullflow-status', `完整流程测试：本地成功，云端失败 - ${error.message}`, 'error');
                } else {
                    log('云端同步成功');
                    
                    // 5. 验证保存结果
                    log('5. 验证保存结果...');
                    const { data: verifyData, error: verifyError } = await supabaseClient
                        .from('user_worlds')
                        .select('*')
                        .eq('world_id', worldData.id)
                        .eq('user_id', 'guest')
                        .single();

                    if (verifyError) {
                        log(`验证失败: ${verifyError.message}`);
                        showStatus('fullflow-status', `保存成功但验证失败: ${verifyError.message}`, 'error');
                    } else if (verifyData) {
                        log('验证成功：数据已正确保存到云端');
                        showStatus('fullflow-status', '完整流程测试成功！所有步骤都正常工作', 'success');
                    } else {
                        log('验证失败：未找到保存的数据');
                        showStatus('fullflow-status', '保存成功但验证时未找到数据', 'error');
                    }
                }

            } catch (err) {
                log(`完整流程测试失败: ${err.message}`);
                showStatus('fullflow-status', `完整流程测试失败: ${err.message}`, 'error');
            }
        }

        // 页面加载时显示初始信息
        window.onload = function() {
            log('页面加载完成，准备开始测试');
            log(`Supabase URL: ${supabaseUrl}`);
            log(`Supabase Key: ${supabaseKey.substring(0, 20)}...`);
        };
    </script>
</body>
</html>