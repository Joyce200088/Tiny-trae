<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世界保存功能调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .world-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .world-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .world-details {
            font-size: 12px;
            color: #6c757d;
        }
        .test-form {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>世界保存功能调试工具</h1>
        <p>此工具用于诊断新建世界数据保存问题，包括背景和贴纸数据的保存。</p>

        <!-- 当前状态检查 -->
        <div class="section">
            <h3>1. 当前状态检查</h3>
            <button class="button" onclick="checkCurrentState()">检查当前状态</button>
            <div id="currentStateResult"></div>
        </div>

        <!-- 模拟世界创建测试 -->
        <div class="section">
            <h3>2. 模拟世界创建测试</h3>
            <div class="test-form">
                <div class="form-group">
                    <label for="testWorldName">世界名称:</label>
                    <input type="text" id="testWorldName" value="测试世界" placeholder="输入世界名称">
                </div>
                <div class="form-group">
                    <label for="testWorldDesc">世界描述:</label>
                    <textarea id="testWorldDesc" placeholder="输入世界描述">这是一个测试世界，用于验证保存功能</textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeBackground" checked> 包含背景数据
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="includeStickers" checked> 包含贴纸数据
                    </label>
                </div>
            </div>
            <button class="button" onclick="testWorldCreation()">创建测试世界</button>
            <button class="button" onclick="testWorldUpdate()">更新测试世界</button>
            <div id="worldCreationResult"></div>
        </div>

        <!-- localStorage 检查 -->
        <div class="section">
            <h3>3. localStorage 数据检查</h3>
            <button class="button" onclick="checkLocalStorage()">检查 localStorage</button>
            <button class="button danger" onclick="clearLocalStorage()">清空 localStorage</button>
            <div id="localStorageResult"></div>
        </div>

        <!-- 世界数据列表 -->
        <div class="section">
            <h3>4. 已保存的世界数据</h3>
            <button class="button" onclick="loadWorldsList()">刷新世界列表</button>
            <div id="worldsListResult"></div>
        </div>

        <!-- 保存功能测试 -->
        <div class="section">
            <h3>5. 保存功能详细测试</h3>
            <button class="button" onclick="testSaveFunction()">测试保存函数</button>
            <button class="button" onclick="testLoadFunction()">测试加载函数</button>
            <div id="saveFunctionResult"></div>
        </div>

        <!-- 调试日志 -->
        <div class="section">
            <h3>6. 调试日志</h3>
            <button class="button" onclick="clearLog()">清空日志</button>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            const logElement = document.getElementById('debugLog');
            logElement.textContent = debugLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            debugLog = [];
            document.getElementById('debugLog').textContent = '';
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${content}</div>`;
        }

        // 检查当前状态
        async function checkCurrentState() {
            log('开始检查当前状态...');
            
            try {
                // 检查localStorage支持
                const hasLocalStorage = typeof(Storage) !== "undefined";
                log(`localStorage 支持: ${hasLocalStorage}`);
                
                // 检查用户ID
                let userId = 'guest';
                try {
                    // 模拟获取用户ID的逻辑
                    const urlPath = window.location.pathname;
                    const userMatch = urlPath.match(/\/u\/([^\/]+)/);
                    if (userMatch) {
                        userId = userMatch[1];
                    }
                } catch (error) {
                    log(`获取用户ID失败: ${error.message}`);
                }
                log(`当前用户ID: ${userId}`);
                
                // 检查存储键
                const storageKey = `tinylingo_worlds_${userId}`;
                log(`使用的存储键: ${storageKey}`);
                
                // 检查现有数据
                const existingData = localStorage.getItem(storageKey);
                const worldCount = existingData ? JSON.parse(existingData).length : 0;
                log(`现有世界数量: ${worldCount}`);
                
                showResult('currentStateResult', 
                    `✅ 状态检查完成<br>
                    - localStorage 支持: ${hasLocalStorage}<br>
                    - 用户ID: ${userId}<br>
                    - 存储键: ${storageKey}<br>
                    - 现有世界数量: ${worldCount}`, 
                    'success'
                );
                
            } catch (error) {
                log(`状态检查失败: ${error.message}`, 'error');
                showResult('currentStateResult', `❌ 状态检查失败: ${error.message}`, 'error');
            }
        }

        // 模拟世界创建
        async function testWorldCreation() {
            log('开始测试世界创建...');
            
            try {
                const worldName = document.getElementById('testWorldName').value || '测试世界';
                const worldDesc = document.getElementById('testWorldDesc').value || '测试描述';
                const includeBackground = document.getElementById('includeBackground').checked;
                const includeStickers = document.getElementById('includeStickers').checked;
                
                // 创建测试世界数据
                const worldData = {
                    id: `test-world-${Date.now()}`,
                    name: worldName,
                    description: worldDesc,
                    thumbnail: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    coverUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    previewImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                    wordCount: includeStickers ? 3 : 0,
                    stickerCount: includeStickers ? 3 : 0,
                    likes: 0,
                    favorites: 0,
                    isPublic: false,
                    tags: ['测试'],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    needsSync: true
                };

                // 添加背景数据
                if (includeBackground) {
                    worldData.selectedBackground = {
                        id: 'bg-test',
                        type: 'color',
                        value: '#FFFBF5'
                    };
                    worldData.canvasData = {
                        background: worldData.selectedBackground,
                        objects: []
                    };
                }

                // 添加贴纸数据
                if (includeStickers) {
                    worldData.canvasObjects = [
                        {
                            id: 'sticker-1',
                            type: 'sticker',
                            x: 100,
                            y: 100,
                            width: 80,
                            height: 80,
                            stickerData: {
                                id: 'apple-1',
                                word: 'apple',
                                cn: '苹果',
                                pos: 'noun',
                                image: '/apple.png',
                                audio: {
                                    uk: '/audio/apple-uk.mp3',
                                    us: '/audio/apple-us.mp3'
                                },
                                examples: [
                                    { en: 'I eat an apple every day.', cn: '我每天吃一个苹果。' },
                                    { en: 'The apple is red and sweet.', cn: '这个苹果又红又甜。' }
                                ],
                                mnemonic: ['Apple来自古英语æppel，与德语Apfel同源'],
                                masteryStatus: 'new',
                                tags: ['Fruit', 'Food'],
                                relatedWords: [
                                    { word: 'eat', pos: 'verb' },
                                    { word: 'bite', pos: 'verb' },
                                    { word: 'pick', pos: 'verb' },
                                    { word: 'fruit', pos: 'noun' },
                                    { word: 'sweet', pos: 'adj' },
                                    { word: 'fresh', pos: 'adj' },
                                    { word: 'tree', pos: 'noun' },
                                    { word: 'healthy', pos: 'adj' },
                                    { word: 'juice', pos: 'noun' },
                                    { word: 'daily', pos: 'adv' }
                                ],
                                // 兼容性字段
                                name: 'apple'
                            }
                        },
                        {
                            id: 'sticker-2',
                            type: 'sticker',
                            x: 200,
                            y: 150,
                            width: 80,
                            height: 80,
                            stickerData: {
                                id: 'book-2',
                                word: 'book',
                                cn: '书',
                                pos: 'noun',
                                image: '/book.png',
                                audio: {
                                    uk: '/audio/book-uk.mp3',
                                    us: '/audio/book-us.mp3'
                                },
                                examples: [
                                    { en: 'I read a book every night.', cn: '我每晚读一本书。' },
                                    { en: 'This book is very interesting.', cn: '这本书很有趣。' }
                                ],
                                mnemonic: ['Book来自古英语bōc，原意为山毛榉树，因早期在树皮上写字'],
                                masteryStatus: 'new',
                                tags: ['Education', 'Reading'],
                                relatedWords: [
                                    { word: 'read', pos: 'verb' },
                                    { word: 'write', pos: 'verb' },
                                    { word: 'study', pos: 'verb' },
                                    { word: 'page', pos: 'noun' },
                                    { word: 'interesting', pos: 'adj' },
                                    { word: 'educational', pos: 'adj' },
                                    { word: 'knowledge', pos: 'noun' },
                                    { word: 'thick', pos: 'adj' },
                                    { word: 'library', pos: 'noun' },
                                    { word: 'carefully', pos: 'adv' }
                                ],
                                // 兼容性字段
                                name: 'book'
                            }
                        },
                        {
                            id: 'sticker-3',
                            type: 'sticker',
                            x: 300,
                            y: 200,
                            width: 80,
                            height: 80,
                            stickerData: {
                                id: 'cat-3',
                                word: 'cat',
                                cn: '猫',
                                pos: 'noun',
                                image: '/cat.png',
                                audio: {
                                    uk: '/audio/cat-uk.mp3',
                                    us: '/audio/cat-us.mp3'
                                },
                                examples: [
                                    { en: 'The cat is sleeping on the sofa.', cn: '猫在沙发上睡觉。' },
                                    { en: 'My cat likes to play with yarn.', cn: '我的猫喜欢玩毛线。' }
                                ],
                                mnemonic: ['Cat来自拉丁语cattus，可能源于埃及语'],
                                masteryStatus: 'new',
                                tags: ['Animal', 'Pet'],
                                relatedWords: [
                                    { word: 'pet', pos: 'verb' },
                                    { word: 'feed', pos: 'verb' },
                                    { word: 'play', pos: 'verb' },
                                    { word: 'kitten', pos: 'noun' },
                                    { word: 'fluffy', pos: 'adj' },
                                    { word: 'cute', pos: 'adj' },
                                    { word: 'whiskers', pos: 'noun' },
                                    { word: 'playful', pos: 'adj' },
                                    { word: 'fur', pos: 'noun' },
                                    { word: 'quietly', pos: 'adv' }
                                ],
                                // 兼容性字段
                                name: 'cat'
                            }
                        }
                    ];
                }

                log(`创建的世界数据: ${JSON.stringify(worldData, null, 2)}`);

                // 模拟保存过程
                await simulateWorldSave(worldData);
                
                showResult('worldCreationResult', 
                    `✅ 测试世界创建成功<br>
                    - 世界ID: ${worldData.id}<br>
                    - 世界名称: ${worldData.name}<br>
                    - 包含背景: ${includeBackground}<br>
                    - 包含贴纸: ${includeStickers}<br>
                    - 贴纸数量: ${worldData.stickerCount}`, 
                    'success'
                );
                
            } catch (error) {
                log(`世界创建测试失败: ${error.message}`, 'error');
                showResult('worldCreationResult', `❌ 世界创建测试失败: ${error.message}`, 'error');
            }
        }

        // 模拟世界更新
        async function testWorldUpdate() {
            log('开始测试世界更新...');
            
            try {
                // 获取现有世界
                const userId = 'joyce'; // 假设用户ID
                const storageKey = `tinylingo_worlds_${userId}`;
                const existingData = localStorage.getItem(storageKey);
                
                if (!existingData) {
                    throw new Error('没有找到现有世界数据，请先创建测试世界');
                }
                
                const worlds = JSON.parse(existingData);
                if (worlds.length === 0) {
                    throw new Error('世界列表为空，请先创建测试世界');
                }
                
                // 更新第一个世界
                const worldToUpdate = { ...worlds[0] };
                worldToUpdate.name = `${worldToUpdate.name} (已更新)`;
                worldToUpdate.description = `${worldToUpdate.description} - 更新于 ${new Date().toLocaleString()}`;
                worldToUpdate.updatedAt = new Date().toISOString();
                worldToUpdate.lastModified = new Date().toISOString();
                worldToUpdate.needsSync = true;
                
                // 添加更多贴纸数据
                if (worldToUpdate.canvasObjects) {
                    worldToUpdate.canvasObjects.push({
                        id: `sticker-update-${Date.now()}`,
                        type: 'sticker',
                        x: 400,
                        y: 250,
                        width: 80,
                        height: 80,
                        stickerData: {
                            id: 'dog-4',
                            word: 'dog',
                            cn: '狗',
                            pos: 'noun',
                            image: '/dog.png',
                            audio: {
                                uk: '/audio/dog-uk.mp3',
                                us: '/audio/dog-us.mp3'
                            },
                            examples: [
                                { en: 'The dog is barking loudly.', cn: '狗在大声叫。' },
                                { en: 'I walk my dog every morning.', cn: '我每天早上遛狗。' }
                            ],
                            mnemonic: ['Dog来自古英语docga，词源不明'],
                            masteryStatus: 'new',
                            tags: ['Animal', 'Pet'],
                            relatedWords: [
                                { word: 'walk', pos: 'verb' },
                                { word: 'train', pos: 'verb' },
                                { word: 'bark', pos: 'verb' },
                                { word: 'puppy', pos: 'noun' },
                                { word: 'loyal', pos: 'adj' },
                                { word: 'friendly', pos: 'adj' },
                                { word: 'tail', pos: 'noun' },
                                { word: 'energetic', pos: 'adj' },
                                { word: 'collar', pos: 'noun' },
                                { word: 'happily', pos: 'adv' }
                            ],
                            // 兼容性字段
                            name: 'dog'
                        }
                    });
                    worldToUpdate.stickerCount = worldToUpdate.canvasObjects.length;
                    worldToUpdate.wordCount = worldToUpdate.stickerCount;
                }
                
                log(`更新的世界数据: ${JSON.stringify(worldToUpdate, null, 2)}`);
                
                // 模拟更新过程
                await simulateWorldUpdate(worldToUpdate);
                
                showResult('worldCreationResult', 
                    `✅ 测试世界更新成功<br>
                    - 世界ID: ${worldToUpdate.id}<br>
                    - 更新后名称: ${worldToUpdate.name}<br>
                    - 贴纸数量: ${worldToUpdate.stickerCount}`, 
                    'success'
                );
                
            } catch (error) {
                log(`世界更新测试失败: ${error.message}`, 'error');
                showResult('worldCreationResult', `❌ 世界更新测试失败: ${error.message}`, 'error');
            }
        }

        // 模拟保存世界
        async function simulateWorldSave(worldData) {
            log('模拟保存世界到localStorage...');
            
            // 获取用户存储键
            const userId = 'joyce'; // 假设用户ID
            const storageKey = `tinylingo_worlds_${userId}`;
            
            // 加载现有数据
            const existingData = localStorage.getItem(storageKey);
            const worlds = existingData ? JSON.parse(existingData) : [];
            
            // 检查是否已存在
            const existingIndex = worlds.findIndex(w => w.id === worldData.id);
            if (existingIndex !== -1) {
                worlds[existingIndex] = worldData;
                log(`更新现有世界: ${worldData.name}`);
            } else {
                worlds.push(worldData);
                log(`添加新世界: ${worldData.name}`);
            }
            
            // 保存到localStorage
            localStorage.setItem(storageKey, JSON.stringify(worlds));
            log(`保存到localStorage成功，当前世界数量: ${worlds.length}`);
            
            // 触发存储事件
            window.dispatchEvent(new StorageEvent('storage', {
                key: storageKey,
                newValue: JSON.stringify(worlds),
                storageArea: localStorage
            }));
            
            log('触发存储变化事件');
        }

        // 模拟更新世界
        async function simulateWorldUpdate(worldData) {
            log('模拟更新世界...');
            
            const userId = 'joyce';
            const storageKey = `tinylingo_worlds_${userId}`;
            
            const existingData = localStorage.getItem(storageKey);
            const worlds = existingData ? JSON.parse(existingData) : [];
            
            const index = worlds.findIndex(w => w.id === worldData.id);
            if (index !== -1) {
                worlds[index] = worldData;
                localStorage.setItem(storageKey, JSON.stringify(worlds));
                log(`世界更新成功: ${worldData.name}`);
                
                // 触发存储事件
                window.dispatchEvent(new StorageEvent('storage', {
                    key: storageKey,
                    newValue: JSON.stringify(worlds),
                    storageArea: localStorage
                }));
            } else {
                throw new Error(`未找到ID为 ${worldData.id} 的世界`);
            }
        }

        // 检查localStorage
        function checkLocalStorage() {
            log('检查localStorage数据...');
            
            try {
                const userId = 'joyce';
                const storageKey = `tinylingo_worlds_${userId}`;
                const data = localStorage.getItem(storageKey);
                
                if (!data) {
                    showResult('localStorageResult', '❌ localStorage中没有找到世界数据', 'error');
                    log('localStorage中没有世界数据');
                    return;
                }
                
                const worlds = JSON.parse(data);
                log(`localStorage中找到 ${worlds.length} 个世界`);
                
                let resultHtml = `✅ localStorage数据检查完成<br>存储键: ${storageKey}<br>世界数量: ${worlds.length}<br><br>`;
                
                worlds.forEach((world, index) => {
                    resultHtml += `<strong>世界 ${index + 1}:</strong><br>`;
                    resultHtml += `- ID: ${world.id}<br>`;
                    resultHtml += `- 名称: ${world.name}<br>`;
                    resultHtml += `- 贴纸数量: ${world.stickerCount || 0}<br>`;
                    resultHtml += `- 单词数量: ${world.wordCount || 0}<br>`;
                    resultHtml += `- 创建时间: ${world.createdAt}<br>`;
                    resultHtml += `- 更新时间: ${world.updatedAt}<br><br>`;
                });
                
                showResult('localStorageResult', resultHtml, 'success');
                
            } catch (error) {
                log(`localStorage检查失败: ${error.message}`, 'error');
                showResult('localStorageResult', `❌ localStorage检查失败: ${error.message}`, 'error');
            }
        }

        // 清空localStorage
        function clearLocalStorage() {
            if (confirm('确定要清空所有世界数据吗？此操作不可恢复！')) {
                log('清空localStorage数据...');
                
                const userId = 'joyce';
                const storageKey = `tinylingo_worlds_${userId}`;
                localStorage.removeItem(storageKey);
                
                showResult('localStorageResult', '✅ localStorage数据已清空', 'success');
                log('localStorage数据已清空');
            }
        }

        // 加载世界列表
        function loadWorldsList() {
            log('加载世界列表...');
            
            try {
                const userId = 'joyce';
                const storageKey = `tinylingo_worlds_${userId}`;
                const data = localStorage.getItem(storageKey);
                
                if (!data) {
                    showResult('worldsListResult', '❌ 没有找到世界数据', 'error');
                    return;
                }
                
                const worlds = JSON.parse(data);
                
                let resultHtml = `<h4>找到 ${worlds.length} 个世界:</h4>`;
                
                worlds.forEach((world, index) => {
                    resultHtml += `
                        <div class="world-item">
                            <h4>${world.name}</h4>
                            <div class="world-details">
                                <strong>ID:</strong> ${world.id}<br>
                                <strong>描述:</strong> ${world.description || '无描述'}<br>
                                <strong>贴纸数量:</strong> ${world.stickerCount || 0}<br>
                                <strong>单词数量:</strong> ${world.wordCount || 0}<br>
                                <strong>创建时间:</strong> ${world.createdAt}<br>
                                <strong>更新时间:</strong> ${world.updatedAt}<br>
                                <strong>是否需要同步:</strong> ${world.needsSync ? '是' : '否'}<br>
                                <strong>背景数据:</strong> ${world.selectedBackground ? '有' : '无'}<br>
                                <strong>画布对象:</strong> ${world.canvasObjects ? world.canvasObjects.length : 0} 个
                            </div>
                        </div>
                    `;
                });
                
                showResult('worldsListResult', resultHtml, 'success');
                log(`成功加载 ${worlds.length} 个世界`);
                
            } catch (error) {
                log(`加载世界列表失败: ${error.message}`, 'error');
                showResult('worldsListResult', `❌ 加载世界列表失败: ${error.message}`, 'error');
            }
        }

        // 测试保存函数
        function testSaveFunction() {
            log('测试保存函数...');
            
            try {
                // 模拟WorldDataUtils.addWorld的逻辑
                const testWorld = {
                    id: `save-test-${Date.now()}`,
                    name: '保存函数测试世界',
                    description: '用于测试保存函数的世界',
                    thumbnail: 'data:image/png;base64,test',
                    wordCount: 1,
                    stickerCount: 1,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    needsSync: true
                };
                
                // 执行保存
                simulateWorldSave(testWorld);
                
                showResult('saveFunctionResult', 
                    `✅ 保存函数测试成功<br>
                    - 测试世界ID: ${testWorld.id}<br>
                    - 保存时间: ${new Date().toLocaleString()}`, 
                    'success'
                );
                
            } catch (error) {
                log(`保存函数测试失败: ${error.message}`, 'error');
                showResult('saveFunctionResult', `❌ 保存函数测试失败: ${error.message}`, 'error');
            }
        }

        // 测试加载函数
        function testLoadFunction() {
            log('测试加载函数...');
            
            try {
                const userId = 'joyce';
                const storageKey = `tinylingo_worlds_${userId}`;
                
                // 模拟WorldDataUtils.loadWorldData的逻辑
                const savedData = localStorage.getItem(storageKey);
                if (!savedData) {
                    throw new Error('没有找到保存的数据');
                }
                
                const worlds = JSON.parse(savedData);
                log(`成功加载 ${worlds.length} 个世界`);
                
                showResult('saveFunctionResult', 
                    `✅ 加载函数测试成功<br>
                    - 加载的世界数量: ${worlds.length}<br>
                    - 加载时间: ${new Date().toLocaleString()}`, 
                    'success'
                );
                
            } catch (error) {
                log(`加载函数测试失败: ${error.message}`, 'error');
                showResult('saveFunctionResult', `❌ 加载函数测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查状态
        window.addEventListener('load', function() {
            log('页面加载完成，开始初始化检查...');
            checkCurrentState();
        });
    </script>
</body>
</html>