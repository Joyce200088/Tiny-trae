<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复 RLS 策略</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>修复 RLS 策略工具</h1>
        <p>此工具将修复 Supabase 数据库的行级安全策略，解决贴纸同步问题。</p>

        <div class="section">
            <h3>1. 连接测试</h3>
            <button onclick="testConnection()">测试 Supabase 连接</button>
            <div id="connectionResult"></div>
        </div>

        <div class="section">
            <h3>2. 执行 RLS 策略修复</h3>
            <button onclick="executeRLSFix()">执行 RLS 策略修复</button>
            <div id="rlsFixResult"></div>
        </div>

        <div class="section">
            <h3>3. 验证修复结果</h3>
            <button onclick="verifyFix()">验证策略修复</button>
            <div id="verifyResult"></div>
        </div>

        <div class="section">
            <h3>4. 测试数据操作</h3>
            <button onclick="testDataOperations()">测试用户和贴纸操作</button>
            <div id="testResult"></div>
        </div>

        <div class="section">
            <h3>操作日志</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            try {
                log('开始测试 Supabase 连接...');
                
                // 测试基本连接
                const { data, error } = await supabase.from('users').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                resultDiv.innerHTML = '<div class="success">✅ Supabase 连接成功</div>';
                log('Supabase 连接测试成功', 'success');
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 连接失败: ${error.message}</div>`;
                log(`连接测试失败: ${error.message}`, 'error');
            }
        }

        async function executeRLSFix() {
            const resultDiv = document.getElementById('rlsFixResult');
            try {
                log('开始执行 RLS 策略修复...');
                
                // RLS 策略修复的 SQL 语句
                const sqlStatements = [
                    // 删除现有策略
                    `DROP POLICY IF EXISTS "Users can manage own stickers" ON user_stickers;`,
                    `DROP POLICY IF EXISTS "Users can manage own worlds" ON user_worlds;`,
                    `DROP POLICY IF EXISTS "Users can manage own backgrounds" ON user_backgrounds;`,
                    `DROP POLICY IF EXISTS "Users can manage own sync status" ON user_sync_status;`,
                    `DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_stickers;`,
                    `DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_worlds;`,
                    `DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_backgrounds;`,
                    `DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_sync_status;`,
                    `DROP POLICY IF EXISTS "Users can insert their own data" ON users;`,
                    `DROP POLICY IF EXISTS "Users can read their own data" ON users;`,
                    `DROP POLICY IF EXISTS "Users can update their own data" ON users;`,
                    
                    // 创建新的宽松策略
                    `CREATE POLICY "Allow anonymous user operations" ON users FOR ALL USING (true) WITH CHECK (true);`,
                    `CREATE POLICY "Allow anonymous sticker operations" ON user_stickers FOR ALL USING (true) WITH CHECK (true);`,
                    `CREATE POLICY "Allow anonymous world operations" ON user_worlds FOR ALL USING (true) WITH CHECK (true);`,
                    `CREATE POLICY "Allow anonymous background operations" ON user_backgrounds FOR ALL USING (true) WITH CHECK (true);`,
                    `CREATE POLICY "Allow anonymous sync operations" ON user_sync_status FOR ALL USING (true) WITH CHECK (true);`
                ];

                let successCount = 0;
                let errorCount = 0;
                
                for (const sql of sqlStatements) {
                    try {
                        const { error } = await supabase.rpc('exec_sql', { sql_query: sql });
                        if (error) {
                            log(`SQL 执行警告: ${sql.substring(0, 50)}... - ${error.message}`, 'error');
                            errorCount++;
                        } else {
                            log(`SQL 执行成功: ${sql.substring(0, 50)}...`, 'success');
                            successCount++;
                        }
                    } catch (err) {
                        log(`SQL 执行异常: ${sql.substring(0, 50)}... - ${err.message}`, 'error');
                        errorCount++;
                    }
                }
                
                if (errorCount === 0) {
                    resultDiv.innerHTML = `<div class="success">✅ RLS 策略修复完成 (${successCount} 条语句执行成功)</div>`;
                    log('RLS 策略修复完成', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">⚠️ RLS 策略修复部分完成 (成功: ${successCount}, 失败: ${errorCount})</div>`;
                    log(`RLS 策略修复部分完成 (成功: ${successCount}, 失败: ${errorCount})`, 'error');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ RLS 策略修复失败: ${error.message}</div>`;
                log(`RLS 策略修复失败: ${error.message}`, 'error');
            }
        }

        async function verifyFix() {
            const resultDiv = document.getElementById('verifyResult');
            try {
                log('开始验证 RLS 策略修复结果...');
                
                // 查询策略信息
                const { data: policies, error: policyError } = await supabase
                    .from('pg_policies')
                    .select('tablename, policyname, permissive, cmd')
                    .in('tablename', ['users', 'user_stickers', 'user_worlds', 'user_backgrounds', 'user_sync_status']);
                
                if (policyError) {
                    throw policyError;
                }
                
                let html = '<div class="success">✅ 策略验证完成</div>';
                html += '<h4>当前 RLS 策略:</h4>';
                html += '<pre>';
                
                if (policies && policies.length > 0) {
                    policies.forEach(policy => {
                        html += `表: ${policy.tablename}, 策略: ${policy.policyname}, 操作: ${policy.cmd}\n`;
                    });
                } else {
                    html += '未找到策略信息（可能需要管理员权限查看）\n';
                }
                
                html += '</pre>';
                resultDiv.innerHTML = html;
                log('策略验证完成', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 策略验证失败: ${error.message}</div>`;
                log(`策略验证失败: ${error.message}`, 'error');
            }
        }

        async function testDataOperations() {
            const resultDiv = document.getElementById('testResult');
            try {
                log('开始测试数据操作...');
                
                const testUserId = `user_${Date.now()}_test`;
                
                // 测试创建用户
                log('测试创建用户...');
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert({
                        id: testUserId,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (userError) {
                    throw new Error(`创建用户失败: ${userError.message}`);
                }
                
                log('用户创建成功', 'success');
                
                // 测试创建贴纸
                log('测试创建贴纸...');
                const testSticker = {
                    id: `sticker_${Date.now()}_test`,
                    user_id: testUserId,
                    word: 'test',
                    cn: '测试',
                    pos: 'noun',
                    image: 'test.png',
                    audio: JSON.stringify({ uk: 'test_uk.mp3', us: 'test_us.mp3' }),
                    examples: JSON.stringify([{ en: 'This is a test', cn: '这是一个测试' }]),
                    mnemonic: JSON.stringify(['test mnemonic']),
                    mastery_status: 'new',
                    tags: JSON.stringify(['test']),
                    related_words: JSON.stringify([]),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { data: stickerData, error: stickerError } = await supabase
                    .from('user_stickers')
                    .insert(testSticker)
                    .select();
                
                if (stickerError) {
                    throw new Error(`创建贴纸失败: ${stickerError.message}`);
                }
                
                log('贴纸创建成功', 'success');
                
                // 清理测试数据
                log('清理测试数据...');
                await supabase.from('user_stickers').delete().eq('user_id', testUserId);
                await supabase.from('users').delete().eq('id', testUserId);
                
                resultDiv.innerHTML = '<div class="success">✅ 数据操作测试成功！用户创建和贴纸写入都正常工作。</div>';
                log('数据操作测试完成，所有操作成功', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 数据操作测试失败: ${error.message}</div>`;
                log(`数据操作测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时的初始化
        window.onload = function() {
            log('RLS 策略修复工具已加载');
            log('请按顺序执行: 1.连接测试 → 2.执行修复 → 3.验证修复 → 4.测试操作');
        };
    </script>
</body>
</html>