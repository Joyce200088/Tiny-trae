<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼©ç•¥å›¾ RLS æƒé™ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .file-input {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .user-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .policy-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç¼©ç•¥å›¾ RLS æƒé™ä¿®å¤æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•å’Œä¿®å¤ä¸–ç•Œç¼©ç•¥å›¾ä¸Šä¼ çš„ RLS æƒé™é—®é¢˜</p>
        
        <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
        <div class="user-info">
            <strong>å½“å‰ç”¨æˆ·ID:</strong> <span id="currentUserId">åŠ è½½ä¸­...</span><br>
            <strong>è®¤è¯çŠ¶æ€:</strong> <span id="authStatus">æ£€æŸ¥ä¸­...</span><br>
            <strong>ç”¨æˆ·ä¸Šä¸‹æ–‡:</strong> <span id="userContext">æœªè®¾ç½®</span>
        </div>
    </div>

    <!-- 1. æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€ -->
    <div class="container">
        <div class="test-section">
            <h3>1. æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€</h3>
            <button onclick="checkBucketStatus()">æ£€æŸ¥ world-thumbnails å­˜å‚¨æ¡¶</button>
            <div id="bucketStatusResult" class="test-result"></div>
        </div>
    </div>

    <!-- 2. æ£€æŸ¥ RLS ç­–ç•¥ -->
    <div class="container">
        <div class="test-section">
            <h3>2. æ£€æŸ¥ RLS ç­–ç•¥</h3>
            <button onclick="checkRLSPolicies()">æ£€æŸ¥ç¼©ç•¥å›¾ç›¸å…³ç­–ç•¥</button>
            <div id="rlsPoliciesResult" class="test-result"></div>
        </div>
    </div>

    <!-- 3. è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡ -->
    <div class="container">
        <div class="test-section">
            <h3>3. è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡</h3>
            <button onclick="setUserContext()">è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡</button>
            <button onclick="clearUserContext()">æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–‡</button>
            <div id="userContextResult" class="test-result"></div>
        </div>
    </div>

    <!-- 4. æµ‹è¯•æ–‡ä»¶ä¸Šä¼  -->
    <div class="container">
        <div class="test-section">
            <h3>4. æµ‹è¯•ç¼©ç•¥å›¾ä¸Šä¼ </h3>
            <input type="file" id="thumbnailFile" accept="image/*" class="file-input">
            <br>
            <button onclick="testThumbnailUpload()">æµ‹è¯•ä¸Šä¼ ç¼©ç•¥å›¾</button>
            <button onclick="testDirectUpload()">æµ‹è¯•ç›´æ¥ä¸Šä¼ ï¼ˆç»•è¿‡ RLSï¼‰</button>
            <div id="uploadTestResult" class="test-result"></div>
        </div>
    </div>

    <!-- 5. æ‰§è¡Œ SQL ä¿®å¤ -->
    <div class="container">
        <div class="test-section">
            <h3>5. æ‰§è¡Œ RLS ç­–ç•¥ä¿®å¤</h3>
            <div class="policy-info">
                <strong>ä¿®å¤å†…å®¹ï¼š</strong><br>
                â€¢ åˆ é™¤ç°æœ‰çš„ä¸¥æ ¼ç­–ç•¥<br>
                â€¢ åˆ›å»ºæ›´å®½æ¾çš„ä¸´æ—¶ç­–ç•¥<br>
                â€¢ å…è®¸åŒ¿åç”¨æˆ·ä¸Šä¼ ï¼ˆä¸´æ—¶ï¼‰<br>
                â€¢ è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡å‡½æ•°
            </div>
            <button onclick="executeRLSFix()">æ‰§è¡Œ RLS ç­–ç•¥ä¿®å¤</button>
            <div id="rlsFixResult" class="test-result"></div>
        </div>
    </div>

    <!-- 6. å®Œæ•´æµ‹è¯•æµç¨‹ -->
    <div class="container">
        <div class="test-section">
            <h3>6. å®Œæ•´æµ‹è¯•æµç¨‹</h3>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="fullTestResult" class="test-result"></div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„æ¨¡å—
        import { supabase } from '/src/lib/supabase/client.js';
        import { UserDataManager } from '/src/lib/supabase/userClient.js';

        // å…¨å±€å˜é‡
        window.currentUserId = null;
        window.testResults = {};

        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            try {
                // è·å–å½“å‰ç”¨æˆ·ID
                const userId = await UserDataManager.getCurrentUserId();
                window.currentUserId = userId;
                document.getElementById('currentUserId').textContent = userId || 'æœªè®¾ç½®';

                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                const { data: { user } } = await supabase.auth.getUser();
                const authStatus = user ? `å·²è®¤è¯ (${user.id})` : 'æœªè®¤è¯ï¼ˆä½¿ç”¨ä¸´æ—¶ç”¨æˆ·IDï¼‰';
                document.getElementById('authStatus').textContent = authStatus;

                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ:', { userId, authStatus });
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showResult('currentUserId', 'åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-result ${type}`;
        }

        // 1. æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€
        window.checkBucketStatus = async function() {
            try {
                showResult('bucketStatusResult', 'æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€...', 'info');

                // æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦å­˜åœ¨
                const { data: buckets, error: bucketError } = await supabase
                    .storage
                    .listBuckets();

                if (bucketError) {
                    throw new Error(`è·å–å­˜å‚¨æ¡¶åˆ—è¡¨å¤±è´¥: ${bucketError.message}`);
                }

                const worldThumbnailsBucket = buckets.find(b => b.id === 'world-thumbnails');
                
                if (!worldThumbnailsBucket) {
                    showResult('bucketStatusResult', 'âŒ world-thumbnails å­˜å‚¨æ¡¶ä¸å­˜åœ¨', 'error');
                    return;
                }

                // æ£€æŸ¥å­˜å‚¨æ¡¶é…ç½®
                const bucketInfo = {
                    id: worldThumbnailsBucket.id,
                    name: worldThumbnailsBucket.name,
                    public: worldThumbnailsBucket.public,
                    file_size_limit: worldThumbnailsBucket.file_size_limit,
                    allowed_mime_types: worldThumbnailsBucket.allowed_mime_types
                };

                showResult('bucketStatusResult', 
                    `âœ… world-thumbnails å­˜å‚¨æ¡¶å­˜åœ¨\né…ç½®ä¿¡æ¯:\n${JSON.stringify(bucketInfo, null, 2)}`, 
                    'success'
                );

            } catch (error) {
                console.error('æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€å¤±è´¥:', error);
                showResult('bucketStatusResult', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // 2. æ£€æŸ¥ RLS ç­–ç•¥
        window.checkRLSPolicies = async function() {
            try {
                showResult('rlsPoliciesResult', 'æ£€æŸ¥ RLS ç­–ç•¥...', 'info');

                // æŸ¥è¯¢å­˜å‚¨å¯¹è±¡çš„ RLS ç­–ç•¥
                const { data, error } = await supabase
                    .rpc('sql', {
                        query: `
                            SELECT 
                                schemaname, 
                                tablename, 
                                policyname, 
                                permissive, 
                                roles, 
                                cmd, 
                                qual
                            FROM pg_policies 
                            WHERE tablename = 'objects' 
                              AND schemaname = 'storage'
                              AND (policyname LIKE '%world%thumbnail%' OR policyname LIKE '%world-thumbnails%')
                            ORDER BY policyname;
                        `
                    });

                if (error) {
                    throw new Error(`æŸ¥è¯¢ RLS ç­–ç•¥å¤±è´¥: ${error.message}`);
                }

                if (!data || data.length === 0) {
                    showResult('rlsPoliciesResult', 'âš ï¸ æœªæ‰¾åˆ°ä¸–ç•Œç¼©ç•¥å›¾ç›¸å…³çš„ RLS ç­–ç•¥', 'warning');
                    return;
                }

                const policyInfo = data.map(policy => 
                    `ç­–ç•¥å: ${policy.policyname}\nå‘½ä»¤: ${policy.cmd}\næ¡ä»¶: ${policy.qual || 'æ— '}`
                ).join('\n\n');

                showResult('rlsPoliciesResult', 
                    `âœ… æ‰¾åˆ° ${data.length} ä¸ªç›¸å…³ç­–ç•¥:\n\n${policyInfo}`, 
                    'success'
                );

            } catch (error) {
                console.error('æ£€æŸ¥ RLS ç­–ç•¥å¤±è´¥:', error);
                showResult('rlsPoliciesResult', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // 3. è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
        window.setUserContext = async function() {
            try {
                showResult('userContextResult', 'è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡...', 'info');

                const userId = window.currentUserId;
                if (!userId) {
                    throw new Error('ç”¨æˆ·IDæœªè®¾ç½®');
                }

                // è°ƒç”¨è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡çš„å‡½æ•°
                const { data, error } = await supabase
                    .rpc('set_user_context', { user_id: userId });

                if (error) {
                    throw new Error(`è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥: ${error.message}`);
                }

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('userContext').textContent = userId;
                showResult('userContextResult', `âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®æˆåŠŸ: ${userId}`, 'success');

            } catch (error) {
                console.error('è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                showResult('userContextResult', `âŒ è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–‡
        window.clearUserContext = async function() {
            try {
                const { data, error } = await supabase
                    .rpc('set_user_context', { user_id: '' });

                if (error) {
                    throw new Error(`æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥: ${error.message}`);
                }

                document.getElementById('userContext').textContent = 'æœªè®¾ç½®';
                showResult('userContextResult', 'âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡å·²æ¸…é™¤', 'success');

            } catch (error) {
                console.error('æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                showResult('userContextResult', `âŒ æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // 4. æµ‹è¯•ç¼©ç•¥å›¾ä¸Šä¼ 
        window.testThumbnailUpload = async function() {
            try {
                showResult('uploadTestResult', 'æµ‹è¯•ç¼©ç•¥å›¾ä¸Šä¼ ...', 'info');

                const fileInput = document.getElementById('thumbnailFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    throw new Error('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶');
                }

                const userId = window.currentUserId;
                if (!userId) {
                    throw new Error('ç”¨æˆ·IDæœªè®¾ç½®');
                }

                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = `${userId}/test-thumbnail-${Date.now()}.${file.name.split('.').pop()}`;

                // ä¸Šä¼ æ–‡ä»¶
                const { data, error } = await supabase.storage
                    .from('world-thumbnails')
                    .upload(fileName, file);

                if (error) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }

                // è·å–å…¬å…±URL
                const { data: urlData } = supabase.storage
                    .from('world-thumbnails')
                    .getPublicUrl(fileName);

                showResult('uploadTestResult', 
                    `âœ… ä¸Šä¼ æˆåŠŸ!\næ–‡ä»¶è·¯å¾„: ${data.path}\nå…¬å…±URL: ${urlData.publicUrl}`, 
                    'success'
                );

            } catch (error) {
                console.error('æµ‹è¯•ä¸Šä¼ å¤±è´¥:', error);
                showResult('uploadTestResult', `âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æµ‹è¯•ç›´æ¥ä¸Šä¼ ï¼ˆç»•è¿‡ RLSï¼‰
        window.testDirectUpload = async function() {
            try {
                showResult('uploadTestResult', 'æµ‹è¯•ç›´æ¥ä¸Šä¼ ...', 'info');

                const fileInput = document.getElementById('thumbnailFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    throw new Error('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶');
                }

                // ä½¿ç”¨åŒ¿åä¸Šä¼ 
                const fileName = `anonymous/test-${Date.now()}.${file.name.split('.').pop()}`;

                const { data, error } = await supabase.storage
                    .from('world-thumbnails')
                    .upload(fileName, file);

                if (error) {
                    throw new Error(`ç›´æ¥ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }

                showResult('uploadTestResult', 
                    `âœ… ç›´æ¥ä¸Šä¼ æˆåŠŸ!\næ–‡ä»¶è·¯å¾„: ${data.path}`, 
                    'success'
                );

            } catch (error) {
                console.error('ç›´æ¥ä¸Šä¼ å¤±è´¥:', error);
                showResult('uploadTestResult', `âŒ ç›´æ¥ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // 5. æ‰§è¡Œ RLS ä¿®å¤
        window.executeRLSFix = async function() {
            try {
                showResult('rlsFixResult', 'æ‰§è¡Œ RLS ç­–ç•¥ä¿®å¤...', 'info');

                // è¿™é‡Œåº”è¯¥æ‰§è¡Œ fix-thumbnail-rls-policy.sql ä¸­çš„å†…å®¹
                // ç”±äºå®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬åªèƒ½æç¤ºç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ
                const fixInstructions = `
è¯·åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶å¹¶æ‰§è¡Œ fix-thumbnail-rls-policy.sql æ–‡ä»¶ä¸­çš„å†…å®¹

æˆ–è€…ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å…³é”® SQLï¼š

-- åˆ é™¤ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS "Authenticated users can upload world thumbnails" ON storage.objects;

-- åˆ›å»ºå®½æ¾ç­–ç•¥
CREATE POLICY "Allow all authenticated users to upload world thumbnails" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'world-thumbnails' 
  AND (
    auth.role() = 'authenticated'
    OR auth.uid() IS NOT NULL
    OR current_setting('app.current_user_id', true) IS NOT NULL
  )
);

-- åˆ›å»ºåŒ¿åä¸Šä¼ ç­–ç•¥ï¼ˆä¸´æ—¶ï¼‰
CREATE POLICY "Allow anonymous uploads for world thumbnails" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'world-thumbnails');
                `;

                showResult('rlsFixResult', fixInstructions, 'warning');

            } catch (error) {
                console.error('RLS ä¿®å¤å¤±è´¥:', error);
                showResult('rlsFixResult', `âŒ ä¿®å¤å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // 6. è¿è¡Œå®Œæ•´æµ‹è¯•
        window.runFullTest = async function() {
            try {
                showResult('fullTestResult', 'å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...', 'info');

                let results = [];

                // 1. æ£€æŸ¥å­˜å‚¨æ¡¶
                results.push('1. æ£€æŸ¥å­˜å‚¨æ¡¶çŠ¶æ€...');
                await checkBucketStatus();
                
                // 2. æ£€æŸ¥ç­–ç•¥
                results.push('2. æ£€æŸ¥ RLS ç­–ç•¥...');
                await checkRLSPolicies();
                
                // 3. è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
                results.push('3. è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡...');
                await setUserContext();
                
                // 4. æµ‹è¯•ä¸Šä¼ 
                results.push('4. æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ...');
                // æ³¨æ„ï¼šè¿™éœ€è¦ç”¨æˆ·å…ˆé€‰æ‹©æ–‡ä»¶
                
                results.push('âœ… å®Œæ•´æµ‹è¯•æµç¨‹æ‰§è¡Œå®Œæˆï¼');
                results.push('è¯·æŸ¥çœ‹å„ä¸ªæµ‹è¯•éƒ¨åˆ†çš„è¯¦ç»†ç»“æœã€‚');
                
                showResult('fullTestResult', results.join('\n'), 'success');

            } catch (error) {
                console.error('å®Œæ•´æµ‹è¯•å¤±è´¥:', error);
                showResult('fullTestResult', `âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initializePage();
    </script>
</body>
</html>