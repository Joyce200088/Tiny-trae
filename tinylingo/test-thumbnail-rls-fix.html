<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>缩略图 RLS 权限修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .file-input {
            margin: 10px 0;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .user-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .policy-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 缩略图 RLS 权限修复测试</h1>
        <p>此页面用于测试和修复世界缩略图上传的 RLS 权限问题</p>
        
        <!-- 用户信息显示 -->
        <div class="user-info">
            <strong>当前用户ID:</strong> <span id="currentUserId">加载中...</span><br>
            <strong>认证状态:</strong> <span id="authStatus">检查中...</span><br>
            <strong>用户上下文:</strong> <span id="userContext">未设置</span>
        </div>
    </div>

    <!-- 1. 检查存储桶状态 -->
    <div class="container">
        <div class="test-section">
            <h3>1. 检查存储桶状态</h3>
            <button onclick="checkBucketStatus()">检查 world-thumbnails 存储桶</button>
            <div id="bucketStatusResult" class="test-result"></div>
        </div>
    </div>

    <!-- 2. 检查 RLS 策略 -->
    <div class="container">
        <div class="test-section">
            <h3>2. 检查 RLS 策略</h3>
            <button onclick="checkRLSPolicies()">检查缩略图相关策略</button>
            <div id="rlsPoliciesResult" class="test-result"></div>
        </div>
    </div>

    <!-- 3. 设置用户上下文 -->
    <div class="container">
        <div class="test-section">
            <h3>3. 设置用户上下文</h3>
            <button onclick="setUserContext()">设置当前用户上下文</button>
            <button onclick="clearUserContext()">清除用户上下文</button>
            <div id="userContextResult" class="test-result"></div>
        </div>
    </div>

    <!-- 4. 测试文件上传 -->
    <div class="container">
        <div class="test-section">
            <h3>4. 测试缩略图上传</h3>
            <input type="file" id="thumbnailFile" accept="image/*" class="file-input">
            <br>
            <button onclick="testThumbnailUpload()">测试上传缩略图</button>
            <button onclick="testDirectUpload()">测试直接上传（绕过 RLS）</button>
            <div id="uploadTestResult" class="test-result"></div>
        </div>
    </div>

    <!-- 5. 执行 SQL 修复 -->
    <div class="container">
        <div class="test-section">
            <h3>5. 执行 RLS 策略修复</h3>
            <div class="policy-info">
                <strong>修复内容：</strong><br>
                • 删除现有的严格策略<br>
                • 创建更宽松的临时策略<br>
                • 允许匿名用户上传（临时）<br>
                • 设置用户上下文函数
            </div>
            <button onclick="executeRLSFix()">执行 RLS 策略修复</button>
            <div id="rlsFixResult" class="test-result"></div>
        </div>
    </div>

    <!-- 6. 完整测试流程 -->
    <div class="container">
        <div class="test-section">
            <h3>6. 完整测试流程</h3>
            <button onclick="runFullTest()">运行完整测试</button>
            <div id="fullTestResult" class="test-result"></div>
        </div>
    </div>

    <script type="module">
        // 导入必要的模块
        import { supabase } from '/src/lib/supabase/client.js';
        import { UserDataManager } from '/src/lib/supabase/userClient.js';

        // 全局变量
        window.currentUserId = null;
        window.testResults = {};

        // 初始化页面
        async function initializePage() {
            try {
                // 获取当前用户ID
                const userId = await UserDataManager.getCurrentUserId();
                window.currentUserId = userId;
                document.getElementById('currentUserId').textContent = userId || '未设置';

                // 检查认证状态
                const { data: { user } } = await supabase.auth.getUser();
                const authStatus = user ? `已认证 (${user.id})` : '未认证（使用临时用户ID）';
                document.getElementById('authStatus').textContent = authStatus;

                console.log('页面初始化完成:', { userId, authStatus });
            } catch (error) {
                console.error('页面初始化失败:', error);
                showResult('currentUserId', '初始化失败: ' + error.message, 'error');
            }
        }

        // 显示结果
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-result ${type}`;
        }

        // 1. 检查存储桶状态
        window.checkBucketStatus = async function() {
            try {
                showResult('bucketStatusResult', '检查存储桶状态...', 'info');

                // 检查存储桶是否存在
                const { data: buckets, error: bucketError } = await supabase
                    .storage
                    .listBuckets();

                if (bucketError) {
                    throw new Error(`获取存储桶列表失败: ${bucketError.message}`);
                }

                const worldThumbnailsBucket = buckets.find(b => b.id === 'world-thumbnails');
                
                if (!worldThumbnailsBucket) {
                    showResult('bucketStatusResult', '❌ world-thumbnails 存储桶不存在', 'error');
                    return;
                }

                // 检查存储桶配置
                const bucketInfo = {
                    id: worldThumbnailsBucket.id,
                    name: worldThumbnailsBucket.name,
                    public: worldThumbnailsBucket.public,
                    file_size_limit: worldThumbnailsBucket.file_size_limit,
                    allowed_mime_types: worldThumbnailsBucket.allowed_mime_types
                };

                showResult('bucketStatusResult', 
                    `✅ world-thumbnails 存储桶存在\n配置信息:\n${JSON.stringify(bucketInfo, null, 2)}`, 
                    'success'
                );

            } catch (error) {
                console.error('检查存储桶状态失败:', error);
                showResult('bucketStatusResult', `❌ 检查失败: ${error.message}`, 'error');
            }
        };

        // 2. 检查 RLS 策略
        window.checkRLSPolicies = async function() {
            try {
                showResult('rlsPoliciesResult', '检查 RLS 策略...', 'info');

                // 查询存储对象的 RLS 策略
                const { data, error } = await supabase
                    .rpc('sql', {
                        query: `
                            SELECT 
                                schemaname, 
                                tablename, 
                                policyname, 
                                permissive, 
                                roles, 
                                cmd, 
                                qual
                            FROM pg_policies 
                            WHERE tablename = 'objects' 
                              AND schemaname = 'storage'
                              AND (policyname LIKE '%world%thumbnail%' OR policyname LIKE '%world-thumbnails%')
                            ORDER BY policyname;
                        `
                    });

                if (error) {
                    throw new Error(`查询 RLS 策略失败: ${error.message}`);
                }

                if (!data || data.length === 0) {
                    showResult('rlsPoliciesResult', '⚠️ 未找到世界缩略图相关的 RLS 策略', 'warning');
                    return;
                }

                const policyInfo = data.map(policy => 
                    `策略名: ${policy.policyname}\n命令: ${policy.cmd}\n条件: ${policy.qual || '无'}`
                ).join('\n\n');

                showResult('rlsPoliciesResult', 
                    `✅ 找到 ${data.length} 个相关策略:\n\n${policyInfo}`, 
                    'success'
                );

            } catch (error) {
                console.error('检查 RLS 策略失败:', error);
                showResult('rlsPoliciesResult', `❌ 检查失败: ${error.message}`, 'error');
            }
        };

        // 3. 设置用户上下文
        window.setUserContext = async function() {
            try {
                showResult('userContextResult', '设置用户上下文...', 'info');

                const userId = window.currentUserId;
                if (!userId) {
                    throw new Error('用户ID未设置');
                }

                // 调用设置用户上下文的函数
                const { data, error } = await supabase
                    .rpc('set_user_context', { user_id: userId });

                if (error) {
                    throw new Error(`设置用户上下文失败: ${error.message}`);
                }

                // 更新显示
                document.getElementById('userContext').textContent = userId;
                showResult('userContextResult', `✅ 用户上下文设置成功: ${userId}`, 'success');

            } catch (error) {
                console.error('设置用户上下文失败:', error);
                showResult('userContextResult', `❌ 设置失败: ${error.message}`, 'error');
            }
        };

        // 清除用户上下文
        window.clearUserContext = async function() {
            try {
                const { data, error } = await supabase
                    .rpc('set_user_context', { user_id: '' });

                if (error) {
                    throw new Error(`清除用户上下文失败: ${error.message}`);
                }

                document.getElementById('userContext').textContent = '未设置';
                showResult('userContextResult', '✅ 用户上下文已清除', 'success');

            } catch (error) {
                console.error('清除用户上下文失败:', error);
                showResult('userContextResult', `❌ 清除失败: ${error.message}`, 'error');
            }
        };

        // 4. 测试缩略图上传
        window.testThumbnailUpload = async function() {
            try {
                showResult('uploadTestResult', '测试缩略图上传...', 'info');

                const fileInput = document.getElementById('thumbnailFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    throw new Error('请先选择一个图片文件');
                }

                const userId = window.currentUserId;
                if (!userId) {
                    throw new Error('用户ID未设置');
                }

                // 生成文件名
                const fileName = `${userId}/test-thumbnail-${Date.now()}.${file.name.split('.').pop()}`;

                // 上传文件
                const { data, error } = await supabase.storage
                    .from('world-thumbnails')
                    .upload(fileName, file);

                if (error) {
                    throw new Error(`上传失败: ${error.message}`);
                }

                // 获取公共URL
                const { data: urlData } = supabase.storage
                    .from('world-thumbnails')
                    .getPublicUrl(fileName);

                showResult('uploadTestResult', 
                    `✅ 上传成功!\n文件路径: ${data.path}\n公共URL: ${urlData.publicUrl}`, 
                    'success'
                );

            } catch (error) {
                console.error('测试上传失败:', error);
                showResult('uploadTestResult', `❌ 上传失败: ${error.message}`, 'error');
            }
        };

        // 测试直接上传（绕过 RLS）
        window.testDirectUpload = async function() {
            try {
                showResult('uploadTestResult', '测试直接上传...', 'info');

                const fileInput = document.getElementById('thumbnailFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    throw new Error('请先选择一个图片文件');
                }

                // 使用匿名上传
                const fileName = `anonymous/test-${Date.now()}.${file.name.split('.').pop()}`;

                const { data, error } = await supabase.storage
                    .from('world-thumbnails')
                    .upload(fileName, file);

                if (error) {
                    throw new Error(`直接上传失败: ${error.message}`);
                }

                showResult('uploadTestResult', 
                    `✅ 直接上传成功!\n文件路径: ${data.path}`, 
                    'success'
                );

            } catch (error) {
                console.error('直接上传失败:', error);
                showResult('uploadTestResult', `❌ 直接上传失败: ${error.message}`, 'error');
            }
        };

        // 5. 执行 RLS 修复
        window.executeRLSFix = async function() {
            try {
                showResult('rlsFixResult', '执行 RLS 策略修复...', 'info');

                // 这里应该执行 fix-thumbnail-rls-policy.sql 中的内容
                // 由于安全限制，我们只能提示用户手动执行
                const fixInstructions = `
请在 Supabase SQL Editor 中执行以下步骤：

1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 复制并执行 fix-thumbnail-rls-policy.sql 文件中的内容

或者，您可以手动执行以下关键 SQL：

-- 删除现有策略
DROP POLICY IF EXISTS "Authenticated users can upload world thumbnails" ON storage.objects;

-- 创建宽松策略
CREATE POLICY "Allow all authenticated users to upload world thumbnails" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'world-thumbnails' 
  AND (
    auth.role() = 'authenticated'
    OR auth.uid() IS NOT NULL
    OR current_setting('app.current_user_id', true) IS NOT NULL
  )
);

-- 创建匿名上传策略（临时）
CREATE POLICY "Allow anonymous uploads for world thumbnails" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'world-thumbnails');
                `;

                showResult('rlsFixResult', fixInstructions, 'warning');

            } catch (error) {
                console.error('RLS 修复失败:', error);
                showResult('rlsFixResult', `❌ 修复失败: ${error.message}`, 'error');
            }
        };

        // 6. 运行完整测试
        window.runFullTest = async function() {
            try {
                showResult('fullTestResult', '开始完整测试流程...', 'info');

                let results = [];

                // 1. 检查存储桶
                results.push('1. 检查存储桶状态...');
                await checkBucketStatus();
                
                // 2. 检查策略
                results.push('2. 检查 RLS 策略...');
                await checkRLSPolicies();
                
                // 3. 设置用户上下文
                results.push('3. 设置用户上下文...');
                await setUserContext();
                
                // 4. 测试上传
                results.push('4. 测试文件上传...');
                // 注意：这需要用户先选择文件
                
                results.push('✅ 完整测试流程执行完成！');
                results.push('请查看各个测试部分的详细结果。');
                
                showResult('fullTestResult', results.join('\n'), 'success');

            } catch (error) {
                console.error('完整测试失败:', error);
                showResult('fullTestResult', `❌ 完整测试失败: ${error.message}`, 'error');
            }
        };

        // 页面加载时初始化
        initializePage();
    </script>
</body>
</html>