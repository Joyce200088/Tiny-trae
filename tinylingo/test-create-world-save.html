<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建世界保存功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #FFFBF5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .iframe-container {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>创建世界保存功能测试</h1>
        
        <div class="section">
            <h2>测试说明</h2>
            <p>这个页面用于测试创建世界页面的保存功能。请按照以下步骤操作：</p>
            <ol>
                <li>在下方的创建世界页面中添加一些内容（背景、贴纸等）</li>
                <li>点击保存按钮或等待自动保存</li>
                <li>查看浏览器控制台的调试日志</li>
                <li>检查localStorage中的数据</li>
            </ol>
        </div>

        <div class="section">
            <h2>控制面板</h2>
            <button class="button" onclick="openDevTools()">打开开发者工具</button>
            <button class="button" onclick="checkLocalStorage()">检查localStorage</button>
            <button class="button" onclick="clearLocalStorage()">清空localStorage</button>
            <button class="button" onclick="refreshIframe()">刷新页面</button>
        </div>

        <div class="section">
            <h2>localStorage 数据</h2>
            <div id="localStorageData" class="log">点击"检查localStorage"查看数据...</div>
        </div>

        <div class="section">
            <h2>创建世界页面</h2>
            <div class="iframe-container">
                <iframe id="createWorldFrame" src="http://localhost:3000/create-world"></iframe>
            </div>
        </div>

        <div class="section">
            <h2>操作日志</h2>
            <div id="operationLog" class="log">操作日志将在这里显示...</div>
        </div>
    </div>

    <script>
        // 日志函数
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('operationLog');
            const logMessage = `[${timestamp}] ${message}`;
            
            if (data) {
                logElement.textContent += logMessage + '\n' + JSON.stringify(data, null, 2) + '\n\n';
            } else {
                logElement.textContent += logMessage + '\n';
            }
            
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logMessage, data);
        }

        // 打开开发者工具
        function openDevTools() {
            log('💡 请按 F12 或右键选择"检查"来打开开发者工具');
            log('💡 在控制台中查看以 🔄、📊、🖼️、✅、❌ 等emoji开头的调试日志');
        }

        // 检查localStorage
        function checkLocalStorage() {
            log('🔍 检查localStorage数据...');
            
            const localStorageElement = document.getElementById('localStorageData');
            let output = '';
            
            // 查找所有tinylingo相关的键
            const keys = Object.keys(localStorage).filter(key => key.includes('tinylingo'));
            
            if (keys.length === 0) {
                output = '没有找到tinylingo相关的数据';
                log('📭 localStorage中没有tinylingo数据');
            } else {
                keys.forEach(key => {
                    try {
                        const value = localStorage.getItem(key);
                        const parsedValue = JSON.parse(value);
                        output += `${key}:\n${JSON.stringify(parsedValue, null, 2)}\n\n`;
                        
                        if (key.includes('worlds')) {
                            log(`📚 找到世界数据: ${key}, 包含 ${parsedValue.length} 个世界`);
                        } else {
                            log(`📄 找到数据: ${key}`);
                        }
                    } catch (error) {
                        output += `${key}: ${value}\n\n`;
                        log(`⚠️ 数据解析失败: ${key}`);
                    }
                });
            }
            
            localStorageElement.textContent = output;
        }

        // 清空localStorage
        function clearLocalStorage() {
            const keys = Object.keys(localStorage).filter(key => key.includes('tinylingo'));
            keys.forEach(key => localStorage.removeItem(key));
            
            log(`🗑️ 已清空 ${keys.length} 个tinylingo相关的localStorage项`);
            checkLocalStorage();
        }

        // 刷新iframe
        function refreshIframe() {
            const iframe = document.getElementById('createWorldFrame');
            iframe.src = iframe.src;
            log('🔄 已刷新创建世界页面');
        }

        // 监听localStorage变化
        window.addEventListener('storage', (e) => {
            if (e.key && e.key.includes('tinylingo')) {
                log('📡 检测到localStorage变化:', e.key);
                checkLocalStorage();
            }
        });

        // 监听iframe中的消息
        window.addEventListener('message', (event) => {
            if (event.origin === 'http://localhost:3000') {
                log('📨 收到iframe消息:', event.data);
            }
        });

        // 页面加载时检查状态
        window.addEventListener('load', () => {
            log('📱 测试页面已加载');
            checkLocalStorage();
            
            // 定期检查localStorage变化
            setInterval(() => {
                const keys = Object.keys(localStorage).filter(key => key.includes('tinylingo'));
                if (keys.length > 0) {
                    // 静默检查，不显示日志
                    const localStorageElement = document.getElementById('localStorageData');
                    let output = '';
                    keys.forEach(key => {
                        try {
                            const value = localStorage.getItem(key);
                            const parsedValue = JSON.parse(value);
                            output += `${key}:\n${JSON.stringify(parsedValue, null, 2)}\n\n`;
                        } catch (error) {
                            output += `${key}: ${value}\n\n`;
                        }
                    });
                    localStorageElement.textContent = output;
                }
            }, 2000); // 每2秒检查一次
        });

        // 添加一些有用的调试函数到全局作用域
        window.debugTinyLingo = {
            checkStorage: checkLocalStorage,
            clearStorage: clearLocalStorage,
            log: log
        };

        log('🚀 创建世界保存功能测试页面已初始化');
        log('💡 提示：打开开发者工具查看详细的保存过程日志');
    </script>
</body>
</html>