<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直接修复 RLS 策略</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .sql-code {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007cba;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>直接修复 RLS 策略</h1>
        <p>由于 Supabase 客户端无法直接执行 DDL 语句，我们需要通过 Supabase 管理界面手动执行 SQL。</p>

        <div class="warning">
            <strong>⚠️ 重要提示：</strong>
            <p>请按照以下步骤在 Supabase 管理界面中执行 SQL 语句：</p>
            <ol>
                <li>打开 <a href="https://knizbnlzwcuniceqvmvd.supabase.co" target="_blank">Supabase 项目管理界面</a></li>
                <li>进入 "SQL Editor" 页面</li>
                <li>复制下面的 SQL 代码并执行</li>
            </ol>
        </div>

        <div class="section">
            <h3>1. 要执行的 SQL 代码</h3>
            <div class="sql-code">
                <pre id="sqlCode">-- 修复 RLS 策略的 SQL 脚本
-- 请在 Supabase SQL Editor 中执行

-- 1. 删除现有的严格策略
DROP POLICY IF EXISTS "Users can manage own stickers" ON user_stickers;
DROP POLICY IF EXISTS "Users can manage own worlds" ON user_worlds;
DROP POLICY IF EXISTS "Users can manage own backgrounds" ON user_backgrounds;
DROP POLICY IF EXISTS "Users can manage own sync status" ON user_sync_status;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_stickers;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_worlds;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_backgrounds;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_sync_status;
DROP POLICY IF EXISTS "Users can insert their own data" ON users;
DROP POLICY IF EXISTS "Users can read their own data" ON users;
DROP POLICY IF EXISTS "Users can update their own data" ON users;

-- 2. 创建宽松的新策略（允许匿名用户操作）
CREATE POLICY "Allow anonymous user operations" ON users
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous sticker operations" ON user_stickers
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous world operations" ON user_worlds
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous background operations" ON user_backgrounds
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous sync operations" ON user_sync_status
    FOR ALL USING (true)
    WITH CHECK (true);

-- 3. 验证策略创建结果
SELECT schemaname, tablename, policyname, permissive, roles, cmd
FROM pg_policies 
WHERE tablename IN ('users', 'user_stickers', 'user_worlds', 'user_backgrounds', 'user_sync_status')
ORDER BY tablename, policyname;</pre>
            </div>
            <button onclick="copySQLCode()">📋 复制 SQL 代码</button>
        </div>

        <div class="section">
            <h3>2. 测试数据操作（修复后执行）</h3>
            <button onclick="testDataOperations()">测试用户和贴纸操作</button>
            <div id="testResult"></div>
        </div>

        <div class="section">
            <h3>3. 测试贴纸同步功能</h3>
            <button onclick="testStickerSync()">测试完整的贴纸同步</button>
            <div id="syncResult"></div>
        </div>

        <div class="section">
            <h3>操作日志</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function copySQLCode() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                log('SQL 代码已复制到剪贴板', 'success');
                alert('SQL 代码已复制到剪贴板！\n\n请：\n1. 打开 Supabase 管理界面\n2. 进入 SQL Editor\n3. 粘贴并执行代码');
            }).catch(err => {
                log('复制失败: ' + err.message, 'error');
            });
        }

        // 生成符合 UUID 格式的用户 ID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function testDataOperations() {
            const resultDiv = document.getElementById('testResult');
            try {
                log('开始测试数据操作...');
                
                const testUserId = generateUUID(); // 使用 UUID 格式
                
                // 测试创建用户
                log('测试创建用户...');
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert({
                        id: testUserId,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (userError) {
                    throw new Error(`创建用户失败: ${userError.message}`);
                }
                
                log('用户创建成功', 'success');
                
                // 测试创建贴纸
                log('测试创建贴纸...');
                const testSticker = {
                    id: generateUUID(), // 使用 UUID 格式
                    user_id: testUserId,
                    word: 'test',
                    cn: '测试',
                    pos: 'noun',
                    image: 'test.png',
                    audio: JSON.stringify({ uk: 'test_uk.mp3', us: 'test_us.mp3' }),
                    examples: JSON.stringify([{ en: 'This is a test', cn: '这是一个测试' }]),
                    mnemonic: JSON.stringify(['test mnemonic']),
                    mastery_status: 'new',
                    tags: JSON.stringify(['test']),
                    related_words: JSON.stringify([]),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { data: stickerData, error: stickerError } = await supabase
                    .from('user_stickers')
                    .insert(testSticker)
                    .select();
                
                if (stickerError) {
                    throw new Error(`创建贴纸失败: ${stickerError.message}`);
                }
                
                log('贴纸创建成功', 'success');
                
                // 测试同步状态
                log('测试同步状态...');
                const { data: syncData, error: syncError } = await supabase
                    .from('user_sync_status')
                    .insert({
                        id: generateUUID(),
                        user_id: testUserId,
                        data_type: 'stickers',
                        last_sync_at: new Date().toISOString(),
                        sync_version: 1,
                        is_syncing: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (syncError) {
                    throw new Error(`创建同步状态失败: ${syncError.message}`);
                }
                
                log('同步状态创建成功', 'success');
                
                // 清理测试数据
                log('清理测试数据...');
                await supabase.from('user_sync_status').delete().eq('user_id', testUserId);
                await supabase.from('user_stickers').delete().eq('user_id', testUserId);
                await supabase.from('users').delete().eq('id', testUserId);
                
                resultDiv.innerHTML = '<div class="success">✅ 数据操作测试成功！用户创建、贴纸写入和同步状态都正常工作。</div>';
                log('数据操作测试完成，所有操作成功', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 数据操作测试失败: ${error.message}</div>`;
                log(`数据操作测试失败: ${error.message}`, 'error');
            }
        }

        async function testStickerSync() {
            const resultDiv = document.getElementById('syncResult');
            try {
                log('开始测试完整的贴纸同步功能...');
                
                const testUserId = generateUUID();
                
                // 1. 创建用户
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert({
                        id: testUserId,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (userError) {
                    throw new Error(`创建用户失败: ${userError.message}`);
                }
                
                // 2. 模拟完整的贴纸数据结构
                const completeSticker = {
                    id: generateUUID(),
                    user_id: testUserId,
                    word: 'apple',
                    cn: '苹果',
                    pos: 'noun',
                    image: 'apple.png',
                    audio: JSON.stringify({ 
                        uk: 'apple_uk.mp3', 
                        us: 'apple_us.mp3' 
                    }),
                    examples: JSON.stringify([
                        { en: 'I eat an apple every day', cn: '我每天吃一个苹果' },
                        { en: 'The apple is red and sweet', cn: '这个苹果又红又甜' }
                    ]),
                    mnemonic: JSON.stringify(['Apple starts with A, like Amazing fruit']),
                    mastery_status: 'new',
                    tags: JSON.stringify(['fruit', 'food']),
                    related_words: JSON.stringify([
                        { word: 'eat', pos: 'verb' },
                        { word: 'bite', pos: 'verb' },
                        { word: 'pick', pos: 'verb' },
                        { word: 'fruit', pos: 'noun' },
                        { word: 'red', pos: 'adj' },
                        { word: 'sweet', pos: 'adj' },
                        { word: 'fresh', pos: 'adj' },
                        { word: 'tree', pos: 'noun' },
                        { word: 'juice', pos: 'noun' },
                        { word: 'healthy', pos: 'adj' }
                    ]),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // 3. 插入贴纸数据
                const { data: stickerData, error: stickerError } = await supabase
                    .from('user_stickers')
                    .insert(completeSticker)
                    .select();
                
                if (stickerError) {
                    throw new Error(`插入贴纸失败: ${stickerError.message}`);
                }
                
                // 4. 更新同步状态
                const { data: syncData, error: syncError } = await supabase
                    .from('user_sync_status')
                    .upsert({
                        user_id: testUserId,
                        data_type: 'stickers',
                        last_sync_at: new Date().toISOString(),
                        sync_version: 1,
                        is_syncing: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (syncError) {
                    throw new Error(`更新同步状态失败: ${syncError.message}`);
                }
                
                // 5. 验证数据完整性
                const { data: retrievedSticker, error: retrieveError } = await supabase
                    .from('user_stickers')
                    .select('*')
                    .eq('user_id', testUserId)
                    .single();
                
                if (retrieveError) {
                    throw new Error(`检索贴纸失败: ${retrieveError.message}`);
                }
                
                // 验证数据结构
                const audioData = JSON.parse(retrievedSticker.audio);
                const examplesData = JSON.parse(retrievedSticker.examples);
                const mnemonicData = JSON.parse(retrievedSticker.mnemonic);
                const tagsData = JSON.parse(retrievedSticker.tags);
                const relatedWordsData = JSON.parse(retrievedSticker.related_words);
                
                log('贴纸数据验证成功:', 'success');
                log(`- 单词: ${retrievedSticker.word}`, 'info');
                log(`- 中文: ${retrievedSticker.cn}`, 'info');
                log(`- 词性: ${retrievedSticker.pos}`, 'info');
                log(`- 音频: ${audioData.uk}, ${audioData.us}`, 'info');
                log(`- 例句数量: ${examplesData.length}`, 'info');
                log(`- 标签数量: ${tagsData.length}`, 'info');
                log(`- 相关词数量: ${relatedWordsData.length}`, 'info');
                
                // 清理测试数据
                await supabase.from('user_sync_status').delete().eq('user_id', testUserId);
                await supabase.from('user_stickers').delete().eq('user_id', testUserId);
                await supabase.from('users').delete().eq('id', testUserId);
                
                resultDiv.innerHTML = '<div class="success">✅ 完整的贴纸同步测试成功！数据结构完整，同步功能正常。</div>';
                log('完整的贴纸同步测试成功', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 贴纸同步测试失败: ${error.message}</div>`;
                log(`贴纸同步测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时的初始化
        window.onload = function() {
            log('RLS 策略直接修复工具已加载');
            log('请先在 Supabase 管理界面执行 SQL 代码，然后测试功能');
        };
    </script>
</body>
</html>