<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ¥ä¿®å¤ RLS ç­–ç•¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .sql-code {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007cba;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç›´æ¥ä¿®å¤ RLS ç­–ç•¥</h1>
        <p>ç”±äº Supabase å®¢æˆ·ç«¯æ— æ³•ç›´æ¥æ‰§è¡Œ DDL è¯­å¥ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ Supabase ç®¡ç†ç•Œé¢æ‰‹åŠ¨æ‰§è¡Œ SQLã€‚</p>

        <div class="warning">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
            <p>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åœ¨ Supabase ç®¡ç†ç•Œé¢ä¸­æ‰§è¡Œ SQL è¯­å¥ï¼š</p>
            <ol>
                <li>æ‰“å¼€ <a href="https://knizbnlzwcuniceqvmvd.supabase.co" target="_blank">Supabase é¡¹ç›®ç®¡ç†ç•Œé¢</a></li>
                <li>è¿›å…¥ "SQL Editor" é¡µé¢</li>
                <li>å¤åˆ¶ä¸‹é¢çš„ SQL ä»£ç å¹¶æ‰§è¡Œ</li>
            </ol>
        </div>

        <div class="section">
            <h3>1. è¦æ‰§è¡Œçš„ SQL ä»£ç </h3>
            <div class="sql-code">
                <pre id="sqlCode">-- ä¿®å¤ RLS ç­–ç•¥çš„ SQL è„šæœ¬
-- è¯·åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ

-- 1. åˆ é™¤ç°æœ‰çš„ä¸¥æ ¼ç­–ç•¥
DROP POLICY IF EXISTS "Users can manage own stickers" ON user_stickers;
DROP POLICY IF EXISTS "Users can manage own worlds" ON user_worlds;
DROP POLICY IF EXISTS "Users can manage own backgrounds" ON user_backgrounds;
DROP POLICY IF EXISTS "Users can manage own sync status" ON user_sync_status;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_stickers;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_worlds;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_backgrounds;
DROP POLICY IF EXISTS "Allow all operations for authenticated users" ON user_sync_status;
DROP POLICY IF EXISTS "Users can insert their own data" ON users;
DROP POLICY IF EXISTS "Users can read their own data" ON users;
DROP POLICY IF EXISTS "Users can update their own data" ON users;

-- 2. åˆ›å»ºå®½æ¾çš„æ–°ç­–ç•¥ï¼ˆå…è®¸åŒ¿åç”¨æˆ·æ“ä½œï¼‰
CREATE POLICY "Allow anonymous user operations" ON users
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous sticker operations" ON user_stickers
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous world operations" ON user_worlds
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous background operations" ON user_backgrounds
    FOR ALL USING (true)
    WITH CHECK (true);

CREATE POLICY "Allow anonymous sync operations" ON user_sync_status
    FOR ALL USING (true)
    WITH CHECK (true);

-- 3. éªŒè¯ç­–ç•¥åˆ›å»ºç»“æœ
SELECT schemaname, tablename, policyname, permissive, roles, cmd
FROM pg_policies 
WHERE tablename IN ('users', 'user_stickers', 'user_worlds', 'user_backgrounds', 'user_sync_status')
ORDER BY tablename, policyname;</pre>
            </div>
            <button onclick="copySQLCode()">ğŸ“‹ å¤åˆ¶ SQL ä»£ç </button>
        </div>

        <div class="section">
            <h3>2. æµ‹è¯•æ•°æ®æ“ä½œï¼ˆä¿®å¤åæ‰§è¡Œï¼‰</h3>
            <button onclick="testDataOperations()">æµ‹è¯•ç”¨æˆ·å’Œè´´çº¸æ“ä½œ</button>
            <div id="testResult"></div>
        </div>

        <div class="section">
            <h3>3. æµ‹è¯•è´´çº¸åŒæ­¥åŠŸèƒ½</h3>
            <button onclick="testStickerSync()">æµ‹è¯•å®Œæ•´çš„è´´çº¸åŒæ­¥</button>
            <div id="syncResult"></div>
        </div>

        <div class="section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function copySQLCode() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                log('SQL ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                alert('SQL ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·ï¼š\n1. æ‰“å¼€ Supabase ç®¡ç†ç•Œé¢\n2. è¿›å…¥ SQL Editor\n3. ç²˜è´´å¹¶æ‰§è¡Œä»£ç ');
            }).catch(err => {
                log('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
            });
        }

        // ç”Ÿæˆç¬¦åˆ UUID æ ¼å¼çš„ç”¨æˆ· ID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function testDataOperations() {
            const resultDiv = document.getElementById('testResult');
            try {
                log('å¼€å§‹æµ‹è¯•æ•°æ®æ“ä½œ...');
                
                const testUserId = generateUUID(); // ä½¿ç”¨ UUID æ ¼å¼
                
                // æµ‹è¯•åˆ›å»ºç”¨æˆ·
                log('æµ‹è¯•åˆ›å»ºç”¨æˆ·...');
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert({
                        id: testUserId,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (userError) {
                    throw new Error(`åˆ›å»ºç”¨æˆ·å¤±è´¥: ${userError.message}`);
                }
                
                log('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•åˆ›å»ºè´´çº¸
                log('æµ‹è¯•åˆ›å»ºè´´çº¸...');
                const testSticker = {
                    id: generateUUID(), // ä½¿ç”¨ UUID æ ¼å¼
                    user_id: testUserId,
                    word: 'test',
                    cn: 'æµ‹è¯•',
                    pos: 'noun',
                    image: 'test.png',
                    audio: JSON.stringify({ uk: 'test_uk.mp3', us: 'test_us.mp3' }),
                    examples: JSON.stringify([{ en: 'This is a test', cn: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•' }]),
                    mnemonic: JSON.stringify(['test mnemonic']),
                    mastery_status: 'new',
                    tags: JSON.stringify(['test']),
                    related_words: JSON.stringify([]),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { data: stickerData, error: stickerError } = await supabase
                    .from('user_stickers')
                    .insert(testSticker)
                    .select();
                
                if (stickerError) {
                    throw new Error(`åˆ›å»ºè´´çº¸å¤±è´¥: ${stickerError.message}`);
                }
                
                log('è´´çº¸åˆ›å»ºæˆåŠŸ', 'success');
                
                // æµ‹è¯•åŒæ­¥çŠ¶æ€
                log('æµ‹è¯•åŒæ­¥çŠ¶æ€...');
                const { data: syncData, error: syncError } = await supabase
                    .from('user_sync_status')
                    .insert({
                        id: generateUUID(),
                        user_id: testUserId,
                        data_type: 'stickers',
                        last_sync_at: new Date().toISOString(),
                        sync_version: 1,
                        is_syncing: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (syncError) {
                    throw new Error(`åˆ›å»ºåŒæ­¥çŠ¶æ€å¤±è´¥: ${syncError.message}`);
                }
                
                log('åŒæ­¥çŠ¶æ€åˆ›å»ºæˆåŠŸ', 'success');
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                log('æ¸…ç†æµ‹è¯•æ•°æ®...');
                await supabase.from('user_sync_status').delete().eq('user_id', testUserId);
                await supabase.from('user_stickers').delete().eq('user_id', testUserId);
                await supabase.from('users').delete().eq('id', testUserId);
                
                resultDiv.innerHTML = '<div class="success">âœ… æ•°æ®æ“ä½œæµ‹è¯•æˆåŠŸï¼ç”¨æˆ·åˆ›å»ºã€è´´çº¸å†™å…¥å’ŒåŒæ­¥çŠ¶æ€éƒ½æ­£å¸¸å·¥ä½œã€‚</div>';
                log('æ•°æ®æ“ä½œæµ‹è¯•å®Œæˆï¼Œæ‰€æœ‰æ“ä½œæˆåŠŸ', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ æ•°æ®æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                log(`æ•°æ®æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testStickerSync() {
            const resultDiv = document.getElementById('syncResult');
            try {
                log('å¼€å§‹æµ‹è¯•å®Œæ•´çš„è´´çº¸åŒæ­¥åŠŸèƒ½...');
                
                const testUserId = generateUUID();
                
                // 1. åˆ›å»ºç”¨æˆ·
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .insert({
                        id: testUserId,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (userError) {
                    throw new Error(`åˆ›å»ºç”¨æˆ·å¤±è´¥: ${userError.message}`);
                }
                
                // 2. æ¨¡æ‹Ÿå®Œæ•´çš„è´´çº¸æ•°æ®ç»“æ„
                const completeSticker = {
                    id: generateUUID(),
                    user_id: testUserId,
                    word: 'apple',
                    cn: 'è‹¹æœ',
                    pos: 'noun',
                    image: 'apple.png',
                    audio: JSON.stringify({ 
                        uk: 'apple_uk.mp3', 
                        us: 'apple_us.mp3' 
                    }),
                    examples: JSON.stringify([
                        { en: 'I eat an apple every day', cn: 'æˆ‘æ¯å¤©åƒä¸€ä¸ªè‹¹æœ' },
                        { en: 'The apple is red and sweet', cn: 'è¿™ä¸ªè‹¹æœåˆçº¢åˆç”œ' }
                    ]),
                    mnemonic: JSON.stringify(['Apple starts with A, like Amazing fruit']),
                    mastery_status: 'new',
                    tags: JSON.stringify(['fruit', 'food']),
                    related_words: JSON.stringify([
                        { word: 'eat', pos: 'verb' },
                        { word: 'bite', pos: 'verb' },
                        { word: 'pick', pos: 'verb' },
                        { word: 'fruit', pos: 'noun' },
                        { word: 'red', pos: 'adj' },
                        { word: 'sweet', pos: 'adj' },
                        { word: 'fresh', pos: 'adj' },
                        { word: 'tree', pos: 'noun' },
                        { word: 'juice', pos: 'noun' },
                        { word: 'healthy', pos: 'adj' }
                    ]),
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // 3. æ’å…¥è´´çº¸æ•°æ®
                const { data: stickerData, error: stickerError } = await supabase
                    .from('user_stickers')
                    .insert(completeSticker)
                    .select();
                
                if (stickerError) {
                    throw new Error(`æ’å…¥è´´çº¸å¤±è´¥: ${stickerError.message}`);
                }
                
                // 4. æ›´æ–°åŒæ­¥çŠ¶æ€
                const { data: syncData, error: syncError } = await supabase
                    .from('user_sync_status')
                    .upsert({
                        user_id: testUserId,
                        data_type: 'stickers',
                        last_sync_at: new Date().toISOString(),
                        sync_version: 1,
                        is_syncing: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select();
                
                if (syncError) {
                    throw new Error(`æ›´æ–°åŒæ­¥çŠ¶æ€å¤±è´¥: ${syncError.message}`);
                }
                
                // 5. éªŒè¯æ•°æ®å®Œæ•´æ€§
                const { data: retrievedSticker, error: retrieveError } = await supabase
                    .from('user_stickers')
                    .select('*')
                    .eq('user_id', testUserId)
                    .single();
                
                if (retrieveError) {
                    throw new Error(`æ£€ç´¢è´´çº¸å¤±è´¥: ${retrieveError.message}`);
                }
                
                // éªŒè¯æ•°æ®ç»“æ„
                const audioData = JSON.parse(retrievedSticker.audio);
                const examplesData = JSON.parse(retrievedSticker.examples);
                const mnemonicData = JSON.parse(retrievedSticker.mnemonic);
                const tagsData = JSON.parse(retrievedSticker.tags);
                const relatedWordsData = JSON.parse(retrievedSticker.related_words);
                
                log('è´´çº¸æ•°æ®éªŒè¯æˆåŠŸ:', 'success');
                log(`- å•è¯: ${retrievedSticker.word}`, 'info');
                log(`- ä¸­æ–‡: ${retrievedSticker.cn}`, 'info');
                log(`- è¯æ€§: ${retrievedSticker.pos}`, 'info');
                log(`- éŸ³é¢‘: ${audioData.uk}, ${audioData.us}`, 'info');
                log(`- ä¾‹å¥æ•°é‡: ${examplesData.length}`, 'info');
                log(`- æ ‡ç­¾æ•°é‡: ${tagsData.length}`, 'info');
                log(`- ç›¸å…³è¯æ•°é‡: ${relatedWordsData.length}`, 'info');
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                await supabase.from('user_sync_status').delete().eq('user_id', testUserId);
                await supabase.from('user_stickers').delete().eq('user_id', testUserId);
                await supabase.from('users').delete().eq('id', testUserId);
                
                resultDiv.innerHTML = '<div class="success">âœ… å®Œæ•´çš„è´´çº¸åŒæ­¥æµ‹è¯•æˆåŠŸï¼æ•°æ®ç»“æ„å®Œæ•´ï¼ŒåŒæ­¥åŠŸèƒ½æ­£å¸¸ã€‚</div>';
                log('å®Œæ•´çš„è´´çº¸åŒæ­¥æµ‹è¯•æˆåŠŸ', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è´´çº¸åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                log(`è´´çº¸åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('RLS ç­–ç•¥ç›´æ¥ä¿®å¤å·¥å…·å·²åŠ è½½');
            log('è¯·å…ˆåœ¨ Supabase ç®¡ç†ç•Œé¢æ‰§è¡Œ SQL ä»£ç ï¼Œç„¶åæµ‹è¯•åŠŸèƒ½');
        };
    </script>
</body>
</html>