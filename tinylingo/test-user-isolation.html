<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç”¨æˆ·æ•°æ®éš”ç¦»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .user-section {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .user-1 { border-color: #3b82f6; }
        .user-2 { border-color: #ef4444; }
        .user-3 { border-color: #10b981; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .user-2 button {
            background: #ef4444;
        }
        .user-2 button:hover {
            background: #dc2626;
        }
        .user-3 button {
            background: #10b981;
        }
        .user-3 button:hover {
            background: #059669;
        }
        
        .world-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            min-height: 100px;
        }
        .world-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #3b82f6;
        }
        .storage-info {
            background: #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .test-results {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            color: #059669;
            font-weight: bold;
        }
        .error {
            color: #dc2626;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¤šç”¨æˆ·æ•°æ®éš”ç¦»æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„ç”¨æˆ·æ•°æ®éš”ç¦»åŠŸèƒ½ã€‚æ¯ä¸ªç”¨æˆ·çš„ä¸–ç•Œæ•°æ®åº”è¯¥å®Œå…¨ç‹¬ç«‹å­˜å‚¨ã€‚</p>
        
        <div class="test-results" id="testResults">
            <h3>æµ‹è¯•ç»“æœ</h3>
            <div id="testOutput">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <div class="container">
        <h2>æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ</h2>
        
        <!-- ç”¨æˆ·1 -->
        <div class="user-section user-1">
            <h3>ğŸ‘¤ ç”¨æˆ·1 (user-123)</h3>
            <button onclick="switchUser('user-123')">åˆ‡æ¢åˆ°ç”¨æˆ·1</button>
            <button onclick="addTestWorld('user-123', 'ç”¨æˆ·1çš„å¨æˆ¿ä¸–ç•Œ', 'kitchen')">æ·»åŠ å¨æˆ¿ä¸–ç•Œ</button>
            <button onclick="addTestWorld('user-123', 'ç”¨æˆ·1çš„åŠå…¬å®¤ä¸–ç•Œ', 'office')">æ·»åŠ åŠå…¬å®¤ä¸–ç•Œ</button>
            <button onclick="loadUserWorlds('user-123')">åŠ è½½ä¸–ç•Œåˆ—è¡¨</button>
            <button onclick="clearUserData('user-123')">æ¸…ç©ºæ•°æ®</button>
            
            <div class="world-list" id="user1-worlds">
                <em>æš‚æ— ä¸–ç•Œæ•°æ®</em>
            </div>
            
            <div class="storage-info" id="user1-storage">
                localStorage é”®: æš‚æ— 
            </div>
        </div>

        <!-- ç”¨æˆ·2 -->
        <div class="user-section user-2">
            <h3>ğŸ‘¤ ç”¨æˆ·2 (user-456)</h3>
            <button onclick="switchUser('user-456')">åˆ‡æ¢åˆ°ç”¨æˆ·2</button>
            <button onclick="addTestWorld('user-456', 'ç”¨æˆ·2çš„èŠ±å›­ä¸–ç•Œ', 'garden')">æ·»åŠ èŠ±å›­ä¸–ç•Œ</button>
            <button onclick="addTestWorld('user-456', 'ç”¨æˆ·2çš„å›¾ä¹¦é¦†ä¸–ç•Œ', 'library')">æ·»åŠ å›¾ä¹¦é¦†ä¸–ç•Œ</button>
            <button onclick="loadUserWorlds('user-456')">åŠ è½½ä¸–ç•Œåˆ—è¡¨</button>
            <button onclick="clearUserData('user-456')">æ¸…ç©ºæ•°æ®</button>
            
            <div class="world-list" id="user2-worlds">
                <em>æš‚æ— ä¸–ç•Œæ•°æ®</em>
            </div>
            
            <div class="storage-info" id="user2-storage">
                localStorage é”®: æš‚æ— 
            </div>
        </div>

        <!-- ç”¨æˆ·3 (æ¸¸å®¢) -->
        <div class="user-section user-3">
            <h3>ğŸ‘¤ ç”¨æˆ·3 (æ¸¸å®¢æ¨¡å¼)</h3>
            <button onclick="switchUser(null)">åˆ‡æ¢åˆ°æ¸¸å®¢</button>
            <button onclick="addTestWorld(null, 'æ¸¸å®¢çš„æµ‹è¯•ä¸–ç•Œ', 'test')">æ·»åŠ æµ‹è¯•ä¸–ç•Œ</button>
            <button onclick="addTestWorld(null, 'æ¸¸å®¢çš„å­¦ä¹ ä¸–ç•Œ', 'study')">æ·»åŠ å­¦ä¹ ä¸–ç•Œ</button>
            <button onclick="loadUserWorlds(null)">åŠ è½½ä¸–ç•Œåˆ—è¡¨</button>
            <button onclick="clearUserData(null)">æ¸…ç©ºæ•°æ®</button>
            
            <div class="world-list" id="user3-worlds">
                <em>æš‚æ— ä¸–ç•Œæ•°æ®</em>
            </div>
            
            <div class="storage-info" id="user3-storage">
                localStorage é”®: æš‚æ— 
            </div>
        </div>
    </div>

    <div class="container">
        <h2>è‡ªåŠ¨åŒ–æµ‹è¯•</h2>
        <button onclick="runFullTest()" style="background: #7c3aed; font-size: 16px; padding: 12px 24px;">
            ğŸ§ª è¿è¡Œå®Œæ•´éš”ç¦»æµ‹è¯•
        </button>
        <button onclick="showAllStorageKeys()" style="background: #059669;">
            ğŸ“‹ æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨é”®
        </button>
        <button onclick="clearAllData()" style="background: #dc2626;">
            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
        </button>
    </div>

    <script>
        // æ¨¡æ‹Ÿ UserDataManager çš„å½“å‰ç”¨æˆ·ID
        let currentUserId = null;
        
        // æ¨¡æ‹Ÿ UserDataManager
        const MockUserDataManager = {
            getCurrentUserId: () => currentUserId,
            syncWorldsToSupabase: async () => {
                console.log('æ¨¡æ‹ŸåŒæ­¥åˆ°Supabase...');
                return true;
            }
        };

        // æ¨¡æ‹Ÿ WorldDataUtils çš„æ ¸å¿ƒé€»è¾‘
        const MockWorldDataUtils = {
            STORAGE_KEY_PREFIX: 'tinylingo_worlds_',
            
            async getUserStorageKey() {
                const userId = MockUserDataManager.getCurrentUserId();
                return this.STORAGE_KEY_PREFIX + (userId || 'guest');
            },
            
            async loadWorldData() {
                const key = await this.getUserStorageKey();
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            },
            
            async saveWorldData(worlds) {
                const key = await this.getUserStorageKey();
                localStorage.setItem(key, JSON.stringify(worlds));
                // è§¦å‘å­˜å‚¨äº‹ä»¶
                window.dispatchEvent(new StorageEvent('storage', {
                    key: key,
                    newValue: JSON.stringify(worlds),
                    oldValue: localStorage.getItem(key)
                }));
            },
            
            async getAllWorlds() {
                return await this.loadWorldData();
            },
            
            async addWorld(world) {
                const worlds = await this.loadWorldData();
                const existingIndex = worlds.findIndex(w => w.id === world.id);
                
                if (existingIndex >= 0) {
                    worlds[existingIndex] = world;
                } else {
                    worlds.push(world);
                }
                
                await this.saveWorldData(worlds);
                
                try {
                    await MockUserDataManager.syncWorldsToSupabase();
                } catch (error) {
                    console.warn('åŒæ­¥åˆ°Supabaseå¤±è´¥:', error);
                }
            }
        };

        // åˆ‡æ¢ç”¨æˆ·
        function switchUser(userId) {
            currentUserId = userId;
            updateTestResults(`åˆ‡æ¢åˆ°ç”¨æˆ·: ${userId || 'æ¸¸å®¢'}`);
            
            // æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„æ˜¾ç¤º
            loadUserWorlds('user-123');
            loadUserWorlds('user-456');
            loadUserWorlds(null);
        }

        // æ·»åŠ æµ‹è¯•ä¸–ç•Œ
        async function addTestWorld(userId, worldName, theme) {
            const originalUserId = currentUserId;
            currentUserId = userId;
            
            const world = {
                id: `world-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name: worldName,
                theme: theme,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                canvasObjects: [],
                canvasData: null,
                selectedBackground: null,
                isPublic: false
            };
            
            try {
                await MockWorldDataUtils.addWorld(world);
                updateTestResults(`âœ… æˆåŠŸä¸ºç”¨æˆ· ${userId || 'æ¸¸å®¢'} æ·»åŠ ä¸–ç•Œ: ${worldName}`);
                await loadUserWorlds(userId);
            } catch (error) {
                updateTestResults(`âŒ æ·»åŠ ä¸–ç•Œå¤±è´¥: ${error.message}`);
            }
            
            currentUserId = originalUserId;
        }

        // åŠ è½½ç”¨æˆ·ä¸–ç•Œåˆ—è¡¨
        async function loadUserWorlds(userId) {
            const originalUserId = currentUserId;
            currentUserId = userId;
            
            try {
                const worlds = await MockWorldDataUtils.getAllWorlds();
                const storageKey = await MockWorldDataUtils.getUserStorageKey();
                
                // æ›´æ–°æ˜¾ç¤º
                const userNum = userId === 'user-123' ? '1' : userId === 'user-456' ? '2' : '3';
                const worldsContainer = document.getElementById(`user${userNum}-worlds`);
                const storageContainer = document.getElementById(`user${userNum}-storage`);
                
                if (worlds.length === 0) {
                    worldsContainer.innerHTML = '<em>æš‚æ— ä¸–ç•Œæ•°æ®</em>';
                } else {
                    worldsContainer.innerHTML = worlds.map(world => 
                        `<div class="world-item">
                            <strong>${world.name}</strong> (${world.theme})
                            <br><small>ID: ${world.id}</small>
                        </div>`
                    ).join('');
                }
                
                storageContainer.innerHTML = `localStorage é”®: ${storageKey}<br>ä¸–ç•Œæ•°é‡: ${worlds.length}`;
                
            } catch (error) {
                updateTestResults(`âŒ åŠ è½½ç”¨æˆ· ${userId || 'æ¸¸å®¢'} çš„ä¸–ç•Œå¤±è´¥: ${error.message}`);
            }
            
            currentUserId = originalUserId;
        }

        // æ¸…ç©ºç”¨æˆ·æ•°æ®
        async function clearUserData(userId) {
            const originalUserId = currentUserId;
            currentUserId = userId;
            
            try {
                const storageKey = await MockWorldDataUtils.getUserStorageKey();
                localStorage.removeItem(storageKey);
                await loadUserWorlds(userId);
                updateTestResults(`âœ… æ¸…ç©ºç”¨æˆ· ${userId || 'æ¸¸å®¢'} çš„æ•°æ®`);
            } catch (error) {
                updateTestResults(`âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`);
            }
            
            currentUserId = originalUserId;
        }

        // æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨é”®
        function showAllStorageKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tinylingo_worlds_')) {
                    const data = localStorage.getItem(key);
                    const worlds = JSON.parse(data);
                    keys.push(`${key}: ${worlds.length} ä¸ªä¸–ç•Œ`);
                }
            }
            
            if (keys.length === 0) {
                updateTestResults('ğŸ“‹ å½“å‰æ²¡æœ‰ä»»ä½•ä¸–ç•Œæ•°æ®å­˜å‚¨é”®');
            } else {
                updateTestResults('ğŸ“‹ å½“å‰å­˜å‚¨é”®:\n' + keys.join('\n'));
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            const keys = [];
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('tinylingo_worlds_')) {
                    keys.push(key);
                    localStorage.removeItem(key);
                }
            }
            
            // åˆ·æ–°æ˜¾ç¤º
            loadUserWorlds('user-123');
            loadUserWorlds('user-456');
            loadUserWorlds(null);
            
            updateTestResults(`ğŸ—‘ï¸ æ¸…ç©ºäº† ${keys.length} ä¸ªå­˜å‚¨é”®: ${keys.join(', ')}`);
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            updateTestResults('ğŸ§ª å¼€å§‹è¿è¡Œå®Œæ•´éš”ç¦»æµ‹è¯•...\n');
            
            try {
                // 1. æ¸…ç©ºæ‰€æœ‰æ•°æ®
                clearAllData();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // 2. ä¸ºæ¯ä¸ªç”¨æˆ·æ·»åŠ æ•°æ®
                await addTestWorld('user-123', 'ç”¨æˆ·1æµ‹è¯•ä¸–ç•ŒA', 'test-a');
                await addTestWorld('user-123', 'ç”¨æˆ·1æµ‹è¯•ä¸–ç•ŒB', 'test-b');
                
                await addTestWorld('user-456', 'ç”¨æˆ·2æµ‹è¯•ä¸–ç•ŒA', 'test-a');
                await addTestWorld('user-456', 'ç”¨æˆ·2æµ‹è¯•ä¸–ç•ŒB', 'test-b');
                
                await addTestWorld(null, 'æ¸¸å®¢æµ‹è¯•ä¸–ç•ŒA', 'test-a');
                await addTestWorld(null, 'æ¸¸å®¢æµ‹è¯•ä¸–ç•ŒB', 'test-b');
                
                // 3. éªŒè¯æ•°æ®éš”ç¦»
                currentUserId = 'user-123';
                const user1Worlds = await MockWorldDataUtils.getAllWorlds();
                
                currentUserId = 'user-456';
                const user2Worlds = await MockWorldDataUtils.getAllWorlds();
                
                currentUserId = null;
                const guestWorlds = await MockWorldDataUtils.getAllWorlds();
                
                // 4. æ£€æŸ¥ç»“æœ
                let testPassed = true;
                let results = [];
                
                if (user1Worlds.length !== 2) {
                    testPassed = false;
                    results.push(`âŒ ç”¨æˆ·1åº”è¯¥æœ‰2ä¸ªä¸–ç•Œï¼Œå®é™…æœ‰${user1Worlds.length}ä¸ª`);
                } else {
                    results.push(`âœ… ç”¨æˆ·1æ­£ç¡®æ‹¥æœ‰2ä¸ªä¸–ç•Œ`);
                }
                
                if (user2Worlds.length !== 2) {
                    testPassed = false;
                    results.push(`âŒ ç”¨æˆ·2åº”è¯¥æœ‰2ä¸ªä¸–ç•Œï¼Œå®é™…æœ‰${user2Worlds.length}ä¸ª`);
                } else {
                    results.push(`âœ… ç”¨æˆ·2æ­£ç¡®æ‹¥æœ‰2ä¸ªä¸–ç•Œ`);
                }
                
                if (guestWorlds.length !== 2) {
                    testPassed = false;
                    results.push(`âŒ æ¸¸å®¢åº”è¯¥æœ‰2ä¸ªä¸–ç•Œï¼Œå®é™…æœ‰${guestWorlds.length}ä¸ª`);
                } else {
                    results.push(`âœ… æ¸¸å®¢æ­£ç¡®æ‹¥æœ‰2ä¸ªä¸–ç•Œ`);
                }
                
                // 5. æ£€æŸ¥ä¸–ç•Œåç§°æ˜¯å¦æ­£ç¡®éš”ç¦»
                const user1Names = user1Worlds.map(w => w.name);
                const user2Names = user2Worlds.map(w => w.name);
                const guestNames = guestWorlds.map(w => w.name);
                
                if (user1Names.some(name => name.includes('ç”¨æˆ·2') || name.includes('æ¸¸å®¢'))) {
                    testPassed = false;
                    results.push(`âŒ ç”¨æˆ·1çš„ä¸–ç•Œä¸­åŒ…å«å…¶ä»–ç”¨æˆ·çš„æ•°æ®`);
                } else {
                    results.push(`âœ… ç”¨æˆ·1çš„ä¸–ç•Œæ•°æ®æ­£ç¡®éš”ç¦»`);
                }
                
                if (user2Names.some(name => name.includes('ç”¨æˆ·1') || name.includes('æ¸¸å®¢'))) {
                    testPassed = false;
                    results.push(`âŒ ç”¨æˆ·2çš„ä¸–ç•Œä¸­åŒ…å«å…¶ä»–ç”¨æˆ·çš„æ•°æ®`);
                } else {
                    results.push(`âœ… ç”¨æˆ·2çš„ä¸–ç•Œæ•°æ®æ­£ç¡®éš”ç¦»`);
                }
                
                if (guestNames.some(name => name.includes('ç”¨æˆ·1') || name.includes('ç”¨æˆ·2'))) {
                    testPassed = false;
                    results.push(`âŒ æ¸¸å®¢çš„ä¸–ç•Œä¸­åŒ…å«å…¶ä»–ç”¨æˆ·çš„æ•°æ®`);
                } else {
                    results.push(`âœ… æ¸¸å®¢çš„ä¸–ç•Œæ•°æ®æ­£ç¡®éš”ç¦»`);
                }
                
                // 6. æ£€æŸ¥å­˜å‚¨é”®
                const storageKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('tinylingo_worlds_')) {
                        storageKeys.push(key);
                    }
                }
                
                const expectedKeys = ['tinylingo_worlds_user-123', 'tinylingo_worlds_user-456', 'tinylingo_worlds_guest'];
                if (storageKeys.length !== 3 || !expectedKeys.every(key => storageKeys.includes(key))) {
                    testPassed = false;
                    results.push(`âŒ å­˜å‚¨é”®ä¸æ­£ç¡®ã€‚æœŸæœ›: ${expectedKeys.join(', ')}ï¼Œå®é™…: ${storageKeys.join(', ')}`);
                } else {
                    results.push(`âœ… å­˜å‚¨é”®æ­£ç¡®: ${storageKeys.join(', ')}`);
                }
                
                // 7. è¾“å‡ºæœ€ç»ˆç»“æœ
                const finalResult = testPassed ? 
                    'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¤šç”¨æˆ·æ•°æ®éš”ç¦»åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚' : 
                    'âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ã€‚';
                
                updateTestResults(results.join('\n') + '\n\n' + finalResult);
                
                // åˆ·æ–°æ˜¾ç¤º
                await loadUserWorlds('user-123');
                await loadUserWorlds('user-456');
                await loadUserWorlds(null);
                
            } catch (error) {
                updateTestResults(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
        }

        // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
        function updateTestResults(message) {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${timestamp}] ${message.replace(/\n/g, '<br>')}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            updateTestResults('ğŸ“‹ å¤šç”¨æˆ·æ•°æ®éš”ç¦»æµ‹è¯•é¡µé¢å·²åŠ è½½');
            updateTestResults('ğŸ’¡ è¯·ç‚¹å‡»"è¿è¡Œå®Œæ•´éš”ç¦»æµ‹è¯•"æŒ‰é’®å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•');
        });
    </script>
</body>
</html>