<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多用户数据隔离测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .user-section {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .user-1 { border-color: #3b82f6; }
        .user-2 { border-color: #ef4444; }
        .user-3 { border-color: #10b981; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .user-2 button {
            background: #ef4444;
        }
        .user-2 button:hover {
            background: #dc2626;
        }
        .user-3 button {
            background: #10b981;
        }
        .user-3 button:hover {
            background: #059669;
        }
        
        .world-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            min-height: 100px;
        }
        .world-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #3b82f6;
        }
        .storage-info {
            background: #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .test-results {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            color: #059669;
            font-weight: bold;
        }
        .error {
            color: #dc2626;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>多用户数据隔离测试</h1>
        <p>此页面用于测试修复后的用户数据隔离功能。每个用户的世界数据应该完全独立存储。</p>
        
        <div class="test-results" id="testResults">
            <h3>测试结果</h3>
            <div id="testOutput">等待测试...</div>
        </div>
    </div>

    <div class="container">
        <h2>模拟用户操作</h2>
        
        <!-- 用户1 -->
        <div class="user-section user-1">
            <h3>👤 用户1 (user-123)</h3>
            <button onclick="switchUser('user-123')">切换到用户1</button>
            <button onclick="addTestWorld('user-123', '用户1的厨房世界', 'kitchen')">添加厨房世界</button>
            <button onclick="addTestWorld('user-123', '用户1的办公室世界', 'office')">添加办公室世界</button>
            <button onclick="loadUserWorlds('user-123')">加载世界列表</button>
            <button onclick="clearUserData('user-123')">清空数据</button>
            
            <div class="world-list" id="user1-worlds">
                <em>暂无世界数据</em>
            </div>
            
            <div class="storage-info" id="user1-storage">
                localStorage 键: 暂无
            </div>
        </div>

        <!-- 用户2 -->
        <div class="user-section user-2">
            <h3>👤 用户2 (user-456)</h3>
            <button onclick="switchUser('user-456')">切换到用户2</button>
            <button onclick="addTestWorld('user-456', '用户2的花园世界', 'garden')">添加花园世界</button>
            <button onclick="addTestWorld('user-456', '用户2的图书馆世界', 'library')">添加图书馆世界</button>
            <button onclick="loadUserWorlds('user-456')">加载世界列表</button>
            <button onclick="clearUserData('user-456')">清空数据</button>
            
            <div class="world-list" id="user2-worlds">
                <em>暂无世界数据</em>
            </div>
            
            <div class="storage-info" id="user2-storage">
                localStorage 键: 暂无
            </div>
        </div>

        <!-- 用户3 (游客) -->
        <div class="user-section user-3">
            <h3>👤 用户3 (游客模式)</h3>
            <button onclick="switchUser(null)">切换到游客</button>
            <button onclick="addTestWorld(null, '游客的测试世界', 'test')">添加测试世界</button>
            <button onclick="addTestWorld(null, '游客的学习世界', 'study')">添加学习世界</button>
            <button onclick="loadUserWorlds(null)">加载世界列表</button>
            <button onclick="clearUserData(null)">清空数据</button>
            
            <div class="world-list" id="user3-worlds">
                <em>暂无世界数据</em>
            </div>
            
            <div class="storage-info" id="user3-storage">
                localStorage 键: 暂无
            </div>
        </div>
    </div>

    <div class="container">
        <h2>自动化测试</h2>
        <button onclick="runFullTest()" style="background: #7c3aed; font-size: 16px; padding: 12px 24px;">
            🧪 运行完整隔离测试
        </button>
        <button onclick="showAllStorageKeys()" style="background: #059669;">
            📋 显示所有存储键
        </button>
        <button onclick="clearAllData()" style="background: #dc2626;">
            🗑️ 清空所有数据
        </button>
    </div>

    <script>
        // 模拟 UserDataManager 的当前用户ID
        let currentUserId = null;
        
        // 模拟 UserDataManager
        const MockUserDataManager = {
            getCurrentUserId: () => currentUserId,
            syncWorldsToSupabase: async () => {
                console.log('模拟同步到Supabase...');
                return true;
            }
        };

        // 模拟 WorldDataUtils 的核心逻辑
        const MockWorldDataUtils = {
            STORAGE_KEY_PREFIX: 'tinylingo_worlds_',
            
            async getUserStorageKey() {
                const userId = MockUserDataManager.getCurrentUserId();
                return this.STORAGE_KEY_PREFIX + (userId || 'guest');
            },
            
            async loadWorldData() {
                const key = await this.getUserStorageKey();
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            },
            
            async saveWorldData(worlds) {
                const key = await this.getUserStorageKey();
                localStorage.setItem(key, JSON.stringify(worlds));
                // 触发存储事件
                window.dispatchEvent(new StorageEvent('storage', {
                    key: key,
                    newValue: JSON.stringify(worlds),
                    oldValue: localStorage.getItem(key)
                }));
            },
            
            async getAllWorlds() {
                return await this.loadWorldData();
            },
            
            async addWorld(world) {
                const worlds = await this.loadWorldData();
                const existingIndex = worlds.findIndex(w => w.id === world.id);
                
                if (existingIndex >= 0) {
                    worlds[existingIndex] = world;
                } else {
                    worlds.push(world);
                }
                
                await this.saveWorldData(worlds);
                
                try {
                    await MockUserDataManager.syncWorldsToSupabase();
                } catch (error) {
                    console.warn('同步到Supabase失败:', error);
                }
            }
        };

        // 切换用户
        function switchUser(userId) {
            currentUserId = userId;
            updateTestResults(`切换到用户: ${userId || '游客'}`);
            
            // 更新所有用户的显示
            loadUserWorlds('user-123');
            loadUserWorlds('user-456');
            loadUserWorlds(null);
        }

        // 添加测试世界
        async function addTestWorld(userId, worldName, theme) {
            const originalUserId = currentUserId;
            currentUserId = userId;
            
            const world = {
                id: `world-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name: worldName,
                theme: theme,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                canvasObjects: [],
                canvasData: null,
                selectedBackground: null,
                isPublic: false
            };
            
            try {
                await MockWorldDataUtils.addWorld(world);
                updateTestResults(`✅ 成功为用户 ${userId || '游客'} 添加世界: ${worldName}`);
                await loadUserWorlds(userId);
            } catch (error) {
                updateTestResults(`❌ 添加世界失败: ${error.message}`);
            }
            
            currentUserId = originalUserId;
        }

        // 加载用户世界列表
        async function loadUserWorlds(userId) {
            const originalUserId = currentUserId;
            currentUserId = userId;
            
            try {
                const worlds = await MockWorldDataUtils.getAllWorlds();
                const storageKey = await MockWorldDataUtils.getUserStorageKey();
                
                // 更新显示
                const userNum = userId === 'user-123' ? '1' : userId === 'user-456' ? '2' : '3';
                const worldsContainer = document.getElementById(`user${userNum}-worlds`);
                const storageContainer = document.getElementById(`user${userNum}-storage`);
                
                if (worlds.length === 0) {
                    worldsContainer.innerHTML = '<em>暂无世界数据</em>';
                } else {
                    worldsContainer.innerHTML = worlds.map(world => 
                        `<div class="world-item">
                            <strong>${world.name}</strong> (${world.theme})
                            <br><small>ID: ${world.id}</small>
                        </div>`
                    ).join('');
                }
                
                storageContainer.innerHTML = `localStorage 键: ${storageKey}<br>世界数量: ${worlds.length}`;
                
            } catch (error) {
                updateTestResults(`❌ 加载用户 ${userId || '游客'} 的世界失败: ${error.message}`);
            }
            
            currentUserId = originalUserId;
        }

        // 清空用户数据
        async function clearUserData(userId) {
            const originalUserId = currentUserId;
            currentUserId = userId;
            
            try {
                const storageKey = await MockWorldDataUtils.getUserStorageKey();
                localStorage.removeItem(storageKey);
                await loadUserWorlds(userId);
                updateTestResults(`✅ 清空用户 ${userId || '游客'} 的数据`);
            } catch (error) {
                updateTestResults(`❌ 清空数据失败: ${error.message}`);
            }
            
            currentUserId = originalUserId;
        }

        // 显示所有存储键
        function showAllStorageKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tinylingo_worlds_')) {
                    const data = localStorage.getItem(key);
                    const worlds = JSON.parse(data);
                    keys.push(`${key}: ${worlds.length} 个世界`);
                }
            }
            
            if (keys.length === 0) {
                updateTestResults('📋 当前没有任何世界数据存储键');
            } else {
                updateTestResults('📋 当前存储键:\n' + keys.join('\n'));
            }
        }

        // 清空所有数据
        function clearAllData() {
            const keys = [];
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('tinylingo_worlds_')) {
                    keys.push(key);
                    localStorage.removeItem(key);
                }
            }
            
            // 刷新显示
            loadUserWorlds('user-123');
            loadUserWorlds('user-456');
            loadUserWorlds(null);
            
            updateTestResults(`🗑️ 清空了 ${keys.length} 个存储键: ${keys.join(', ')}`);
        }

        // 运行完整测试
        async function runFullTest() {
            updateTestResults('🧪 开始运行完整隔离测试...\n');
            
            try {
                // 1. 清空所有数据
                clearAllData();
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // 2. 为每个用户添加数据
                await addTestWorld('user-123', '用户1测试世界A', 'test-a');
                await addTestWorld('user-123', '用户1测试世界B', 'test-b');
                
                await addTestWorld('user-456', '用户2测试世界A', 'test-a');
                await addTestWorld('user-456', '用户2测试世界B', 'test-b');
                
                await addTestWorld(null, '游客测试世界A', 'test-a');
                await addTestWorld(null, '游客测试世界B', 'test-b');
                
                // 3. 验证数据隔离
                currentUserId = 'user-123';
                const user1Worlds = await MockWorldDataUtils.getAllWorlds();
                
                currentUserId = 'user-456';
                const user2Worlds = await MockWorldDataUtils.getAllWorlds();
                
                currentUserId = null;
                const guestWorlds = await MockWorldDataUtils.getAllWorlds();
                
                // 4. 检查结果
                let testPassed = true;
                let results = [];
                
                if (user1Worlds.length !== 2) {
                    testPassed = false;
                    results.push(`❌ 用户1应该有2个世界，实际有${user1Worlds.length}个`);
                } else {
                    results.push(`✅ 用户1正确拥有2个世界`);
                }
                
                if (user2Worlds.length !== 2) {
                    testPassed = false;
                    results.push(`❌ 用户2应该有2个世界，实际有${user2Worlds.length}个`);
                } else {
                    results.push(`✅ 用户2正确拥有2个世界`);
                }
                
                if (guestWorlds.length !== 2) {
                    testPassed = false;
                    results.push(`❌ 游客应该有2个世界，实际有${guestWorlds.length}个`);
                } else {
                    results.push(`✅ 游客正确拥有2个世界`);
                }
                
                // 5. 检查世界名称是否正确隔离
                const user1Names = user1Worlds.map(w => w.name);
                const user2Names = user2Worlds.map(w => w.name);
                const guestNames = guestWorlds.map(w => w.name);
                
                if (user1Names.some(name => name.includes('用户2') || name.includes('游客'))) {
                    testPassed = false;
                    results.push(`❌ 用户1的世界中包含其他用户的数据`);
                } else {
                    results.push(`✅ 用户1的世界数据正确隔离`);
                }
                
                if (user2Names.some(name => name.includes('用户1') || name.includes('游客'))) {
                    testPassed = false;
                    results.push(`❌ 用户2的世界中包含其他用户的数据`);
                } else {
                    results.push(`✅ 用户2的世界数据正确隔离`);
                }
                
                if (guestNames.some(name => name.includes('用户1') || name.includes('用户2'))) {
                    testPassed = false;
                    results.push(`❌ 游客的世界中包含其他用户的数据`);
                } else {
                    results.push(`✅ 游客的世界数据正确隔离`);
                }
                
                // 6. 检查存储键
                const storageKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('tinylingo_worlds_')) {
                        storageKeys.push(key);
                    }
                }
                
                const expectedKeys = ['tinylingo_worlds_user-123', 'tinylingo_worlds_user-456', 'tinylingo_worlds_guest'];
                if (storageKeys.length !== 3 || !expectedKeys.every(key => storageKeys.includes(key))) {
                    testPassed = false;
                    results.push(`❌ 存储键不正确。期望: ${expectedKeys.join(', ')}，实际: ${storageKeys.join(', ')}`);
                } else {
                    results.push(`✅ 存储键正确: ${storageKeys.join(', ')}`);
                }
                
                // 7. 输出最终结果
                const finalResult = testPassed ? 
                    '🎉 所有测试通过！多用户数据隔离功能正常工作。' : 
                    '⚠️ 部分测试失败，需要进一步检查。';
                
                updateTestResults(results.join('\n') + '\n\n' + finalResult);
                
                // 刷新显示
                await loadUserWorlds('user-123');
                await loadUserWorlds('user-456');
                await loadUserWorlds(null);
                
            } catch (error) {
                updateTestResults(`❌ 测试过程中发生错误: ${error.message}`);
            }
        }

        // 更新测试结果显示
        function updateTestResults(message) {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${timestamp}] ${message.replace(/\n/g, '<br>')}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // 页面加载时初始化
        window.addEventListener('load', () => {
            updateTestResults('📋 多用户数据隔离测试页面已加载');
            updateTestResults('💡 请点击"运行完整隔离测试"按钮开始自动化测试');
        });
    </script>
</body>
</html>