<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage集成测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #FFFBF5;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        img {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Supabase Storage 集成测试</h1>
    
    <div class="test-section">
        <h2>1. 工具类导入测试</h2>
        <button onclick="testImports()">测试导入</button>
        <div id="import-results"></div>
    </div>

    <div class="test-section">
        <h2>2. 图片上传测试</h2>
        <input type="file" id="imageInput" accept="image/*" />
        <button onclick="testImageUpload()">测试上传</button>
        <div id="upload-results"></div>
        <div id="uploaded-images"></div>
    </div>

    <div class="test-section">
        <h2>3. 贴纸数据处理测试</h2>
        <button onclick="testStickerProcessing()">测试贴纸处理</button>
        <div id="sticker-results"></div>
    </div>

    <div class="test-section">
        <h2>4. 世界数据处理测试</h2>
        <button onclick="testWorldProcessing()">测试世界处理</button>
        <div id="world-results"></div>
    </div>

    <script type="module">
        // 测试工具类导入
        window.testImports = async function() {
            const resultsDiv = document.getElementById('import-results');
            resultsDiv.innerHTML = '<div class="info">正在测试导入...</div>';
            
            try {
                // 测试StorageUtils导入
                const { StorageUtils } = await import('./src/utils/storageUtils.js');
                const { ImageUtils } = await import('./src/utils/imageUtils.js');
                const { StickerDataUtils } = await import('./src/utils/stickerDataUtils.js');
                const { WorldDataUtils } = await import('./src/utils/worldDataUtils.js');
                
                resultsDiv.innerHTML = `
                    <div class="success">✓ StorageUtils 导入成功</div>
                    <div class="success">✓ ImageUtils 导入成功</div>
                    <div class="success">✓ StickerDataUtils 导入成功</div>
                    <div class="success">✓ WorldDataUtils 导入成功</div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">导入失败: ${error.message}</div>`;
            }
        };

        // 测试图片上传
        window.testImageUpload = async function() {
            const fileInput = document.getElementById('imageInput');
            const resultsDiv = document.getElementById('upload-results');
            const imagesDiv = document.getElementById('uploaded-images');
            
            if (!fileInput.files[0]) {
                resultsDiv.innerHTML = '<div class="error">请先选择一个图片文件</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="info">正在上传图片...</div>';
            
            try {
                const file = fileInput.files[0];
                const { ImageUtils } = await import('./src/utils/imageUtils.js');
                
                // 创建Blob URL
                const blobUrl = URL.createObjectURL(file);
                
                // 测试上传到Storage
                const storageUrl = await ImageUtils.uploadBlobUrlToStorage(
                    blobUrl, 
                    'test-images', 
                    `test-${Date.now()}.${file.name.split('.').pop()}`
                );
                
                resultsDiv.innerHTML = `
                    <div class="success">✓ 图片上传成功</div>
                    <div class="info">Storage URL: ${storageUrl}</div>
                `;
                
                // 显示上传的图片
                imagesDiv.innerHTML = `
                    <h4>上传的图片:</h4>
                    <img src="${storageUrl}" alt="上传的图片" />
                `;
                
                // 清理Blob URL
                URL.revokeObjectURL(blobUrl);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">上传失败: ${error.message}</div>`;
            }
        };

        // 测试贴纸数据处理
        window.testStickerProcessing = async function() {
            const resultsDiv = document.getElementById('sticker-results');
            resultsDiv.innerHTML = '<div class="info">正在测试贴纸处理...</div>';
            
            try {
                const { StickerDataUtils } = await import('./src/utils/stickerDataUtils.js');
                
                // 创建测试贴纸数据
                const testSticker = {
                    id: `test-${Date.now()}`,
                    word: 'test',
                    cn: '测试',
                    pos: 'noun',
                    imageUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                    thumbnailUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                    audio: { uk: '', us: '' },
                    examples: [{ en: 'This is a test', cn: '这是一个测试' }],
                    mnemonic: ['测试记忆法'],
                    masteryStatus: 'new',
                    tags: ['test'],
                    relatedWords: []
                };
                
                // 测试处理贴纸图片
                const processedSticker = await StickerDataUtils.processStickerImages(testSticker);
                
                const hasStorageUrl = processedSticker.imageUrl.includes('supabase') || 
                                    processedSticker.imageUrl.startsWith('http');
                
                if (hasStorageUrl) {
                    resultsDiv.innerHTML = `
                        <div class="success">✓ 贴纸图片处理成功</div>
                        <div class="info">图片URL: ${processedSticker.imageUrl}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="info">贴纸图片使用fallback (Base64)</div>
                        <div class="info">这可能是因为Supabase连接问题</div>
                    `;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">贴纸处理失败: ${error.message}</div>`;
            }
        };

        // 测试世界数据处理
        window.testWorldProcessing = async function() {
            const resultsDiv = document.getElementById('world-results');
            resultsDiv.innerHTML = '<div class="info">正在测试世界处理...</div>';
            
            try {
                const { WorldDataUtils } = await import('./src/utils/worldDataUtils.js');
                
                // 创建测试世界数据
                const testWorld = {
                    id: `test-world-${Date.now()}`,
                    name: '测试世界',
                    description: '这是一个测试世界',
                    thumbnail: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                    coverUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                    previewImage: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                    wordCount: 0,
                    stickerCount: 0,
                    likes: 0,
                    favorites: 0,
                    isPublic: false,
                    canvasObjects: [],
                    canvasData: { objects: [], background: null },
                    selectedBackground: null,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                // 测试处理世界图片
                const processedWorld = await WorldDataUtils.processWorldImages(testWorld);
                
                const hasStorageUrls = [
                    processedWorld.thumbnail,
                    processedWorld.coverUrl,
                    processedWorld.previewImage
                ].some(url => url.includes('supabase') || url.startsWith('http'));
                
                if (hasStorageUrls) {
                    resultsDiv.innerHTML = `
                        <div class="success">✓ 世界图片处理成功</div>
                        <div class="info">缩略图: ${processedWorld.thumbnail}</div>
                        <div class="info">封面图: ${processedWorld.coverUrl}</div>
                        <div class="info">预览图: ${processedWorld.previewImage}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="info">世界图片使用fallback (Base64)</div>
                        <div class="info">这可能是因为Supabase连接问题</div>
                    `;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">世界处理失败: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>