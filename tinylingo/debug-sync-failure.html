<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•è´´çº¸åŒæ­¥å¤±è´¥é—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-section {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è´´çº¸åŒæ­¥å¤±è´¥è°ƒè¯•å·¥å…·</h1>
        <p>æ—¢ç„¶æ•°æ®åº“è¡¨å­˜åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ†æåŒæ­¥å¤±è´¥çš„çœŸæ­£åŸå› </p>
        
        <div class="test-section">
            <h3>1. åŸºç¡€è¿æ¥æµ‹è¯•</h3>
            <button onclick="testBasicConnection()">æµ‹è¯• Supabase è¿æ¥</button>
            <div id="connection-result"></div>
        </div>

        <div class="test-section">
            <h3>2. ç”¨æˆ·è®¤è¯çŠ¶æ€</h3>
            <button onclick="testUserAuth()">æ£€æŸ¥ç”¨æˆ·è®¤è¯</button>
            <div id="auth-result"></div>
        </div>

        <div class="test-section">
            <h3>3. RLS ç­–ç•¥æµ‹è¯•</h3>
            <button onclick="testRLSPolicies()">æµ‹è¯• RLS æƒé™</button>
            <div id="rls-result"></div>
        </div>

        <div class="test-section">
            <h3>4. æ•°æ®æ ¼å¼éªŒè¯</h3>
            <button onclick="testDataFormat()">éªŒè¯è´´çº¸æ•°æ®æ ¼å¼</button>
            <div id="format-result"></div>
        </div>

        <div class="test-section">
            <h3>5. å®Œæ•´åŒæ­¥æµ‹è¯•</h3>
            <button onclick="testFullSync()">æ‰§è¡Œå®Œæ•´åŒæ­¥æµ‹è¯•</button>
            <div id="sync-result"></div>
        </div>

        <div class="test-section">
            <h3>6. é”™è¯¯æ—¥å¿—</h3>
            <div id="error-logs"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // æ—¥å¿—è®°å½•å‡½æ•°
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('error-logs');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="status ${type}">[${timestamp}] ${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // è·å–æˆ–ç”Ÿæˆç”¨æˆ·ID
        function getCurrentUserId() {
            let userId = localStorage.getItem('currentUserId');
            if (!userId) {
                userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem('currentUserId', userId);
            }
            return userId;
        }

        // 1. æµ‹è¯•åŸºç¡€è¿æ¥
        async function testBasicConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
            
            try {
                // æµ‹è¯•åŸºç¡€è¿æ¥
                const { data, error } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    resultDiv.innerHTML = `<div class="status error">è¿æ¥å¤±è´¥: ${error.message}</div>`;
                    addLog(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                } else {
                    resultDiv.innerHTML = '<div class="status success">âœ… Supabase è¿æ¥æ­£å¸¸</div>';
                    addLog('Supabase è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">è¿æ¥å¼‚å¸¸: ${error.message}</div>`;
                addLog(`è¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 2. æµ‹è¯•ç”¨æˆ·è®¤è¯çŠ¶æ€
        async function testUserAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æ£€æŸ¥ç”¨æˆ·è®¤è¯...</div>';
            
            try {
                const userId = getCurrentUserId();
                addLog(`å½“å‰ç”¨æˆ·ID: ${userId}`, 'info');
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                if (userError && userError.code !== 'PGRST116') {
                    resultDiv.innerHTML = `<div class="status error">ç”¨æˆ·æŸ¥è¯¢å¤±è´¥: ${userError.message}</div>`;
                    addLog(`ç”¨æˆ·æŸ¥è¯¢å¤±è´¥: ${userError.message}`, 'error');
                    return;
                }
                
                if (!userData) {
                    // å°è¯•åˆ›å»ºç”¨æˆ·
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert({
                            user_id: userId,
                            username: 'Test User',
                            email: '',
                            preferences: {},
                            last_login: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (createError) {
                        resultDiv.innerHTML = `<div class="status error">åˆ›å»ºç”¨æˆ·å¤±è´¥: ${createError.message}</div>`;
                        addLog(`åˆ›å»ºç”¨æˆ·å¤±è´¥: ${createError.message}`, 'error');
                    } else {
                        resultDiv.innerHTML = '<div class="status success">âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ</div>';
                        addLog('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                    }
                } else {
                    resultDiv.innerHTML = '<div class="status success">âœ… ç”¨æˆ·è®¤è¯æ­£å¸¸</div>';
                    addLog('ç”¨æˆ·è®¤è¯æ­£å¸¸', 'success');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">è®¤è¯æ£€æŸ¥å¼‚å¸¸: ${error.message}</div>`;
                addLog(`è®¤è¯æ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 3. æµ‹è¯• RLS ç­–ç•¥
        async function testRLSPolicies() {
            const resultDiv = document.getElementById('rls-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯• RLS ç­–ç•¥...</div>';
            
            try {
                const userId = getCurrentUserId();
                
                // æµ‹è¯•è¯»å–æƒé™
                const { data: readData, error: readError } = await supabase
                    .from('user_stickers')
                    .select('*')
                    .eq('user_id', userId)
                    .limit(1);
                
                if (readError) {
                    resultDiv.innerHTML = `<div class="status error">è¯»å–æƒé™æµ‹è¯•å¤±è´¥: ${readError.message}</div>`;
                    addLog(`RLS è¯»å–æƒé™å¤±è´¥: ${readError.message}`, 'error');
                    return;
                }
                
                // æµ‹è¯•å†™å…¥æƒé™
                const testSticker = {
                    user_id: userId,
                    sticker_id: `test_${Date.now()}`,
                    word: 'test',
                    cn: 'æµ‹è¯•',
                    pos: 'noun',
                    image: '',
                    audio: { uk: '', us: '' },
                    examples: [],
                    mnemonic: [],
                    mastery_status: 'new',
                    tags: [],
                    related_words: [],
                    is_deleted: false
                };
                
                const { data: writeData, error: writeError } = await supabase
                    .from('user_stickers')
                    .insert(testSticker)
                    .select();
                
                if (writeError) {
                    resultDiv.innerHTML = `<div class="status error">å†™å…¥æƒé™æµ‹è¯•å¤±è´¥: ${writeError.message}</div>`;
                    addLog(`RLS å†™å…¥æƒé™å¤±è´¥: ${writeError.message}`, 'error');
                } else {
                    resultDiv.innerHTML = '<div class="status success">âœ… RLS ç­–ç•¥æ­£å¸¸</div>';
                    addLog('RLS ç­–ç•¥æµ‹è¯•æˆåŠŸ', 'success');
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    await supabase
                        .from('user_stickers')
                        .delete()
                        .eq('sticker_id', testSticker.sticker_id);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">RLS æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                addLog(`RLS æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 4. æµ‹è¯•æ•°æ®æ ¼å¼
        async function testDataFormat() {
            const resultDiv = document.getElementById('format-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨éªŒè¯æ•°æ®æ ¼å¼...</div>';
            
            try {
                // è·å–æœ¬åœ°è´´çº¸æ•°æ®
                const localStickers = localStorage.getItem('myStickers');
                if (!localStickers) {
                    resultDiv.innerHTML = '<div class="status warning">âš ï¸ æœ¬åœ°æ²¡æœ‰è´´çº¸æ•°æ®</div>';
                    addLog('æœ¬åœ°æ²¡æœ‰è´´çº¸æ•°æ®', 'warning');
                    return;
                }
                
                const stickers = JSON.parse(localStickers);
                addLog(`æœ¬åœ°è´´çº¸æ•°é‡: ${stickers.length}`, 'info');
                
                if (stickers.length > 0) {
                    const firstSticker = stickers[0];
                    addLog(`ç¬¬ä¸€ä¸ªè´´çº¸æ•°æ®: ${JSON.stringify(firstSticker, null, 2)}`, 'info');
                    
                    // éªŒè¯å¿…éœ€å­—æ®µ
                    const requiredFields = ['word', 'cn', 'pos', 'image', 'audio', 'examples', 'mnemonic', 'masteryStatus', 'tags', 'relatedWords'];
                    const missingFields = requiredFields.filter(field => !(field in firstSticker));
                    
                    if (missingFields.length > 0) {
                        resultDiv.innerHTML = `<div class="status error">æ•°æ®æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}</div>`;
                        addLog(`æ•°æ®æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘å­—æ®µ: ${missingFields.join(', ')}`, 'error');
                    } else {
                        resultDiv.innerHTML = '<div class="status success">âœ… æ•°æ®æ ¼å¼éªŒè¯é€šè¿‡</div>';
                        addLog('æ•°æ®æ ¼å¼éªŒè¯é€šè¿‡', 'success');
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">æ•°æ®æ ¼å¼éªŒè¯å¼‚å¸¸: ${error.message}</div>`;
                addLog(`æ•°æ®æ ¼å¼éªŒè¯å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 5. å®Œæ•´åŒæ­¥æµ‹è¯•
        async function testFullSync() {
            const resultDiv = document.getElementById('sync-result');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æ‰§è¡Œå®Œæ•´åŒæ­¥æµ‹è¯•...</div>';
            
            try {
                const userId = getCurrentUserId();
                
                // è·å–æœ¬åœ°è´´çº¸æ•°æ®
                const localStickers = localStorage.getItem('myStickers');
                if (!localStickers) {
                    resultDiv.innerHTML = '<div class="status warning">âš ï¸ æœ¬åœ°æ²¡æœ‰è´´çº¸æ•°æ®å¯åŒæ­¥</div>';
                    return;
                }
                
                const stickers = JSON.parse(localStickers);
                addLog(`å‡†å¤‡åŒæ­¥ ${stickers.length} ä¸ªè´´çº¸`, 'info');
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                const userStickers = stickers.map(sticker => ({
                    user_id: userId,
                    sticker_id: sticker.id || `sticker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    word: sticker.word || '',
                    cn: sticker.cn || '',
                    pos: sticker.pos || 'noun',
                    image: sticker.image || '',
                    audio: sticker.audio || { uk: '', us: '' },
                    examples: sticker.examples || [],
                    mnemonic: sticker.mnemonic || [],
                    mastery_status: sticker.masteryStatus || 'new',
                    tags: sticker.tags || [],
                    related_words: sticker.relatedWords || [],
                    is_deleted: false
                }));
                
                // æ‰§è¡ŒåŒæ­¥
                const { data, error } = await supabase
                    .from('user_stickers')
                    .upsert(userStickers, {
                        onConflict: 'user_id,sticker_id',
                        ignoreDuplicates: false
                    })
                    .select();
                
                if (error) {
                    resultDiv.innerHTML = `<div class="status error">åŒæ­¥å¤±è´¥: ${error.message}</div>`;
                    addLog(`åŒæ­¥å¤±è´¥: ${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    resultDiv.innerHTML = `<div class="status success">âœ… åŒæ­¥æˆåŠŸï¼Œå…±åŒæ­¥ ${data.length} ä¸ªè´´çº¸</div>`;
                    addLog(`åŒæ­¥æˆåŠŸï¼Œå…±åŒæ­¥ ${data.length} ä¸ªè´´çº¸`, 'success');
                    
                    // æ›´æ–°åŒæ­¥çŠ¶æ€
                    await supabase
                        .from('user_sync_status')
                        .upsert({
                            user_id: userId,
                            data_type: 'stickers',
                            last_sync_at: new Date().toISOString(),
                            sync_version: 1,
                            is_syncing: false,
                            sync_error: null
                        }, {
                            onConflict: 'user_id,data_type'
                        });
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">åŒæ­¥æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
                addLog(`åŒæ­¥æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.onload = function() {
            addLog('è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œå¼€å§‹è¯Šæ–­è´´çº¸åŒæ­¥é—®é¢˜', 'info');
        };
    </script>
</body>
</html>