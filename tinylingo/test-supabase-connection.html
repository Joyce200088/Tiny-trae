<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase连接测试</h1>
        
        <div id="status-container">
            <div class="status info">正在检查Supabase连接...</div>
        </div>

        <div>
            <button onclick="testConnection()">测试连接</button>
            <button onclick="testAuth()">测试认证</button>
            <button onclick="testGetUser()">获取用户信息</button>
            <button onclick="clearLogs()">清除日志</button>
        </div>

        <div id="logs">
            <h3>测试日志:</h3>
            <pre id="log-content"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase配置 - 从环境变量获取
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';

        // 创建Supabase客户端
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
                flowType: 'pkce',
            },
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('log-content');
            const statusContainer = document.getElementById('status-container');
            
            // 添加到日志
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
            
            // 更新状态显示
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            statusContainer.innerHTML = `<div class="status ${statusClass}">${message}</div>`;
            
            console.log(`[Supabase Test] ${message}`);
        }

        async function testConnection() {
            log('开始测试Supabase连接...', 'info');
            
            try {
                // 测试基本连接
                log(`Supabase URL: ${SUPABASE_URL}`);
                log(`Anon Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`);
                
                // 测试简单查询
                const { data, error } = await supabase
                    .from('preset_worlds')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`连接测试失败: ${error.message}`, 'error');
                    log(`错误详情: ${JSON.stringify(error, null, 2)}`);
                } else {
                    log('Supabase连接成功！', 'success');
                    log(`查询结果: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (err) {
                log(`连接异常: ${err.message}`, 'error');
                log(`异常详情: ${JSON.stringify(err, null, 2)}`);
            }
        }

        async function testAuth() {
            log('开始测试认证状态...', 'info');
            
            try {
                // 获取当前会话
                const { data: session, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    log(`获取会话失败: ${sessionError.message}`, 'error');
                } else {
                    log(`会话状态: ${session.session ? '已登录' : '未登录'}`);
                    if (session.session) {
                        log(`用户ID: ${session.session.user.id}`);
                        log(`用户邮箱: ${session.session.user.email}`);
                    }
                }
                
                // 获取用户信息
                const { data: user, error: userError } = await supabase.auth.getUser();
                
                if (userError) {
                    log(`获取用户信息失败: ${userError.message}`, 'error');
                } else {
                    log(`用户信息: ${user.user ? '有用户' : '无用户'}`);
                    if (user.user) {
                        log(`用户详情: ${JSON.stringify({
                            id: user.user.id,
                            email: user.user.email,
                            created_at: user.user.created_at,
                            email_confirmed_at: user.user.email_confirmed_at
                        }, null, 2)}`);
                    }
                }
                
            } catch (err) {
                log(`认证测试异常: ${err.message}`, 'error');
            }
        }

        async function testGetUser() {
            log('测试获取用户信息...', 'info');
            
            try {
                const startTime = Date.now();
                const { data: { user }, error } = await supabase.auth.getUser();
                const endTime = Date.now();
                
                log(`请求耗时: ${endTime - startTime}ms`);
                
                if (error) {
                    log(`获取用户失败: ${error.message}`, 'error');
                    log(`错误代码: ${error.status || 'unknown'}`);
                } else {
                    log(`用户获取成功: ${user ? '有用户数据' : '无用户数据'}`, user ? 'success' : 'warning');
                    if (user) {
                        log(`用户信息: ${JSON.stringify(user, null, 2)}`);
                    }
                }
            } catch (err) {
                log(`获取用户异常: ${err.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('log-content').textContent = '';
            log('日志已清除', 'info');
        }

        // 页面加载时自动测试
        window.addEventListener('load', () => {
            log('页面加载完成，开始自动测试...', 'info');
            setTimeout(testConnection, 1000);
            setTimeout(testAuth, 2000);
        });

        // 监听认证状态变化
        supabase.auth.onAuthStateChange((event, session) => {
            log(`认证状态变化: ${event}`, 'info');
            if (session) {
                log(`新会话: 用户 ${session.user.email}`);
            } else {
                log('会话已清除');
            }
        });
    </script>
</body>
</html>