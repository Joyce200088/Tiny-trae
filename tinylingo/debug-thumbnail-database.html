<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼©ç•¥å›¾æ•°æ®åº“æ£€æŸ¥å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #FFFBF5;
        }
        .debug-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .world-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .world-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .world-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .world-id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        .thumbnail-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .thumbnail-info {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
        }
        .thumbnail-preview {
            max-width: 200px;
            max-height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .url-display {
            font-family: monospace;
            font-size: 12px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
            margin: 5px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ” ç¼©ç•¥å›¾æ•°æ®åº“æ£€æŸ¥å·¥å…·</h1>
        
        <div class="status info">
            <strong>æ£€æŸ¥ç›®æ ‡ï¼š</strong>
            <ul>
                <li>æ•°æ®åº“ä¸­ä¸–ç•Œçš„ç¼©ç•¥å›¾å­—æ®µæ˜¯å¦æ­£ç¡®ä¿å­˜</li>
                <li>ç¼©ç•¥å›¾URLæ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</li>
                <li>å›¾ç‰‡åŠ è½½å¤±è´¥çš„å…·ä½“åŸå› </li>
                <li>Storageä¸­çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="test-button" onclick="checkDatabase()">ğŸ” æ£€æŸ¥æ•°æ®åº“ç¼©ç•¥å›¾</button>
            <button class="test-button" onclick="testImageLoading()">ğŸ–¼ï¸ æµ‹è¯•å›¾ç‰‡åŠ è½½</button>
            <button class="test-button" onclick="checkStorageFiles()">ğŸ“ æ£€æŸ¥Storageæ–‡ä»¶</button>
            <button class="test-button" onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
        </div>

        <div id="results"></div>
    </div>

    <script type="module">
        // æ¨¡æ‹ŸSupabaseå®¢æˆ·ç«¯
        const mockSupabaseClient = {
            from: (table) => ({
                select: (fields = '*') => ({
                    eq: (column, value) => ({
                        single: () => Promise.resolve({
                            data: null,
                            error: { message: 'æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ - è¯·åœ¨å®é™…ç¯å¢ƒä¸­æµ‹è¯•' }
                        })
                    }),
                    limit: (count) => Promise.resolve({
                        data: [],
                        error: { message: 'æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ - è¯·åœ¨å®é™…ç¯å¢ƒä¸­æµ‹è¯•' }
                    })
                })
            }),
            storage: {
                from: (bucket) => ({
                    list: (path = '') => Promise.resolve({
                        data: [],
                        error: { message: 'æ¨¡æ‹ŸStorageè¿æ¥ - è¯·åœ¨å®é™…ç¯å¢ƒä¸­æµ‹è¯•' }
                    }),
                    getPublicUrl: (path) => ({
                        data: { publicUrl: `https://mock-storage.supabase.co/storage/v1/object/public/${bucket}/${path}` }
                    })
                })
            }
        };

        // å®é™…çš„WorldDataUtilså®ç°
        const RealWorldDataUtils = {
            /**
             * è·å–å½“å‰ç”¨æˆ·ä¸“å±çš„å­˜å‚¨é”®
             * æ ¼å¼ï¼štinylingo_worlds_[userId] æˆ– tinylingo_worlds_guestï¼ˆæœªç™»å½•ç”¨æˆ·ï¼‰
             */
            async getUserStorageKey() {
                try {
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨è®¿å®¢é”®
                    // åœ¨å®é™…ç¯å¢ƒä¸­ä¼šå°è¯•è·å–ç”¨æˆ·ID
                    return 'tinylingo_worlds_guest';
                } catch (error) {
                    console.warn('è·å–ç”¨æˆ·IDå¤±è´¥ï¼Œä½¿ç”¨è®¿å®¢æ¨¡å¼:', error);
                    return 'tinylingo_worlds_guest';
                }
            },

            /**
             * ä»localStorageåŠ è½½ä¸–ç•Œæ•°æ®
             * ä½¿ç”¨ç”¨æˆ·ä¸“å±çš„å­˜å‚¨é”®ï¼Œç¡®ä¿æ•°æ®éš”ç¦»
             */
            async loadWorldData() {
                try {
                    if (typeof window === 'undefined') return [];
                    
                    const storageKey = await this.getUserStorageKey();
                    const savedData = localStorage.getItem(storageKey);
                    if (!savedData) {
                        console.log('æ²¡æœ‰æ‰¾åˆ°ä¸–ç•Œæ•°æ®ï¼Œå°è¯•æ£€æŸ¥å…¶ä»–å¯èƒ½çš„é”®...');
                        
                        // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„localStorageé”®
                        const allKeys = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.includes('tinylingo') || key.includes('world')) {
                                allKeys.push(key);
                            }
                        }
                        console.log('æ‰¾åˆ°çš„ç›¸å…³localStorageé”®:', allKeys);
                        
                        return [];
                    }

                    const parsedData = JSON.parse(savedData);
                    const worlds = Array.isArray(parsedData) ? parsedData : [];
                    console.log(`ä»localStorageåŠ è½½ä¸–ç•Œæ•°æ® (é”®: ${storageKey}):`, worlds.length, 'ä¸ªä¸–ç•Œ');
                    return worlds;
                } catch (error) {
                    console.error('åŠ è½½ä¸–ç•Œæ•°æ®å¤±è´¥:', error);
                    return [];
                }
            },

            /**
             * è·å–æ‰€æœ‰ä¸–ç•Œæ•°æ®
             * æ”¯æŒç”¨æˆ·æ•°æ®éš”ç¦»
             */
            async getAllWorlds() {
                return await this.loadWorldData();
            },

            /**
             * æ£€æŸ¥æ‰€æœ‰localStorageä¸­çš„ä¸–ç•Œç›¸å…³æ•°æ®
             */
            async getAllStorageKeys() {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        keys.push({
                            key: key,
                            size: localStorage.getItem(key)?.length || 0,
                            isWorldData: key.includes('tinylingo') || key.includes('world')
                        });
                    }
                }
                return keys;
            }
        };

        // è¾…åŠ©å‡½æ•°ï¼šè·å–ç¼©ç•¥å›¾ç±»å‹
        function getThumbnailType(thumbnail) {
            if (!thumbnail) return 'None';
            if (thumbnail.startsWith('data:image/')) return 'Base64';
            if (thumbnail.startsWith('http://') || thumbnail.startsWith('https://')) return 'HTTP URL';
            if (thumbnail.startsWith('blob:')) return 'Blob URL';
            return 'Unknown';
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–ç¼©ç•¥å›¾ç±»å‹ï¼ˆå…¨å±€å‡½æ•°ï¼‰
        window.getThumbnailType = getThumbnailType;

        // æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç¼©ç•¥å›¾æ•°æ®
        window.checkDatabase = async function() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '<div class="loading">ğŸ” æ­£åœ¨æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç¼©ç•¥å›¾æ•°æ®...</div>';

            try {
                console.log('=== å¼€å§‹æ£€æŸ¥æ•°æ®åº“ç¼©ç•¥å›¾ ===');
                
                // 1. è·å–æ‰€æœ‰localStorageé”®å¹¶æŸ¥æ‰¾ä¸–ç•Œæ•°æ®
                const allKeys = await RealWorldDataUtils.getAllStorageKeys();
                console.log('æ‰€æœ‰localStorageé”®:', allKeys);
                
                let worlds = [];
                let dataSourceInfo = [];
                
                // å°è¯•ä»æ‰€æœ‰å¯èƒ½çš„é”®ä¸­åŠ è½½ä¸–ç•Œæ•°æ®
                for (const keyInfo of allKeys) {
                    try {
                        const data = localStorage.getItem(keyInfo.key);
                        if (data) {
                            const parsed = JSON.parse(data);
                            
                            // æ£€æŸ¥ä¸åŒçš„æ•°æ®æ ¼å¼
                            if (parsed.worlds && typeof parsed.worlds === 'object') {
                                // æ ¼å¼: { worlds: { worldId: worldData } }
                                const worldsArray = Object.values(parsed.worlds);
                                if (worldsArray.length > 0) {
                                    worlds.push(...worldsArray);
                                    dataSourceInfo.push(`âœ… ä»é”® "${keyInfo.key}" çš„ worlds å±æ€§ä¸­æ‰¾åˆ° ${worldsArray.length} ä¸ªä¸–ç•Œ`);
                                }
                            } else if (Array.isArray(parsed)) {
                                // æ ¼å¼: [worldData1, worldData2, ...]
                                if (parsed.length > 0 && parsed[0].id) {
                                    worlds.push(...parsed);
                                    dataSourceInfo.push(`âœ… ä»é”® "${keyInfo.key}" çš„æ•°ç»„ä¸­æ‰¾åˆ° ${parsed.length} ä¸ªä¸–ç•Œ`);
                                }
                            } else if (parsed.id && parsed.title) {
                                // æ ¼å¼: å•ä¸ªä¸–ç•Œå¯¹è±¡
                                worlds.push(parsed);
                                dataSourceInfo.push(`âœ… ä»é”® "${keyInfo.key}" ä¸­æ‰¾åˆ° 1 ä¸ªä¸–ç•Œ`);
                            } else if (typeof parsed === 'object') {
                                // æ£€æŸ¥å¯¹è±¡çš„å±æ€§æ˜¯å¦åŒ…å«ä¸–ç•Œæ•°æ®
                                const possibleWorlds = Object.values(parsed).filter(item => 
                                    item && typeof item === 'object' && item.id && item.title
                                );
                                if (possibleWorlds.length > 0) {
                                    worlds.push(...possibleWorlds);
                                    dataSourceInfo.push(`âœ… ä»é”® "${keyInfo.key}" çš„å¯¹è±¡å±æ€§ä¸­æ‰¾åˆ° ${possibleWorlds.length} ä¸ªä¸–ç•Œ`);
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('è§£æé”®å¤±è´¥:', keyInfo.key, e);
                    }
                }
                
                // å»é‡ï¼ˆåŸºäºä¸–ç•ŒIDï¼‰
                const uniqueWorlds = [];
                const seenIds = new Set();
                for (const world of worlds) {
                    if (!seenIds.has(world.id)) {
                        uniqueWorlds.push(world);
                        seenIds.add(world.id);
                    }
                }
                worlds = uniqueWorlds;
                
                if (worlds.length === 0) {
                    let warningHtml = '<div class="status warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä¸–ç•Œæ•°æ®</div>';
                    
                    // æ˜¾ç¤ºæ‰€æœ‰localStorageé”®çš„ä¿¡æ¯
                    if (allKeys.length > 0) {
                        warningHtml += '<div class="status info"><h4>ğŸ“‹ localStorageä¸­çš„æ‰€æœ‰é”®:</h4><ul>';
                        allKeys.forEach(keyInfo => {
                            warningHtml += `<li><strong>${keyInfo.key}</strong> (${keyInfo.size} å­—ç¬¦) ${keyInfo.isWorldData ? 'ğŸŒ' : ''}</li>`;
                        });
                        warningHtml += '</ul></div>';
                    }
                    
                    resultsEl.innerHTML = warningHtml;
                    return;
                }
                
                // æ˜¾ç¤ºæ•°æ®æ¥æºä¿¡æ¯
                let resultsHtml = `<div class="status success">ğŸ“Š æ€»å…±æ‰¾åˆ° ${worlds.length} ä¸ªä¸–ç•Œ</div>`;
                resultsHtml += '<div class="status info"><h4>ğŸ“‹ æ•°æ®æ¥æº:</h4><ul>';
                dataSourceInfo.forEach(info => {
                    resultsHtml += `<li>${info}</li>`;
                });
                resultsHtml += '</ul></div>';

                // 2. åˆ†ææ¯ä¸ªä¸–ç•Œçš„ç¼©ç•¥å›¾æ•°æ®
                for (let i = 0; i < worlds.length; i++) {
                    const world = worlds[i];
                    console.log(`åˆ†æä¸–ç•Œ ${i + 1}:`, world);
                    
                    resultsHtml += `<div class="world-item">
                        <h3>ğŸŒ ä¸–ç•Œ ${i + 1}: ${world.title || world.id}</h3>
                        <div class="world-details">
                            <p><strong>ID:</strong> ${world.id}</p>
                            <p><strong>æ ‡é¢˜:</strong> ${world.title || 'æœªè®¾ç½®'}</p>
                            <p><strong>æè¿°:</strong> ${world.description || 'æœªè®¾ç½®'}</p>
                        </div>`;
                    
                    // æ£€æŸ¥ç¼©ç•¥å›¾æ•°æ®
                    if (world.thumbnail) {
                        const thumbnailType = getThumbnailType(world.thumbnail);
                        resultsHtml += `<div class="thumbnail-info">
                            <p><strong>âœ… ç¼©ç•¥å›¾:</strong> å­˜åœ¨</p>
                            <p><strong>ç±»å‹:</strong> ${thumbnailType}</p>
                            <p><strong>é•¿åº¦:</strong> ${world.thumbnail.length} å­—ç¬¦</p>`;
                        
                        if (thumbnailType === 'Base64') {
                            resultsHtml += `<p><strong>Base64å‰ç¼€:</strong> ${world.thumbnail.substring(0, 50)}...</p>`;
                        } else {
                            resultsHtml += `<p><strong>URL:</strong> ${world.thumbnail}</p>`;
                        }
                        
                        // æµ‹è¯•å›¾ç‰‡åŠ è½½
                        resultsHtml += '<div class="image-test">';
                        resultsHtml += '<p><strong>ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½æµ‹è¯•:</strong></p>';
                        resultsHtml += `<img src="${world.thumbnail}" 
                                           style="max-width: 100px; max-height: 100px; border: 1px solid #ccc;" 
                                           onload="this.nextElementSibling.innerHTML='âœ… åŠ è½½æˆåŠŸ'" 
                                           onerror="this.nextElementSibling.innerHTML='âŒ åŠ è½½å¤±è´¥'">`;
                        resultsHtml += '<span class="load-status">â³ åŠ è½½ä¸­...</span>';
                        resultsHtml += '</div>';
                        
                    } else {
                        resultsHtml += `<div class="thumbnail-info">
                            <p><strong>âŒ ç¼©ç•¥å›¾:</strong> ä¸å­˜åœ¨</p>
                        </div>`;
                    }
                    
                    // æ£€æŸ¥å…¶ä»–å¯èƒ½çš„å›¾ç‰‡å­—æ®µ
                    const imageFields = ['previewImage', 'coverUrl', 'image'];
                    for (const field of imageFields) {
                        if (world[field]) {
                            resultsHtml += `<div class="other-image">
                                <p><strong>ğŸ“· ${field}:</strong> ${getThumbnailType(world[field])} (${world[field].length} å­—ç¬¦)</p>
                            </div>`;
                        }
                    }
                    
                    resultsHtml += '</div>';
                }
                
                // 3. Storageæ–‡ä»¶æ£€æŸ¥ï¼ˆæ¨¡æ‹Ÿï¼‰
                resultsHtml += `<div class="storage-check">
                    <h3>ğŸ“ Storageæ–‡ä»¶æ£€æŸ¥</h3>
                    <p class="warning">âš ï¸ è¿™æ˜¯æ¨¡æ‹Ÿæ£€æŸ¥ï¼Œå®é™…éœ€è¦è¿æ¥Supabase Storage</p>
                    <div class="simulated-check">
                        <p>âœ… æ¨¡æ‹Ÿæ£€æŸ¥å®Œæˆ</p>
                        <p>ğŸ“Š å»ºè®®æ£€æŸ¥Supabase Storageä¸­çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>
                    </div>
                </div>`;
                
                resultsEl.innerHTML = resultsHtml;
                
                // 2. åˆ†ææ¯ä¸ªä¸–ç•Œçš„ç¼©ç•¥å›¾æ•°æ®
                let worldsWithThumbnail = 0;
                let worldsWithValidUrl = 0;
                let worldsWithBase64 = 0;
                let worldsWithBlobUrl = 0;
                let worldsWithoutThumbnail = 0;

                for (const world of worlds) {
                    const hasThumbnail = !!world.thumbnail;
                    const isValidUrl = world.thumbnail && (world.thumbnail.startsWith('http') || world.thumbnail.startsWith('https'));
                    const isBase64 = world.thumbnail && world.thumbnail.startsWith('data:');
                    const isBlobUrl = world.thumbnail && world.thumbnail.startsWith('blob:');

                    if (hasThumbnail) {
                        worldsWithThumbnail++;
                        if (isValidUrl) worldsWithValidUrl++;
                        if (isBase64) worldsWithBase64++;
                        if (isBlobUrl) worldsWithBlobUrl++;
                    } else {
                        worldsWithoutThumbnail++;
                    }

                    // ä¸ºæ¯ä¸ªä¸–ç•Œåˆ›å»ºè¯¦ç»†ä¿¡æ¯å¡ç‰‡
                    resultsHtml += `
                        <div class="world-card">
                            <div class="world-header">
                                <div class="world-name">${world.name || 'æœªå‘½åä¸–ç•Œ'}</div>
                                <div class="world-id">ID: ${world.id}</div>
                            </div>
                            
                            <div class="thumbnail-test">
                                <div class="thumbnail-info">
                                    <h4>ğŸ“‹ ç¼©ç•¥å›¾æ•°æ®åˆ†æ</h4>
                                    <p><strong>ç¼©ç•¥å›¾çŠ¶æ€:</strong> ${hasThumbnail ? 'âœ… æœ‰' : 'âŒ æ— '}</p>
                                    ${hasThumbnail ? `
                                        <p><strong>æ•°æ®ç±»å‹:</strong> ${isValidUrl ? 'ğŸŒ HTTP URL' : isBase64 ? 'ğŸ“„ Base64' : isBlobUrl ? 'ğŸ”— Blob URL' : 'â“ æœªçŸ¥æ ¼å¼'}</p>
                                        <p><strong>æ•°æ®é•¿åº¦:</strong> ${world.thumbnail.length} å­—ç¬¦</p>
                                        <div class="url-display">
                                            <strong>URLé¢„è§ˆ:</strong><br>
                                            ${world.thumbnail.substring(0, 100)}${world.thumbnail.length > 100 ? '...' : ''}
                                        </div>
                                    ` : '<p style="color: #dc3545;">æ— ç¼©ç•¥å›¾æ•°æ®</p>'}
                                    
                                    <p><strong>å…¶ä»–å›¾ç‰‡å­—æ®µ:</strong></p>
                                    <ul style="font-size: 12px;">
                                        <li>previewImage: ${world.previewImage ? 'âœ… æœ‰' : 'âŒ æ— '}</li>
                                        <li>coverUrl: ${world.coverUrl ? 'âœ… æœ‰' : 'âŒ æ— '}</li>
                                    </ul>
                                </div>
                                
                                <div class="thumbnail-info">
                                    <h4>ğŸ–¼ï¸ ç¼©ç•¥å›¾é¢„è§ˆæµ‹è¯•</h4>
                                    ${hasThumbnail ? `
                                        <img src="${world.thumbnail}" 
                                             class="thumbnail-preview" 
                                             alt="${world.name}"
                                             onload="console.log('ä¸–ç•Œ ${world.name} ç¼©ç•¥å›¾åŠ è½½æˆåŠŸ'); this.nextElementSibling.innerHTML = 'âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ'"
                                             onerror="console.error('ä¸–ç•Œ ${world.name} ç¼©ç•¥å›¾åŠ è½½å¤±è´¥'); this.style.display='none'; this.nextElementSibling.innerHTML = 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ - å¯èƒ½æ˜¯URLæ— æ•ˆæˆ–æ–‡ä»¶ä¸å­˜åœ¨'">
                                        <div class="status info">â³ æ­£åœ¨åŠ è½½...</div>
                                    ` : '<div class="status warning">æ— ç¼©ç•¥å›¾å¯é¢„è§ˆ</div>'}
                                </div>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button class="test-button" onclick="testSingleWorldThumbnail('${world.id}')">ğŸ” è¯¦ç»†æµ‹è¯•æ­¤ä¸–ç•Œ</button>
                            </div>
                        </div>
                    `;
                }

                // 3. æ·»åŠ ç»Ÿè®¡æ‘˜è¦
                resultsHtml += `
                    <div class="status ${worldsWithThumbnail > 0 ? 'success' : 'warning'}">
                        <h3>ğŸ“Š ç¼©ç•¥å›¾æ•°æ®ç»Ÿè®¡</h3>
                        <ul>
                            <li>æ€»ä¸–ç•Œæ•°: ${worlds.length}</li>
                            <li>æœ‰ç¼©ç•¥å›¾: ${worldsWithThumbnail} ä¸ª</li>
                            <li>æ— ç¼©ç•¥å›¾: ${worldsWithoutThumbnail} ä¸ª</li>
                            <li>HTTP URLæ ¼å¼: ${worldsWithValidUrl} ä¸ª</li>
                            <li>Base64æ ¼å¼: ${worldsWithBase64} ä¸ª</li>
                            <li>Blob URLæ ¼å¼: ${worldsWithBlobUrl} ä¸ª</li>
                        </ul>
                        
                        ${worldsWithThumbnail === 0 ? 
                            '<p style="color: #dc3545;"><strong>âš ï¸ é—®é¢˜ï¼šæ‰€æœ‰ä¸–ç•Œéƒ½æ²¡æœ‰ç¼©ç•¥å›¾æ•°æ®ï¼</strong></p>' :
                            worldsWithValidUrl === 0 && worldsWithBase64 > 0 ?
                            '<p style="color: #856404;"><strong>âš ï¸ æ³¨æ„ï¼šæ‰€æœ‰ç¼©ç•¥å›¾éƒ½æ˜¯Base64æ ¼å¼ï¼Œå¯èƒ½æœªä¸Šä¼ åˆ°Storage</strong></p>' :
                            '<p style="color: #155724;"><strong>âœ… ç¼©ç•¥å›¾æ•°æ®çœ‹èµ·æ¥æ­£å¸¸</strong></p>'
                        }
                    </div>
                `;

                resultsEl.innerHTML = resultsHtml;
                console.log('=== æ•°æ®åº“ç¼©ç•¥å›¾æ£€æŸ¥å®Œæˆ ===');

            } catch (error) {
                console.error('æ£€æŸ¥æ•°æ®åº“å¤±è´¥:', error);
                resultsEl.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        };

        // æµ‹è¯•å›¾ç‰‡åŠ è½½
        window.testImageLoading = async function() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '<div class="loading">ğŸ–¼ï¸ æ­£åœ¨æµ‹è¯•å›¾ç‰‡åŠ è½½...</div>';

            try {
                const worlds = await RealWorldDataUtils.getAllWorlds();
                
                if (worlds.length === 0) {
                    resultsEl.innerHTML = '<div class="status warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä¸–ç•Œæ•°æ®è¿›è¡Œæµ‹è¯•</div>';
                    return;
                }

                let resultsHtml = '<div class="status info">ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½æµ‹è¯•ç»“æœ</div>';
                
                for (const world of worlds) {
                    if (!world.thumbnail) continue;

                    resultsHtml += `
                        <div class="world-card">
                            <div class="world-header">
                                <div class="world-name">${world.name}</div>
                                <div class="world-id">æµ‹è¯•å›¾ç‰‡åŠ è½½</div>
                            </div>
                            
                            <div class="thumbnail-test">
                                <div class="thumbnail-info">
                                    <h4>ğŸ”— URLåˆ†æ</h4>
                                    <div class="url-display">${world.thumbnail}</div>
                                    <p><strong>URLç±»å‹:</strong> ${
                                        world.thumbnail.startsWith('https://') ? 'ğŸ”’ HTTPS' :
                                        world.thumbnail.startsWith('http://') ? 'ğŸŒ HTTP' :
                                        world.thumbnail.startsWith('data:') ? 'ğŸ“„ Base64' :
                                        world.thumbnail.startsWith('blob:') ? 'ğŸ”— Blob' : 'â“ æœªçŸ¥'
                                    }</p>
                                </div>
                                
                                <div class="thumbnail-info">
                                    <h4>ğŸ–¼ï¸ åŠ è½½æµ‹è¯•</h4>
                                    <img src="${world.thumbnail}" 
                                         class="thumbnail-preview" 
                                         alt="${world.name}"
                                         onload="this.nextElementSibling.innerHTML = 'âœ… åŠ è½½æˆåŠŸ (' + this.naturalWidth + 'x' + this.naturalHeight + ')'"
                                         onerror="this.style.display='none'; this.nextElementSibling.innerHTML = 'âŒ åŠ è½½å¤±è´¥ - æ£€æŸ¥URLæˆ–ç½‘ç»œè¿æ¥'">
                                    <div class="status info">â³ åŠ è½½ä¸­...</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                resultsEl.innerHTML = resultsHtml;

            } catch (error) {
                console.error('å›¾ç‰‡åŠ è½½æµ‹è¯•å¤±è´¥:', error);
                resultsEl.innerHTML = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        };

        // æ£€æŸ¥Storageæ–‡ä»¶
        window.checkStorageFiles = async function() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '<div class="loading">ğŸ“ æ­£åœ¨æ£€æŸ¥Supabase Storageæ–‡ä»¶...</div>';

            try {
                console.log('=== å¼€å§‹æ£€æŸ¥Storageæ–‡ä»¶ ===');
                
                // æ¨¡æ‹Ÿæ£€æŸ¥Storageä¸­çš„æ–‡ä»¶
                const bucketName = 'world-thumbnails';
                const storageResult = await mockSupabaseClient.storage.from(bucketName).list();
                
                let resultsHtml = `
                    <div class="status warning">
                        <h3>ğŸ“ Storageæ–‡ä»¶æ£€æŸ¥</h3>
                        <p><strong>æ³¨æ„ï¼š</strong> è¿™æ˜¯æ¨¡æ‹Ÿç¯å¢ƒï¼Œæ— æ³•è¿æ¥åˆ°çœŸå®çš„Supabase Storageã€‚</p>
                        <p>åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œæ­¤åŠŸèƒ½å°†æ£€æŸ¥ï¼š</p>
                        <ul>
                            <li>world-thumbnails bucketä¸­çš„æ–‡ä»¶åˆ—è¡¨</li>
                            <li>æ¯ä¸ªä¸–ç•ŒIDå¯¹åº”çš„ç¼©ç•¥å›¾æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
                            <li>æ–‡ä»¶çš„è®¿é—®æƒé™å’ŒURLæœ‰æ•ˆæ€§</li>
                        </ul>
                    </div>
                `;

                // è·å–ä¸–ç•Œæ•°æ®å¹¶æ¨¡æ‹Ÿæ£€æŸ¥
                const worlds = await RealWorldDataUtils.getAllWorlds();
                
                if (worlds.length > 0) {
                    resultsHtml += '<div class="status info"><h4>ğŸ” æ¨¡æ‹ŸStorageæ–‡ä»¶æ£€æŸ¥ç»“æœ</h4></div>';
                    
                    for (const world of worlds) {
                        const expectedFileName = `${world.id}_thumbnail.png`;
                        const expectedUrl = `https://your-project.supabase.co/storage/v1/object/public/world-thumbnails/${expectedFileName}`;
                        
                        resultsHtml += `
                            <div class="world-card">
                                <div class="world-header">
                                    <div class="world-name">${world.name}</div>
                                    <div class="world-id">Storageæ£€æŸ¥</div>
                                </div>
                                
                                <div class="thumbnail-info">
                                    <p><strong>é¢„æœŸæ–‡ä»¶å:</strong> ${expectedFileName}</p>
                                    <p><strong>é¢„æœŸURL:</strong></p>
                                    <div class="url-display">${expectedUrl}</div>
                                    <p><strong>å½“å‰ç¼©ç•¥å›¾URL:</strong></p>
                                    <div class="url-display">${world.thumbnail || 'æ— '}</div>
                                    <p><strong>URLåŒ¹é…:</strong> ${world.thumbnail && world.thumbnail.includes(expectedFileName) ? 'âœ… åŒ¹é…' : 'âŒ ä¸åŒ¹é…'}</p>
                                </div>
                            </div>
                        `;
                    }
                }

                resultsEl.innerHTML = resultsHtml;

            } catch (error) {
                console.error('Storageæ£€æŸ¥å¤±è´¥:', error);
                resultsEl.innerHTML = `<div class="status error">âŒ Storageæ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        };

        // æµ‹è¯•å•ä¸ªä¸–ç•Œçš„ç¼©ç•¥å›¾
        window.testSingleWorldThumbnail = async function(worldId) {
            try {
                const worlds = await RealWorldDataUtils.getAllWorlds();
                const world = worlds.find(w => w.id === worldId);
                
                if (!world) {
                    alert('æœªæ‰¾åˆ°æŒ‡å®šçš„ä¸–ç•Œ');
                    return;
                }

                console.log('è¯¦ç»†æµ‹è¯•ä¸–ç•Œ:', world.name);
                console.log('ç¼©ç•¥å›¾æ•°æ®:', world.thumbnail);
                
                // åˆ›å»ºè¯¦ç»†æµ‹è¯•çª—å£
                const testWindow = window.open('', '_blank', 'width=800,height=600');
                testWindow.document.write(`
                    <html>
                    <head>
                        <title>ä¸–ç•Œ ${world.name} ç¼©ç•¥å›¾è¯¦ç»†æµ‹è¯•</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .test-item { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
                            .url-display { font-family: monospace; background: #f0f0f0; padding: 10px; word-break: break-all; }
                            img { max-width: 300px; border: 1px solid #ddd; }
                        </style>
                    </head>
                    <body>
                        <h1>ä¸–ç•Œ "${world.name}" ç¼©ç•¥å›¾è¯¦ç»†æµ‹è¯•</h1>
                        
                        <div class="test-item">
                            <h3>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                            <p><strong>ä¸–ç•ŒID:</strong> ${world.id}</p>
                            <p><strong>ä¸–ç•Œåç§°:</strong> ${world.name}</p>
                            <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${world.createdAt || 'æœªçŸ¥'}</p>
                        </div>
                        
                        <div class="test-item">
                            <h3>ğŸ”— ç¼©ç•¥å›¾URL</h3>
                            <div class="url-display">${world.thumbnail || 'æ— ç¼©ç•¥å›¾æ•°æ®'}</div>
                        </div>
                        
                        ${world.thumbnail ? `
                            <div class="test-item">
                                <h3>ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ</h3>
                                <img src="${world.thumbnail}" 
                                     alt="${world.name}"
                                     onload="document.getElementById('loadResult').innerHTML = 'âœ… åŠ è½½æˆåŠŸ - å°ºå¯¸: ' + this.naturalWidth + 'x' + this.naturalHeight"
                                     onerror="document.getElementById('loadResult').innerHTML = 'âŒ åŠ è½½å¤±è´¥ - è¯·æ£€æŸ¥URLæˆ–ç½‘ç»œè¿æ¥'">
                                <div id="loadResult">â³ æ­£åœ¨åŠ è½½...</div>
                            </div>
                        ` : ''}
                        
                        <div class="test-item">
                            <h3>ğŸ” å®Œæ•´ä¸–ç•Œæ•°æ®</h3>
                            <pre style="background: #f8f9fa; padding: 15px; overflow: auto;">${JSON.stringify(world, null, 2)}</pre>
                        </div>
                    </body>
                    </html>
                `);
                testWindow.document.close();

            } catch (error) {
                console.error('å•ä¸ªä¸–ç•Œæµ‹è¯•å¤±è´¥:', error);
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        };

        // æ¸…é™¤ç»“æœ
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            console.log('ç¼©ç•¥å›¾æ•°æ®åº“æ£€æŸ¥å·¥å…·å·²åŠ è½½');
            console.log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥ç¼©ç•¥å›¾æ•°æ®');
        });
    </script>
</body>
</html>