<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œä¿å­˜é—®é¢˜è¯Šæ–­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ä¸–ç•Œä¿å­˜é—®é¢˜è¯Šæ–­å·¥å…·</h1>
    
    <div class="section">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
        <div id="systemStatus"></div>
    </div>

    <div class="section">
        <h2>ğŸ” ç”¨æˆ·è®¤è¯çŠ¶æ€</h2>
        <button onclick="checkUserAuth()">æ£€æŸ¥ç”¨æˆ·è®¤è¯</button>
        <div id="userAuthStatus"></div>
    </div>

    <div class="section">
        <h2>ğŸ’¾ æœ¬åœ°å­˜å‚¨æµ‹è¯•</h2>
        <button onclick="testLocalStorage()">æµ‹è¯•æœ¬åœ°å­˜å‚¨</button>
        <div id="localStorageTest"></div>
    </div>

    <div class="section">
        <h2>ğŸŒ Supabase è¿æ¥æµ‹è¯•</h2>
        <button onclick="testSupabaseConnection()">æµ‹è¯• Supabase è¿æ¥</button>
        <div id="supabaseTest"></div>
    </div>

    <div class="section">
        <h2>ğŸ–¼ï¸ å›¾ç‰‡å¤„ç†æµ‹è¯•</h2>
        <button onclick="testImageProcessing()">æµ‹è¯•å›¾ç‰‡å¤„ç†</button>
        <div id="imageProcessingTest"></div>
    </div>

    <div class="section">
        <h2>ğŸ’¾ ä¸–ç•Œä¿å­˜æµç¨‹æµ‹è¯•</h2>
        <button onclick="testWorldSaveFlow()">æµ‹è¯•å®Œæ•´ä¿å­˜æµç¨‹</button>
        <div id="worldSaveTest"></div>
    </div>

    <div class="section">
        <h2>ğŸ”„ åŒæ­¥åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testSyncFunction()">æµ‹è¯•åŒæ­¥åŠŸèƒ½</button>
        <div id="syncTest"></div>
    </div>

    <script type="module">
        // å¯¼å…¥ Supabase å®¢æˆ·ç«¯
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Supabase é…ç½®
        const supabaseUrl = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // æ¨¡æ‹Ÿ UserDataManager
        class MockUserDataManager {
            static async getCurrentUserId() {
                try {
                    // å°è¯•ä» localStorage è·å–ç”¨æˆ·ID
                    let userId = localStorage.getItem('tinylingo_user_id');
                    if (!userId) {
                        // ç”Ÿæˆä¸´æ—¶ç”¨æˆ·ID
                        userId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('tinylingo_user_id', userId);
                    }
                    return userId;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·IDå¤±è´¥:', error);
                    return null;
                }
            }

            static async setUserContext(userId) {
                try {
                    // å°è¯•è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
                    const { error } = await supabase.rpc('set_user_context', { user_id: userId });
                    if (error) {
                        console.warn('è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡å¼‚å¸¸:', error);
                    return false;
                }
            }
        }

        // å…¨å±€å‡½æ•°
        window.checkSystemStatus = async function() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>';
            
            const results = [];
            
            // æ£€æŸ¥ localStorage å¯ç”¨æ€§
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                results.push('<div class="success">âœ… localStorage å¯ç”¨</div>');
            } catch (error) {
                results.push('<div class="error">âŒ localStorage ä¸å¯ç”¨: ' + error.message + '</div>');
            }
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
                results.push('<div class="success">âœ… ç½‘ç»œè¿æ¥æ­£å¸¸</div>');
            } catch (error) {
                results.push('<div class="warning">âš ï¸ ç½‘ç»œè¿æ¥å¯èƒ½æœ‰é—®é¢˜: ' + error.message + '</div>');
            }
            
            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            const features = [
                { name: 'Promise', check: () => typeof Promise !== 'undefined' },
                { name: 'async/await', check: () => true }, // å¦‚æœä»£ç èƒ½è¿è¡Œåˆ°è¿™é‡Œè¯´æ˜æ”¯æŒ
                { name: 'Fetch API', check: () => typeof fetch !== 'undefined' },
                { name: 'ES6 Modules', check: () => true }
            ];
            
            features.forEach(feature => {
                if (feature.check()) {
                    results.push(`<div class="success">âœ… ${feature.name} æ”¯æŒ</div>`);
                } else {
                    results.push(`<div class="error">âŒ ${feature.name} ä¸æ”¯æŒ</div>`);
                }
            });
            
            statusDiv.innerHTML = results.join('');
        };

        window.checkUserAuth = async function() {
            const authDiv = document.getElementById('userAuthStatus');
            authDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€...</div>';
            
            try {
                const userId = await MockUserDataManager.getCurrentUserId();
                const contextSet = await MockUserDataManager.setUserContext(userId);
                
                const results = [
                    `<div class="success">âœ… ç”¨æˆ·ID: ${userId}</div>`,
                    contextSet 
                        ? '<div class="success">âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®æˆåŠŸ</div>'
                        : '<div class="warning">âš ï¸ ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®å¤±è´¥</div>'
                ];
                
                authDiv.innerHTML = results.join('');
            } catch (error) {
                authDiv.innerHTML = `<div class="error">âŒ ç”¨æˆ·è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        };

        window.testLocalStorage = async function() {
            const testDiv = document.getElementById('localStorageTest');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æœ¬åœ°å­˜å‚¨...</div>';
            
            try {
                const userId = await MockUserDataManager.getCurrentUserId();
                const storageKey = `tinylingo_worlds_${userId}`;
                
                // æµ‹è¯•å†™å…¥
                const testData = [{
                    id: 'test_world_' + Date.now(),
                    name: 'æµ‹è¯•ä¸–ç•Œ',
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä¸–ç•Œ',
                    thumbnail: '',
                    wordCount: 0,
                    stickerCount: 0,
                    canvasObjects: [],
                    canvasData: { objects: [], background: null },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }];
                
                localStorage.setItem(storageKey, JSON.stringify(testData));
                
                // æµ‹è¯•è¯»å–
                const savedData = localStorage.getItem(storageKey);
                const parsedData = JSON.parse(savedData);
                
                if (parsedData && parsedData.length === 1 && parsedData[0].name === 'æµ‹è¯•ä¸–ç•Œ') {
                    testDiv.innerHTML = `
                        <div class="success">âœ… æœ¬åœ°å­˜å‚¨æµ‹è¯•æˆåŠŸ</div>
                        <div class="info">å­˜å‚¨é”®: ${storageKey}</div>
                        <div class="info">æ•°æ®å¤§å°: ${savedData.length} å­—ç¬¦</div>
                    `;
                } else {
                    testDiv.innerHTML = '<div class="error">âŒ æœ¬åœ°å­˜å‚¨æ•°æ®ä¸åŒ¹é…</div>';
                }
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                localStorage.removeItem(storageKey);
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        };

        window.testSupabaseConnection = async function() {
            const testDiv = document.getElementById('supabaseTest');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯• Supabase è¿æ¥...</div>';
            
            try {
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                const { data, error } = await supabase.from('user_worlds').select('count').limit(1);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        testDiv.innerHTML = '<div class="warning">âš ï¸ Supabase è¿æ¥æ­£å¸¸ï¼Œä½†å¯èƒ½å­˜åœ¨æƒé™é—®é¢˜</div>';
                    } else {
                        testDiv.innerHTML = `<div class="error">âŒ Supabase è¿æ¥å¤±è´¥: ${error.message}</div>`;
                    }
                } else {
                    testDiv.innerHTML = '<div class="success">âœ… Supabase è¿æ¥æ­£å¸¸</div>';
                }
                
                // æµ‹è¯•ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®
                const userId = await MockUserDataManager.getCurrentUserId();
                const contextResult = await MockUserDataManager.setUserContext(userId);
                
                testDiv.innerHTML += contextResult 
                    ? '<div class="success">âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®æˆåŠŸ</div>'
                    : '<div class="warning">âš ï¸ ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®å¤±è´¥</div>';
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">âŒ Supabase æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
            }
        };

        window.testImageProcessing = async function() {
            const testDiv = document.getElementById('imageProcessingTest');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å›¾ç‰‡å¤„ç†...</div>';
            
            try {
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡ (1x1 åƒç´ çš„çº¢è‰²PNG)
                const testBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
                // æµ‹è¯• Base64 è½¬ Blob
                function base64ToBlob(base64) {
                    const base64Data = base64.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    return new Blob([byteArray], { type: 'image/png' });
                }
                
                const blob = base64ToBlob(testBase64);
                
                if (blob && blob.size > 0) {
                    testDiv.innerHTML = `
                        <div class="success">âœ… å›¾ç‰‡å¤„ç†æµ‹è¯•æˆåŠŸ</div>
                        <div class="info">Blob å¤§å°: ${blob.size} å­—èŠ‚</div>
                        <div class="info">Blob ç±»å‹: ${blob.type}</div>
                    `;
                } else {
                    testDiv.innerHTML = '<div class="error">âŒ å›¾ç‰‡å¤„ç†å¤±è´¥</div>';
                }
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">âŒ å›¾ç‰‡å¤„ç†æµ‹è¯•å¼‚å¸¸: ${error.message}</div>`;
            }
        };

        window.testWorldSaveFlow = async function() {
            const testDiv = document.getElementById('worldSaveTest');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•ä¸–ç•Œä¿å­˜æµç¨‹...</div>';
            
            const results = [];
            
            try {
                // æ­¥éª¤1: å‡†å¤‡æµ‹è¯•æ•°æ®
                const testWorld = {
                    id: 'test_world_' + Date.now(),
                    name: 'æµ‹è¯•ä¸–ç•Œä¿å­˜',
                    description: 'æµ‹è¯•ä¸–ç•Œä¿å­˜æµç¨‹',
                    thumbnail: '',
                    coverUrl: '',
                    previewImage: '',
                    wordCount: 2,
                    stickerCount: 2,
                    likes: 0,
                    favorites: 0,
                    isPublic: false,
                    canvasObjects: [
                        { id: '1', type: 'sticker', name: 'test1', x: 100, y: 100 },
                        { id: '2', type: 'sticker', name: 'test2', x: 200, y: 200 }
                    ],
                    canvasData: { 
                        objects: [
                            { id: '1', type: 'sticker', name: 'test1', x: 100, y: 100 },
                            { id: '2', type: 'sticker', name: 'test2', x: 200, y: 200 }
                        ], 
                        background: null 
                    },
                    selectedBackground: null,
                    tags: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                results.push('<div class="success">âœ… æ­¥éª¤1: æµ‹è¯•æ•°æ®å‡†å¤‡å®Œæˆ</div>');
                
                // æ­¥éª¤2: æµ‹è¯•æœ¬åœ°ä¿å­˜
                const userId = await MockUserDataManager.getCurrentUserId();
                const storageKey = `tinylingo_worlds_${userId}`;
                
                // åŠ è½½ç°æœ‰æ•°æ®
                let worlds = [];
                try {
                    const savedData = localStorage.getItem(storageKey);
                    worlds = savedData ? JSON.parse(savedData) : [];
                } catch (error) {
                    worlds = [];
                }
                
                // æ·»åŠ æµ‹è¯•ä¸–ç•Œ
                worlds.push(testWorld);
                localStorage.setItem(storageKey, JSON.stringify(worlds));
                
                results.push('<div class="success">âœ… æ­¥éª¤2: æœ¬åœ°ä¿å­˜æˆåŠŸ</div>');
                
                // æ­¥éª¤3: éªŒè¯æœ¬åœ°ä¿å­˜
                const savedData = localStorage.getItem(storageKey);
                const parsedWorlds = JSON.parse(savedData);
                const savedWorld = parsedWorlds.find(w => w.id === testWorld.id);
                
                if (savedWorld && savedWorld.name === testWorld.name) {
                    results.push('<div class="success">âœ… æ­¥éª¤3: æœ¬åœ°ä¿å­˜éªŒè¯æˆåŠŸ</div>');
                } else {
                    results.push('<div class="error">âŒ æ­¥éª¤3: æœ¬åœ°ä¿å­˜éªŒè¯å¤±è´¥</div>');
                }
                
                // æ­¥éª¤4: æµ‹è¯• Supabase åŒæ­¥ï¼ˆæ¨¡æ‹Ÿï¼‰
                try {
                    await MockUserDataManager.setUserContext(userId);
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼
                    const userWorld = {
                        user_id: userId,
                        world_id: testWorld.id,
                        name: testWorld.name,
                        description: testWorld.description,
                        thumbnail: testWorld.thumbnail,
                        cover_url: testWorld.coverUrl,
                        preview_image: testWorld.previewImage,
                        word_count: testWorld.wordCount,
                        sticker_count: testWorld.stickerCount,
                        likes: testWorld.likes,
                        favorites: testWorld.favorites,
                        is_public: testWorld.isPublic,
                        canvas_objects: testWorld.canvasObjects,
                        canvas_data: testWorld.canvasData,
                        selected_background: testWorld.selectedBackground ? JSON.stringify(testWorld.selectedBackground) : null,
                        tags: testWorld.tags,
                        last_modified: testWorld.lastModified,
                        is_deleted: false
                    };
                    
                    // å°è¯•æ’å…¥åˆ° Supabase
                    const { error } = await supabase
                        .from('user_worlds')
                        .upsert([userWorld], { onConflict: 'user_id,world_id' });
                    
                    if (error) {
                        results.push(`<div class="warning">âš ï¸ æ­¥éª¤4: Supabase åŒæ­¥å¤±è´¥ - ${error.message}</div>`);
                    } else {
                        results.push('<div class="success">âœ… æ­¥éª¤4: Supabase åŒæ­¥æˆåŠŸ</div>');
                    }
                } catch (syncError) {
                    results.push(`<div class="warning">âš ï¸ æ­¥éª¤4: Supabase åŒæ­¥å¼‚å¸¸ - ${syncError.message}</div>`);
                }
                
                // æ¸…ç†æµ‹è¯•æ•°æ®
                const cleanedWorlds = parsedWorlds.filter(w => w.id !== testWorld.id);
                localStorage.setItem(storageKey, JSON.stringify(cleanedWorlds));
                
                results.push('<div class="info">ğŸ§¹ æµ‹è¯•æ•°æ®å·²æ¸…ç†</div>');
                
            } catch (error) {
                results.push(`<div class="error">âŒ ä¸–ç•Œä¿å­˜æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}</div>`);
                console.error('ä¸–ç•Œä¿å­˜æµç¨‹æµ‹è¯•è¯¦ç»†é”™è¯¯:', error);
            }
            
            testDiv.innerHTML = results.join('');
        };

        window.testSyncFunction = async function() {
            const testDiv = document.getElementById('syncTest');
            testDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•åŒæ­¥åŠŸèƒ½...</div>';
            
            try {
                const userId = await MockUserDataManager.getCurrentUserId();
                
                // æµ‹è¯•ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®
                const contextSet = await MockUserDataManager.setUserContext(userId);
                
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                const { data, error } = await supabase
                    .from('user_worlds')
                    .select('count')
                    .eq('user_id', userId)
                    .limit(1);
                
                const results = [
                    `<div class="info">ç”¨æˆ·ID: ${userId}</div>`,
                    contextSet 
                        ? '<div class="success">âœ… ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®æˆåŠŸ</div>'
                        : '<div class="warning">âš ï¸ ç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®å¤±è´¥</div>',
                    error 
                        ? `<div class="warning">âš ï¸ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`
                        : '<div class="success">âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸</div>'
                ];
                
                testDiv.innerHTML = results.join('');
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">âŒ åŒæ­¥åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>