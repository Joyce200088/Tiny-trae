<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世界保存问题诊断</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>🔍 世界保存问题诊断工具</h1>
    
    <div class="section">
        <h2>📊 系统状态检查</h2>
        <button onclick="checkSystemStatus()">检查系统状态</button>
        <div id="systemStatus"></div>
    </div>

    <div class="section">
        <h2>🔐 用户认证状态</h2>
        <button onclick="checkUserAuth()">检查用户认证</button>
        <div id="userAuthStatus"></div>
    </div>

    <div class="section">
        <h2>💾 本地存储测试</h2>
        <button onclick="testLocalStorage()">测试本地存储</button>
        <div id="localStorageTest"></div>
    </div>

    <div class="section">
        <h2>🌐 Supabase 连接测试</h2>
        <button onclick="testSupabaseConnection()">测试 Supabase 连接</button>
        <div id="supabaseTest"></div>
    </div>

    <div class="section">
        <h2>🖼️ 图片处理测试</h2>
        <button onclick="testImageProcessing()">测试图片处理</button>
        <div id="imageProcessingTest"></div>
    </div>

    <div class="section">
        <h2>💾 世界保存流程测试</h2>
        <button onclick="testWorldSaveFlow()">测试完整保存流程</button>
        <div id="worldSaveTest"></div>
    </div>

    <div class="section">
        <h2>🔄 同步功能测试</h2>
        <button onclick="testSyncFunction()">测试同步功能</button>
        <div id="syncTest"></div>
    </div>

    <script type="module">
        // 导入 Supabase 客户端
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Supabase 配置
        const supabaseUrl = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // 模拟 UserDataManager
        class MockUserDataManager {
            static async getCurrentUserId() {
                try {
                    // 尝试从 localStorage 获取用户ID
                    let userId = localStorage.getItem('tinylingo_user_id');
                    if (!userId) {
                        // 生成临时用户ID
                        userId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('tinylingo_user_id', userId);
                    }
                    return userId;
                } catch (error) {
                    console.error('获取用户ID失败:', error);
                    return null;
                }
            }

            static async setUserContext(userId) {
                try {
                    // 尝试设置用户上下文
                    const { error } = await supabase.rpc('set_user_context', { user_id: userId });
                    if (error) {
                        console.warn('设置用户上下文失败:', error);
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('设置用户上下文异常:', error);
                    return false;
                }
            }
        }

        // 全局函数
        window.checkSystemStatus = async function() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="info">正在检查系统状态...</div>';
            
            const results = [];
            
            // 检查 localStorage 可用性
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                results.push('<div class="success">✅ localStorage 可用</div>');
            } catch (error) {
                results.push('<div class="error">❌ localStorage 不可用: ' + error.message + '</div>');
            }
            
            // 检查网络连接
            try {
                const response = await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
                results.push('<div class="success">✅ 网络连接正常</div>');
            } catch (error) {
                results.push('<div class="warning">⚠️ 网络连接可能有问题: ' + error.message + '</div>');
            }
            
            // 检查浏览器兼容性
            const features = [
                { name: 'Promise', check: () => typeof Promise !== 'undefined' },
                { name: 'async/await', check: () => true }, // 如果代码能运行到这里说明支持
                { name: 'Fetch API', check: () => typeof fetch !== 'undefined' },
                { name: 'ES6 Modules', check: () => true }
            ];
            
            features.forEach(feature => {
                if (feature.check()) {
                    results.push(`<div class="success">✅ ${feature.name} 支持</div>`);
                } else {
                    results.push(`<div class="error">❌ ${feature.name} 不支持</div>`);
                }
            });
            
            statusDiv.innerHTML = results.join('');
        };

        window.checkUserAuth = async function() {
            const authDiv = document.getElementById('userAuthStatus');
            authDiv.innerHTML = '<div class="info">正在检查用户认证状态...</div>';
            
            try {
                const userId = await MockUserDataManager.getCurrentUserId();
                const contextSet = await MockUserDataManager.setUserContext(userId);
                
                const results = [
                    `<div class="success">✅ 用户ID: ${userId}</div>`,
                    contextSet 
                        ? '<div class="success">✅ 用户上下文设置成功</div>'
                        : '<div class="warning">⚠️ 用户上下文设置失败</div>'
                ];
                
                authDiv.innerHTML = results.join('');
            } catch (error) {
                authDiv.innerHTML = `<div class="error">❌ 用户认证检查失败: ${error.message}</div>`;
            }
        };

        window.testLocalStorage = async function() {
            const testDiv = document.getElementById('localStorageTest');
            testDiv.innerHTML = '<div class="info">正在测试本地存储...</div>';
            
            try {
                const userId = await MockUserDataManager.getCurrentUserId();
                const storageKey = `tinylingo_worlds_${userId}`;
                
                // 测试写入
                const testData = [{
                    id: 'test_world_' + Date.now(),
                    name: '测试世界',
                    description: '这是一个测试世界',
                    thumbnail: '',
                    wordCount: 0,
                    stickerCount: 0,
                    canvasObjects: [],
                    canvasData: { objects: [], background: null },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }];
                
                localStorage.setItem(storageKey, JSON.stringify(testData));
                
                // 测试读取
                const savedData = localStorage.getItem(storageKey);
                const parsedData = JSON.parse(savedData);
                
                if (parsedData && parsedData.length === 1 && parsedData[0].name === '测试世界') {
                    testDiv.innerHTML = `
                        <div class="success">✅ 本地存储测试成功</div>
                        <div class="info">存储键: ${storageKey}</div>
                        <div class="info">数据大小: ${savedData.length} 字符</div>
                    `;
                } else {
                    testDiv.innerHTML = '<div class="error">❌ 本地存储数据不匹配</div>';
                }
                
                // 清理测试数据
                localStorage.removeItem(storageKey);
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ 本地存储测试失败: ${error.message}</div>`;
            }
        };

        window.testSupabaseConnection = async function() {
            const testDiv = document.getElementById('supabaseTest');
            testDiv.innerHTML = '<div class="info">正在测试 Supabase 连接...</div>';
            
            try {
                // 测试基本连接
                const { data, error } = await supabase.from('user_worlds').select('count').limit(1);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        testDiv.innerHTML = '<div class="warning">⚠️ Supabase 连接正常，但可能存在权限问题</div>';
                    } else {
                        testDiv.innerHTML = `<div class="error">❌ Supabase 连接失败: ${error.message}</div>`;
                    }
                } else {
                    testDiv.innerHTML = '<div class="success">✅ Supabase 连接正常</div>';
                }
                
                // 测试用户上下文设置
                const userId = await MockUserDataManager.getCurrentUserId();
                const contextResult = await MockUserDataManager.setUserContext(userId);
                
                testDiv.innerHTML += contextResult 
                    ? '<div class="success">✅ 用户上下文设置成功</div>'
                    : '<div class="warning">⚠️ 用户上下文设置失败</div>';
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ Supabase 测试异常: ${error.message}</div>`;
            }
        };

        window.testImageProcessing = async function() {
            const testDiv = document.getElementById('imageProcessingTest');
            testDiv.innerHTML = '<div class="info">正在测试图片处理...</div>';
            
            try {
                // 创建一个简单的测试图片 (1x1 像素的红色PNG)
                const testBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
                // 测试 Base64 转 Blob
                function base64ToBlob(base64) {
                    const base64Data = base64.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    return new Blob([byteArray], { type: 'image/png' });
                }
                
                const blob = base64ToBlob(testBase64);
                
                if (blob && blob.size > 0) {
                    testDiv.innerHTML = `
                        <div class="success">✅ 图片处理测试成功</div>
                        <div class="info">Blob 大小: ${blob.size} 字节</div>
                        <div class="info">Blob 类型: ${blob.type}</div>
                    `;
                } else {
                    testDiv.innerHTML = '<div class="error">❌ 图片处理失败</div>';
                }
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ 图片处理测试异常: ${error.message}</div>`;
            }
        };

        window.testWorldSaveFlow = async function() {
            const testDiv = document.getElementById('worldSaveTest');
            testDiv.innerHTML = '<div class="info">正在测试世界保存流程...</div>';
            
            const results = [];
            
            try {
                // 步骤1: 准备测试数据
                const testWorld = {
                    id: 'test_world_' + Date.now(),
                    name: '测试世界保存',
                    description: '测试世界保存流程',
                    thumbnail: '',
                    coverUrl: '',
                    previewImage: '',
                    wordCount: 2,
                    stickerCount: 2,
                    likes: 0,
                    favorites: 0,
                    isPublic: false,
                    canvasObjects: [
                        { id: '1', type: 'sticker', name: 'test1', x: 100, y: 100 },
                        { id: '2', type: 'sticker', name: 'test2', x: 200, y: 200 }
                    ],
                    canvasData: { 
                        objects: [
                            { id: '1', type: 'sticker', name: 'test1', x: 100, y: 100 },
                            { id: '2', type: 'sticker', name: 'test2', x: 200, y: 200 }
                        ], 
                        background: null 
                    },
                    selectedBackground: null,
                    tags: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                
                results.push('<div class="success">✅ 步骤1: 测试数据准备完成</div>');
                
                // 步骤2: 测试本地保存
                const userId = await MockUserDataManager.getCurrentUserId();
                const storageKey = `tinylingo_worlds_${userId}`;
                
                // 加载现有数据
                let worlds = [];
                try {
                    const savedData = localStorage.getItem(storageKey);
                    worlds = savedData ? JSON.parse(savedData) : [];
                } catch (error) {
                    worlds = [];
                }
                
                // 添加测试世界
                worlds.push(testWorld);
                localStorage.setItem(storageKey, JSON.stringify(worlds));
                
                results.push('<div class="success">✅ 步骤2: 本地保存成功</div>');
                
                // 步骤3: 验证本地保存
                const savedData = localStorage.getItem(storageKey);
                const parsedWorlds = JSON.parse(savedData);
                const savedWorld = parsedWorlds.find(w => w.id === testWorld.id);
                
                if (savedWorld && savedWorld.name === testWorld.name) {
                    results.push('<div class="success">✅ 步骤3: 本地保存验证成功</div>');
                } else {
                    results.push('<div class="error">❌ 步骤3: 本地保存验证失败</div>');
                }
                
                // 步骤4: 测试 Supabase 同步（模拟）
                try {
                    await MockUserDataManager.setUserContext(userId);
                    
                    // 转换数据格式
                    const userWorld = {
                        user_id: userId,
                        world_id: testWorld.id,
                        name: testWorld.name,
                        description: testWorld.description,
                        thumbnail: testWorld.thumbnail,
                        cover_url: testWorld.coverUrl,
                        preview_image: testWorld.previewImage,
                        word_count: testWorld.wordCount,
                        sticker_count: testWorld.stickerCount,
                        likes: testWorld.likes,
                        favorites: testWorld.favorites,
                        is_public: testWorld.isPublic,
                        canvas_objects: testWorld.canvasObjects,
                        canvas_data: testWorld.canvasData,
                        selected_background: testWorld.selectedBackground ? JSON.stringify(testWorld.selectedBackground) : null,
                        tags: testWorld.tags,
                        last_modified: testWorld.lastModified,
                        is_deleted: false
                    };
                    
                    // 尝试插入到 Supabase
                    const { error } = await supabase
                        .from('user_worlds')
                        .upsert([userWorld], { onConflict: 'user_id,world_id' });
                    
                    if (error) {
                        results.push(`<div class="warning">⚠️ 步骤4: Supabase 同步失败 - ${error.message}</div>`);
                    } else {
                        results.push('<div class="success">✅ 步骤4: Supabase 同步成功</div>');
                    }
                } catch (syncError) {
                    results.push(`<div class="warning">⚠️ 步骤4: Supabase 同步异常 - ${syncError.message}</div>`);
                }
                
                // 清理测试数据
                const cleanedWorlds = parsedWorlds.filter(w => w.id !== testWorld.id);
                localStorage.setItem(storageKey, JSON.stringify(cleanedWorlds));
                
                results.push('<div class="info">🧹 测试数据已清理</div>');
                
            } catch (error) {
                results.push(`<div class="error">❌ 世界保存流程测试失败: ${error.message}</div>`);
                console.error('世界保存流程测试详细错误:', error);
            }
            
            testDiv.innerHTML = results.join('');
        };

        window.testSyncFunction = async function() {
            const testDiv = document.getElementById('syncTest');
            testDiv.innerHTML = '<div class="info">正在测试同步功能...</div>';
            
            try {
                const userId = await MockUserDataManager.getCurrentUserId();
                
                // 测试用户上下文设置
                const contextSet = await MockUserDataManager.setUserContext(userId);
                
                // 测试数据库连接
                const { data, error } = await supabase
                    .from('user_worlds')
                    .select('count')
                    .eq('user_id', userId)
                    .limit(1);
                
                const results = [
                    `<div class="info">用户ID: ${userId}</div>`,
                    contextSet 
                        ? '<div class="success">✅ 用户上下文设置成功</div>'
                        : '<div class="warning">⚠️ 用户上下文设置失败</div>',
                    error 
                        ? `<div class="warning">⚠️ 数据库查询失败: ${error.message}</div>`
                        : '<div class="success">✅ 数据库连接正常</div>'
                ];
                
                testDiv.innerHTML = results.join('');
                
            } catch (error) {
                testDiv.innerHTML = `<div class="error">❌ 同步功能测试失败: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>