# 更新日志

## 2025-01-27 - 实现真实用户认证系统和页面访问控制

### 修改文件
- `src/components/auth/LoginModal_v1.tsx` (新建)
- `src/lib/supabase/userClient_v2.ts` (新建)
- `src/components/auth/AuthProvider.tsx`
- `src/app/my-stickers/page.tsx`
- `src/app/dictation/page.tsx`
- `src/app/explore/page.tsx`
- `src/app/create-world/page.tsx`

### 修改内容
1. **创建登录模态框组件**：
   - 新建 `LoginModal_v1.tsx`，提供用户注册和登录功能
   - 包含表单验证、错误处理、密码可见性切换等功能
   - 集成 `AuthProvider` 进行用户认证

2. **升级用户数据管理器**：
   - 新建 `userClient_v2.ts`，移除临时用户ID支持
   - 只支持真实认证用户的数据操作
   - 确保数据安全性和用户隔离

3. **更新认证提供者**：
   - 修改 `AuthProvider.tsx`，只为认证用户初始化 `UserDataManager`
   - 添加用户登录时的数据库用户记录创建
   - 优化认证状态变化处理逻辑

4. **添加页面访问控制**：
   - 为 `my-stickers`、`dictation`、`explore` 页面添加 `AuthGuard` 保护
   - 更新 `create-world` 页面使用新的 `UserDataManager`
   - 确保核心功能需要用户登录才能访问

### 修改原因
- 移除临时用户ID机制，要求用户必须注册/登录才能使用应用
- 提高数据安全性，确保用户数据隔离和持久化
- 符合现代Web应用的用户管理最佳实践
- 为后续功能扩展（如数据同步、社交功能）奠定基础

### 修改后的影响
- **正面影响**：
  - 用户数据更加安全，真正实现用户隔离
  - 支持跨设备数据同步和持久化
  - 为社交功能和高级特性提供基础
  - 提升应用的专业性和可信度
- **用户体验变化**：
  - 首次使用需要注册账户
  - 核心功能需要登录后才能访问
  - 数据在登录后永久保存，不会丢失

## 2025-10-08 - 页面切换后保存功能失效问题修复

### 修改文件
- `src/lib/supabase/userClient.ts`

### 修改内容
1. **优化用户ID缓存策略**：
   - 在 `getCurrentUserId()` 方法中添加了从 `localStorage` 恢复用户ID的逻辑
   - 调整了用户ID获取的优先级顺序：缓存 → localStorage → Supabase认证 → 生成临时ID

### 修改原因
- 发现页面切换后保存功能失效，根因是静态变量 `currentUserId` 在页面切换时被重置
- 用户在不同页面间切换时，会生成不同的临时用户ID（如 `temp_1759926722142_dplphl8hg` vs `temp_1759926869229_r6ulnooqx`）
- 导致数据在 `localStorage` 中按不同用户ID存储，造成数据隔离

### 修改后的影响
- ✅ 页面切换后用户ID保持一致，避免数据隔离
- ✅ 保存功能在页面切换后仍能正常工作
- ✅ 提升用户体验，确保数据持久性
- ⚠️ 需要测试多标签页场景下的用户ID一致性

## 2025-10-08 12:30:00 - 修复世界数据不匹配问题

### 修改文件
- `src/app/create-world/page.tsx`

### 修改内容
1. **增强错误处理机制**：在 `saveWorldData` 函数中添加了 try-catch 错误处理
2. **自动降级策略**：当 `updateWorld` 失败（世界不存在）时，自动转为 `addWorld` 模式
3. **动态ID重新生成**：失败时重新生成世界ID并更新状态

### 修改原因
- 解决"未找到ID为xxx的世界"错误，该错误导致保存失败并触发重试机制
- 前端状态与localStorage数据不同步，导致尝试更新不存在的世界
- 提高保存操作的健壮性和用户体验

### 修改后的影响
- **正面影响**：
  - 消除了"世界不存在"错误，保存操作更加稳定
  - 自动处理数据不一致情况，无需用户干预
  - 减少了保存失败和重试的频率
- **潜在风险**：
  - 可能会创建重复的世界数据（如果ID生成逻辑有问题）
  - 需要监控新ID生成的唯一性

## 2025-10-08 12:20:00 - 修复保存过程递归调用问题

### 修改文件
- `src/lib/supabase/userClient.ts`

### 修改内容
1. **优化getCurrentUserId方法的缓存机制**
   - 添加`supabaseAuthChecked`和`supabaseAuthFailed`静态属性，避免重复调用`supabase.auth.getUser()`
   - 当Supabase认证失败或超时后，后续调用直接跳过认证检查，使用缓存的用户ID
   - 简化用户ID获取逻辑，直接从localStorage获取或生成新的临时ID

2. **解决递归调用问题**
   - 防止`WorldDataUtils.updateWorld` → `loadWorldData` → `getCurrentUserId`的循环调用
   - 避免因重复超时导致的保存重试机制被意外触发

### 修改原因
- 保存过程中`getCurrentUserId`被多次调用，每次都触发5秒超时，导致保存重试机制被激活
- 递归调用导致多次保存操作，影响性能和用户体验

### 修改后的影响
- 保存过程更加稳定，不会因为网络问题导致递归重试
- 减少不必要的Supabase认证调用，提升性能
- 用户ID获取更加可靠，优先使用缓存避免重复超时

## 2025-10-08 12:15:00 - 修复Supabase认证超时问题

### 修改文件
- `src/lib/supabase/userClient.ts`

### 修改内容
1. **添加超时机制**
   - 在`getCurrentUserId`和`initializeUser`方法中为`supabase.auth.getUser()`调用添加5秒超时
   - 使用`Promise.race`实现超时控制，防止无限等待

2. **改进错误处理**
   - 超时后回退到使用缓存的用户ID或localStorage中的临时用户ID
   - 添加详细的调试日志，便于问题排查

### 修改原因
- `supabase.auth.getUser()`调用在某些网络环境下会无限挂起，导致保存过程中断
- 用户反馈保存功能在特定情况下无响应

### 修改后的影响
- 保存功能在网络不稳定时仍能正常工作
- 提升用户体验，避免保存过程卡死
- 保持数据一致性，确保用户操作不会丢失

## 2025-10-08 11:30:00 - 增强调试日志系统

### 修改文件
- `src/lib/supabase/userClient.ts`
- `src/utils/worldDataUtils.ts`
- `src/app/create-world/page.tsx`

### 修改内容
1. **用户ID获取过程调试**
   - 在`getCurrentUserId`和`initializeUser`方法中添加详细的执行步骤日志
   - 记录缓存状态、Supabase认证状态、localStorage操作等关键信息

2. **保存过程调试**
   - 在`saveWorldData`函数中添加数据摘要、时间戳等调试信息
   - 在`WorldDataUtils.updateWorld`中添加执行步骤跟踪

### 修改原因
- 用户反馈保存功能异常，需要详细的调试信息定位问题
- 现有日志不足以追踪复杂的异步操作流程

### 修改后的影响
- 便于开发者快速定位保存相关问题
- 提供详细的执行轨迹，有助于性能优化
- 不影响生产环境性能（调试日志可通过环境变量控制）

## 2025-01-08 - 修复Supabase认证超时导致保存中断问题

### 修改的文件
- `src/lib/supabase/userClient.ts`

### 修改的内容
1. **添加Supabase认证超时机制**：
   - 在 `getCurrentUserId` 和 `initializeUser` 方法中添加5秒超时机制
   - 使用 `Promise.race` 防止 `supabase.auth.getUser()` 无限等待
   - 超时后自动降级使用缓存或localStorage中的用户ID

### 为什么要修改
通过调试日志发现保存过程在调用 `getCurrentUserId` 后中断：
- `supabase.auth.getUser()` 调用后没有返回，导致整个保存流程挂起
- 用户已认证但认证检查过程可能因网络或其他原因超时
- 需要添加超时机制确保保存流程能够继续执行

### 修改后的影响
- 防止Supabase认证检查超时导致的保存流程中断
- 确保在网络不稳定时仍能使用缓存的用户ID进行保存
- 提高应用的健壮性和用户体验
- 保持向后兼容性，不影响正常的认证流程

## 2025-01-08 - 调试用户ID获取流程和保存功能

### 修改的文件
- `src/lib/supabase/userClient.ts`
- `src/utils/worldDataUtils.ts`
- `src/app/create-world/page.tsx`

### 修改的内容
1. **增强用户ID获取流程的调试日志**：
   - 在 `getCurrentUserId` 方法中添加详细的执行步骤日志
   - 在 `initializeUser` 方法中添加localStorage操作的详细日志
   - 增加对Supabase认证用户获取过程的调试信息

2. **增强保存流程的调试日志**：
   - 在 `WorldDataUtils.addWorld` 和 `updateWorld` 方法中添加详细的执行日志
   - 在 `create-world/page.tsx` 的保存流程中添加更多调试信息
   - 增加对保存过程各个步骤的时间戳记录

### 为什么要修改
用户反馈切换标签页后保存功能失效，日志显示：
- 保存过程在统计信息后中断，没有显示成功或失败日志
- UserMenu显示 `localStorage currentUserId` 为 null，但用户已认证
- 需要详细的调试信息来定位问题根源

### 修改后的影响
- 提供更详细的用户ID获取和保存流程日志
- 帮助识别切换标签页后用户上下文丢失的具体原因
- 便于调试和修复保存功能中断的问题
- 不影响现有功能的正常运行

## 2025-01-08 - Supabase RLS策略修复（临时用户ID支持）

### 修改的文件
- `fix-user-sync-status-rls_v1.sql` (新增)

### 修改的内容
- 修复 `user_sync_status` 表的RLS策略以支持临时用户ID
- 更新策略同时支持JWT认证用户和以'temp_'开头的临时用户ID
- 解决临时用户访问同步状态表时的406错误

### 为什么要修改
- 原RLS策略只支持JWT认证用户，临时用户ID无法访问user_sync_status表
- 导致useAutoSync中的getSyncStatus调用失败，返回406 (Not Acceptable)错误
- 影响数据同步功能的正常运行

### 修改后的影响
- 临时用户ID可以正常访问user_sync_status表
- 数据同步功能恢复正常
- 保持安全性，只允许用户访问自己的同步状态
- 向后兼容JWT认证用户

### 注意事项
- 需要在Supabase数据库中执行SQL脚本
- 执行后需要测试临时用户ID的同步功能

---

## 2025-01-08 - 修复切换标签页后保存功能失效问题

### 修改的文件
- `src/app/create-world/page.tsx`

### 修改的内容
1. **添加页面可见性监听器**：
   - 在 `useEffect` 中添加 `visibilitychange` 事件监听器
   - 当页面重新变为可见时，重新初始化用户上下文
   - 添加事件监听器的清理函数

### 为什么要修改
用户反馈切换到其他标签页后返回，保存功能失效。分析发现：
- 页面变为不可见时，用户上下文可能丢失
- 返回页面时没有重新初始化用户上下文
- 导致保存时无法获取正确的用户ID

### 修改后的影响
- 切换标签页后返回时自动重新初始化用户上下文
- 确保保存功能在任何情况下都能正常工作
- 提高应用的稳定性和用户体验
- 不影响其他功能的正常运行

本文档记录了 TinyLingo 项目的所有重要更改。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## 2024-12-28 - 用户数据刷新循环修复

### 修改的文件
1. `src/components/auth/UserMenu.tsx`
2. `src/components/auth/AuthProvider.tsx`
3. `src/app/create-world/page.tsx`

### 修改内容

#### UserMenu.tsx
- **优化定期刷新频率**：将用户数据刷新间隔从30秒调整为5分钟（300000毫秒），减少频繁的刷新日志
- **保留手动刷新功能**：用户仍可通过菜单手动触发数据刷新

#### AuthProvider.tsx  
- **减少日志输出**：简化 refreshUser 函数中的控制台日志，避免过多的调试信息

#### create-world/page.tsx
- **修复 handleObjectChange 函数**：确保在更新画布对象属性时保留 stickerData 字段，防止贴纸数据丢失
- **添加调试日志**：增加 stickerData 状态监控，便于问题排查

### 修改原因
1. **用户数据刷新循环**：切换页面后返回时出现频繁的"定期刷新用户数据"日志，每30秒触发一次，影响用户体验
2. **保存功能不稳定**：第二次保存时出现静默失败，原因是 stickerData 在对象更新过程中丢失，导致 stickerCount 为0
3. **日志信息过多**：详细的用户数据日志在生产环境中不必要，增加控制台噪音

### 修改后的影响
1. **减少刷新频率**：用户数据刷新间隔从30秒延长到5分钟，显著减少日志输出
2. **保存功能稳定**：修复 stickerData 丢失问题，确保连续多次保存都能正常工作
3. **用户体验改善**：减少不必要的日志输出，保持控制台清洁
4. **保持功能完整**：手动刷新和自动刷新机制仍然可用，只是频率更合理

### 技术细节
- 定期刷新间隔：30秒 → 5分钟（300000毫秒）
- handleObjectChange 函数增加 stickerData 保护逻辑
- 简化 refreshUser 函数的日志输出，保留错误日志

## 2024-12-28 - 用户认证和数据同步修复

### 修改的文件
1. `src/components/auth/AuthProvider.tsx`
2. `src/components/auth/UserMenu.tsx`

### 修改内容

#### AuthProvider.tsx
- **增强 signOut 函数**：添加详细的错误处理和调试日志，确保注销过程的每个步骤都有记录
- **修复 refreshUser 函数**：同时获取 Supabase Auth 用户和自定义用户表数据，合并到 user_metadata 中
- **改进用户数据同步**：确保数据库中的用户名修改能及时反映到前端显示

#### UserMenu.tsx  
- **增强注销错误处理**：在 handleSignOut 中添加 try-catch 块，提供用户友好的错误提示
- **添加定期刷新机制**：每30秒自动刷新用户数据，确保数据库修改能及时同步
- **新增手动刷新选项**：在用户菜单中添加"刷新用户数据"按钮，允许用户手动触发数据同步
- **优化刷新触发条件**：监听 display_name 变化，确保用户名更新后立即刷新

### 修改原因
1. **注销功能失效**：原有注销逻辑缺乏错误处理，网络问题时无法正确反馈给用户
2. **用户数据不同步**：refreshUser 函数只获取 Auth 用户数据，忽略了自定义用户表中的最新信息
3. **数据库修改不反映**：缺乏主动刷新机制，用户在数据库中修改用户名后前端无法及时更新

### 修改后的影响
1. **注销功能稳定**：增加错误处理和调试信息，便于排查问题
2. **数据同步及时**：通过定期刷新和手动刷新，确保前端显示与数据库保持一致
3. **用户体验改善**：提供明确的操作反馈和手动控制选项
4. **调试能力增强**：详细的控制台日志有助于问题定位和解决

### 技术细节
- 使用 `setInterval` 实现定期数据刷新（30秒间隔）
- 通过 `useEffect` 监听用户状态变化，自动触发数据同步
- 在 `refreshUser` 中查询自定义用户表，将结果合并到 `user_metadata`
- 添加 RefreshCw 图标的手动刷新按钮，提升用户控制体验

## 2025-01-27

### 修复标签页切换后保存功能失效问题

**修改文件：**
- `src/app/create-world/page.tsx`

**修改内容：**
1. 在 `useEffect` 中添加页面可见性变化监听器 (`visibilitychange`)
2. 当页面重新可见时，自动重新初始化用户上下文 (`UserDataManager.initializeUser`)
3. 添加相应的调试日志，便于跟踪用户上下文状态
4. 在 `useEffect` 清理函数中移除事件监听器

**修改原因：**
用户报告在浏览器标签页之间切换后，返回 create-world 页面时保存功能失效，且控制台不再显示 `getCurrentUserId` 和 `setUserContextInternal` 等关键日志。分析发现这是因为标签页切换可能导致用户上下文丢失。

**修改后的影响：**
- 页面在重新获得焦点时会自动重新初始化用户上下文
- 保存功能在标签页切换后应能正常工作
- 增加了调试日志，便于监控用户上下文状态变化
- 提升了应用的稳定性和用户体验

---

## [未发布]

### 新功能
- **用户认证状态显示修复** (2025-01-27)
  - 修改文件：`src/components/auth/UserMenu.tsx`
  - 修改内容：在 `getUserDisplayName()` 和 `getUserInitial()` 函数中添加认证状态检查，确保未登录时不显示用户名和头像字母；增强调试信息输出
  - 修改原因：用户反馈导航栏显示用户名但认证状态为 `false`，存在逻辑不一致问题
  - 修改影响：未登录用户将看到"登录"按钮而不是用户头像，认证状态与UI显示保持一致

- **缩略图弹窗优化** (2025-01-27)
  - 修改文件：`src/components/WorldsGrid.tsx`
  - 修改内容：移除缩略图加载失败时的toast弹窗提示，改为静默处理
  - 修改原因：用户反馈弹窗提示过于频繁，影响用户体验
  - 修改影响：缩略图加载失败时不再显示弹窗，只在控制台记录错误信息，提升用户体验

- **手动保存功能** (2025-01-27)
  - 修改文件：`src/app/create-world/page.tsx`, `src/components/TopBar.tsx`
  - 修改内容：实现手动保存功能，包括禁用自动保存、添加手动保存按钮、脏状态管理、页面卸载保护、离线状态检测、增强日志记录
  - 修改原因：用户需要更好地控制保存时机，避免意外数据覆盖
  - 修改影响：用户可以手动控制保存时机，提升数据安全性和用户体验

### 新增
- **背景移除故障排除工具包** (2025-01-27)
  - 文件：`BACKGROUND_REMOVAL_TROUBLESHOOTING.md` - 详细的故障排除指南
  - 文件：`scripts/test-background-removal.ps1` - 背景去除功能测试脚本
  - 文件：`scripts/start-services.ps1` - 服务启动管理脚本
  - 文件：`scripts/quick-fix.ps1` - 一键快速修复脚本
  - 修改原因：解决AI生成贴纸背景去除功能失效问题，提供完整的诊断和修复工具
  - 影响：用户可以快速诊断和修复背景去除功能问题，提高开发和维护效率

### 已完成
- 🧹 **项目清理** (2024-01-15)
  - 删除所有调试和测试HTML文件（40+个文件）
  - 清理临时SQL脚本和调试文件（20+个文件）
  - 删除测试图片和Python脚本
  - 保留必要的配置和文档文件
  - 优化项目结构，提升代码库整洁度

### 计划中
- 多语言界面支持
- 用户认证系统
- 云端数据同步
- 移动端适配优化
- 社区功能（分享、评论、点赞）

## [1.0.0] - 2024-01-15

### 新增
- 🎉 **初始版本发布**
- 🏠 **主页功能**
  - 精美的英雄区域展示
  - 世界卡片网格浏览
  - 快速导航菜单
- 🔍 **探索页面**
  - 搜索和发现功能
  - 瀑布流布局
  - 分类标签筛选
- 🎯 **我的贴纸管理**
  - 贴纸收藏系统
  - 已收集/未收集分类
  - 批量操作功能
  - 搜索和筛选
- 🌍 **我的世界管理**
  - 个人世界管理
  - 世界创建和编辑
  - 统计和排序功能
- ✨ **创建世界编辑器**
  - 基于 react-konva 的强大画布编辑器
  - 拖拽式贴纸放置
  - 背景选择和自定义
  - 实时预览和保存
  - 多层级对象管理
- 🔧 **核心算法**
  - BFS 分割算法实现
  - 连通组件检测
  - 透明像素处理
  - 可配置的容差和最小面积
- 🎵 **TTS 系统**
  - 多语言文本转语音
  - 语音参数控制（语速、音调）
  - 冷却机制防止滥用
  - 音频缓存优化
- 🔌 **完整的 API 系统**
  - 文件上传和背景移除 API
  - AI 物体识别 API
  - 贴纸库管理 API
  - 世界管理 API
  - 文本转语音 API
- 🐍 **Python 微服务**
  - FastAPI 后端服务
  - rembg 智能背景移除
  - RESTful API 接口
  - 错误处理和验证
- 🎨 **现代化 UI/UX**
  - 响应式设计
  - Tailwind CSS 样式系统
  - 流畅的动画效果
  - 直观的用户界面

### 技术特性
- **前端框架**: Next.js 15 + TypeScript
- **样式系统**: Tailwind CSS
- **画布库**: React Konva
- **后端服务**: Python FastAPI
- **AI 功能**: rembg 背景移除
- **图标库**: Lucide React
- **开发工具**: ESLint + Prettier

### 性能优化
- 图片懒加载和优化
- 代码分割和动态导入
- API 响应缓存
- 组件级别的性能优化

### 安全特性
- 文件上传验证
- API 限流保护
- 输入验证和清理
- CORS 安全配置

## [0.9.0] - 2024-01-10

### 新增
- 🎨 画布编辑器基础功能
- 📁 项目基础架构搭建
- 🔧 开发环境配置

### 修复
- 修复初始化配置问题
- 解决依赖冲突

## [0.8.0] - 2024-01-05

### 新增
- 🏗️ 项目初始化
- 📋 基础页面结构
- 🎯 核心组件开发

### 技术债务
- 需要添加测试覆盖
- 需要完善错误处理
- 需要优化性能

## 版本说明

### 版本号规则
- **主版本号 (MAJOR)**: 不兼容的 API 修改
- **次版本号 (MINOR)**: 向下兼容的功能性新增
- **修订号 (PATCH)**: 向下兼容的问题修正

### 更改类型
- **新增 (Added)**: 新功能
- **修改 (Changed)**: 对现有功能的修改
- **弃用 (Deprecated)**: 即将移除的功能
- **移除 (Removed)**: 已移除的功能
- **修复 (Fixed)**: 任何 bug 修复
- **安全 (Security)**: 安全相关的修复

## 贡献者

感谢所有为 TinyLingo 项目做出贡献的开发者：

- [@yourusername](https://github.com/yourusername) - 项目创建者和主要维护者

## 支持

如果您在使用过程中遇到问题，请：

1. 查看 [文档](README.md)
2. 搜索 [已知问题](https://github.com/yourusername/tinylingo/issues)
3. 创建 [新问题](https://github.com/yourusername/tinylingo/issues/new)

---

**TinyLingo** - 让英语学习变得有趣和互动！ 🌟