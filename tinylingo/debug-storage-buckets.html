<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase å­˜å‚¨æ¡¶è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #2563eb;
            margin-top: 0;
        }
        .log-area {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .button:hover {
            background-color: #1d4ed8;
        }
        .button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .config-display {
            background-color: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 10px;
        }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Supabase å­˜å‚¨æ¡¶è°ƒè¯•å·¥å…·</h1>
        
        <!-- é…ç½®æ˜¾ç¤º -->
        <div class="section">
            <h2>ğŸ“‹ å½“å‰é…ç½®</h2>
            <div class="config-display" id="configDisplay">
                æ­£åœ¨åŠ è½½é…ç½®...
            </div>
        </div>

        <!-- å­˜å‚¨æ¡¶è¯¦ç»†ä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸª£ å­˜å‚¨æ¡¶è¯¦ç»†ä¿¡æ¯</h2>
            <button class="button" onclick="debugStorageBuckets()">æ£€æŸ¥å­˜å‚¨æ¡¶</button>
            <button class="button" onclick="listAllBuckets()">åˆ—å‡ºæ‰€æœ‰æ¡¶</button>
            <button class="button" onclick="testBucketAccess()">æµ‹è¯•æ¡¶è®¿é—®</button>
            <div class="log-area" id="bucketDebugLog"></div>
        </div>

        <!-- API å“åº”è°ƒè¯• -->
        <div class="section">
            <h2>ğŸ”§ API å“åº”è°ƒè¯•</h2>
            <button class="button" onclick="rawApiCall()">åŸå§‹ API è°ƒç”¨</button>
            <button class="button" onclick="testAuthentication()">æµ‹è¯•è®¤è¯çŠ¶æ€</button>
            <div class="log-area" id="apiDebugLog"></div>
        </div>

        <!-- æƒé™æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ” æƒé™æµ‹è¯•</h2>
            <button class="button" onclick="testPermissions()">æµ‹è¯•æƒé™</button>
            <button class="button" onclick="testFileUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </button>
            <div class="log-area" id="permissionLog"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // æ—¥å¿—å‡½æ•°
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeColors = {
                error: '#ef4444',
                success: '#10b981',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const coloredMessage = `<span style="color: ${typeColors[type] || '#00ff00'}">[${timestamp}] ${message}</span>\n`;
            element.innerHTML += coloredMessage;
            element.scrollTop = element.scrollHeight;
        }

        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        function displayConfig() {
            const configHtml = `
                <strong>Supabase URL:</strong> ${SUPABASE_URL}<br>
                <strong>Anon Key:</strong> ${SUPABASE_ANON_KEY.substring(0, 50)}...<br>
                <strong>å®¢æˆ·ç«¯çŠ¶æ€:</strong> ${supabaseClient ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}<br>
                <strong>å½“å‰æ—¶é—´:</strong> ${new Date().toLocaleString()}
            `;
            document.getElementById('configDisplay').innerHTML = configHtml;
        }

        // è°ƒè¯•å­˜å‚¨æ¡¶
        async function debugStorageBuckets() {
            const logId = 'bucketDebugLog';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, 'ğŸ” å¼€å§‹è°ƒè¯•å­˜å‚¨æ¡¶...', 'info');
            
            try {
                // 1. æ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€
                log(logId, `å®¢æˆ·ç«¯çŠ¶æ€: ${supabaseClient ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`, 'info');
                
                // 2. å°è¯•è·å–å­˜å‚¨æ¡¶åˆ—è¡¨
                log(logId, 'æ­£åœ¨è°ƒç”¨ supabase.storage.listBuckets()...', 'info');
                const { data: buckets, error } = await supabaseClient.storage.listBuckets();
                
                if (error) {
                    log(logId, `âŒ è·å–å­˜å‚¨æ¡¶å¤±è´¥: ${error.message}`, 'error');
                    log(logId, `é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                log(logId, `âœ… æˆåŠŸè·å–å­˜å‚¨æ¡¶åˆ—è¡¨`, 'success');
                log(logId, `æ‰¾åˆ° ${buckets ? buckets.length : 0} ä¸ªå­˜å‚¨æ¡¶`, 'info');
                
                if (buckets && buckets.length > 0) {
                    log(logId, 'å­˜å‚¨æ¡¶è¯¦æƒ…:', 'info');
                    buckets.forEach((bucket, index) => {
                        log(logId, `  ${index + 1}. ID: ${bucket.id}, Name: ${bucket.name}, Public: ${bucket.public}`, 'info');
                    });
                } else {
                    log(logId, 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å­˜å‚¨æ¡¶', 'warning');
                }
                
                // 3. æ£€æŸ¥å¿…éœ€çš„å­˜å‚¨æ¡¶
                const requiredBuckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
                const existingBuckets = buckets ? buckets.map(b => b.id) : [];
                
                log(logId, 'æ£€æŸ¥å¿…éœ€çš„å­˜å‚¨æ¡¶:', 'info');
                requiredBuckets.forEach(bucket => {
                    if (existingBuckets.includes(bucket)) {
                        log(logId, `  âœ… ${bucket} - å­˜åœ¨`, 'success');
                    } else {
                        log(logId, `  âŒ ${bucket} - ç¼ºå¤±`, 'error');
                    }
                });
                
            } catch (error) {
                log(logId, `ğŸ’¥ è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ${error.message}`, 'error');
                log(logId, `å¼‚å¸¸å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        // åˆ—å‡ºæ‰€æœ‰å­˜å‚¨æ¡¶
        async function listAllBuckets() {
            const logId = 'bucketDebugLog';
            log(logId, '\nğŸ“‹ åˆ—å‡ºæ‰€æœ‰å­˜å‚¨æ¡¶...', 'info');
            
            try {
                const response = await supabaseClient.storage.listBuckets();
                log(logId, `åŸå§‹å“åº”: ${JSON.stringify(response, null, 2)}`, 'info');
            } catch (error) {
                log(logId, `åˆ—å‡ºå­˜å‚¨æ¡¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å­˜å‚¨æ¡¶è®¿é—®
        async function testBucketAccess() {
            const logId = 'bucketDebugLog';
            log(logId, '\nğŸ” æµ‹è¯•å­˜å‚¨æ¡¶è®¿é—®æƒé™...', 'info');
            
            const testBuckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
            
            for (const bucketName of testBuckets) {
                try {
                    const { data, error } = await supabaseClient.storage.from(bucketName).list();
                    if (error) {
                        log(logId, `âŒ ${bucketName}: ${error.message}`, 'error');
                    } else {
                        log(logId, `âœ… ${bucketName}: å¯è®¿é—® (${data.length} ä¸ªæ–‡ä»¶)`, 'success');
                    }
                } catch (error) {
                    log(logId, `ğŸ’¥ ${bucketName}: è®¿é—®å¼‚å¸¸ - ${error.message}`, 'error');
                }
            }
        }

        // åŸå§‹ API è°ƒç”¨
        async function rawApiCall() {
            const logId = 'apiDebugLog';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, 'ğŸ”§ æ‰§è¡ŒåŸå§‹ API è°ƒç”¨...', 'info');
            
            try {
                // ç›´æ¥è°ƒç”¨ REST API
                const response = await fetch(`${SUPABASE_URL}/storage/v1/bucket`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(logId, `HTTP çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                
                const responseText = await response.text();
                log(logId, `å“åº”å†…å®¹: ${responseText}`, 'info');
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    log(logId, `è§£æåçš„æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log(logId, `âŒ API è°ƒç”¨å¤±è´¥`, 'error');
                }
                
            } catch (error) {
                log(logId, `ğŸ’¥ åŸå§‹ API è°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•è®¤è¯çŠ¶æ€
        async function testAuthentication() {
            const logId = 'apiDebugLog';
            log(logId, '\nğŸ” æµ‹è¯•è®¤è¯çŠ¶æ€...', 'info');
            
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) {
                    log(logId, `è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                } else if (user) {
                    log(logId, `âœ… ç”¨æˆ·å·²è®¤è¯: ${user.email}`, 'success');
                } else {
                    log(logId, `âš ï¸ ç”¨æˆ·æœªè®¤è¯ (åŒ¿åè®¿é—®)`, 'warning');
                }
                
                // æ£€æŸ¥ä¼šè¯
                const { data: { session } } = await supabaseClient.auth.getSession();
                log(logId, `ä¼šè¯çŠ¶æ€: ${session ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}`, 'info');
                
            } catch (error) {
                log(logId, `è®¤è¯æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æƒé™
        async function testPermissions() {
            const logId = 'permissionLog';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, 'ğŸ” æµ‹è¯•å­˜å‚¨æƒé™...', 'info');
            
            // æµ‹è¯•æ¯ä¸ªå­˜å‚¨æ¡¶çš„æƒé™
            const buckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
            
            for (const bucket of buckets) {
                log(logId, `\næµ‹è¯• ${bucket} æƒé™:`, 'info');
                
                try {
                    // æµ‹è¯•è¯»å–æƒé™
                    const { data: files, error: listError } = await supabaseClient.storage.from(bucket).list();
                    if (listError) {
                        log(logId, `  âŒ è¯»å–æƒé™: ${listError.message}`, 'error');
                    } else {
                        log(logId, `  âœ… è¯»å–æƒé™: æ­£å¸¸`, 'success');
                    }
                } catch (error) {
                    log(logId, `  ğŸ’¥ æƒé™æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                }
            }
        }

        // æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
        async function testFileUpload() {
            const logId = 'permissionLog';
            log(logId, '\nğŸ“¤ æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ...', 'info');
            
            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
            const testFile = new Blob(['æµ‹è¯•æ–‡ä»¶å†…å®¹'], { type: 'text/plain' });
            const fileName = `test-${Date.now()}.txt`;
            
            try {
                const { data, error } = await supabaseClient.storage
                    .from('user-uploads')
                    .upload(fileName, testFile);
                
                if (error) {
                    log(logId, `âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                } else {
                    log(logId, `âœ… ä¸Šä¼ æˆåŠŸ: ${data.path}`, 'success');
                    
                    // å°è¯•åˆ é™¤æµ‹è¯•æ–‡ä»¶
                    const { error: deleteError } = await supabaseClient.storage
                        .from('user-uploads')
                        .remove([fileName]);
                    
                    if (deleteError) {
                        log(logId, `âš ï¸ æ¸…ç†æµ‹è¯•æ–‡ä»¶å¤±è´¥: ${deleteError.message}`, 'warning');
                    } else {
                        log(logId, `ğŸ—‘ï¸ æµ‹è¯•æ–‡ä»¶å·²æ¸…ç†`, 'info');
                    }
                }
            } catch (error) {
                log(logId, `ğŸ’¥ ä¸Šä¼ æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            displayConfig();
            log('bucketDebugLog', 'è°ƒè¯•å·¥å…·å·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        };
    </script>
</body>
</html>