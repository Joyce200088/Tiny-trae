<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 存储桶调试工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #2563eb;
            margin-top: 0;
        }
        .log-area {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .button:hover {
            background-color: #1d4ed8;
        }
        .button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .config-display {
            background-color: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 10px;
        }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Supabase 存储桶调试工具</h1>
        
        <!-- 配置显示 -->
        <div class="section">
            <h2>📋 当前配置</h2>
            <div class="config-display" id="configDisplay">
                正在加载配置...
            </div>
        </div>

        <!-- 存储桶详细信息 -->
        <div class="section">
            <h2>🪣 存储桶详细信息</h2>
            <button class="button" onclick="debugStorageBuckets()">检查存储桶</button>
            <button class="button" onclick="listAllBuckets()">列出所有桶</button>
            <button class="button" onclick="testBucketAccess()">测试桶访问</button>
            <div class="log-area" id="bucketDebugLog"></div>
        </div>

        <!-- API 响应调试 -->
        <div class="section">
            <h2>🔧 API 响应调试</h2>
            <button class="button" onclick="rawApiCall()">原始 API 调用</button>
            <button class="button" onclick="testAuthentication()">测试认证状态</button>
            <div class="log-area" id="apiDebugLog"></div>
        </div>

        <!-- 权限测试 -->
        <div class="section">
            <h2>🔐 权限测试</h2>
            <button class="button" onclick="testPermissions()">测试权限</button>
            <button class="button" onclick="testFileUpload()">测试文件上传</button>
            <div class="log-area" id="permissionLog"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';
        
        // 初始化 Supabase 客户端
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 日志函数
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeColors = {
                error: '#ef4444',
                success: '#10b981',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const coloredMessage = `<span style="color: ${typeColors[type] || '#00ff00'}">[${timestamp}] ${message}</span>\n`;
            element.innerHTML += coloredMessage;
            element.scrollTop = element.scrollHeight;
        }

        // 显示配置信息
        function displayConfig() {
            const configHtml = `
                <strong>Supabase URL:</strong> ${SUPABASE_URL}<br>
                <strong>Anon Key:</strong> ${SUPABASE_ANON_KEY.substring(0, 50)}...<br>
                <strong>客户端状态:</strong> ${supabaseClient ? '已初始化' : '未初始化'}<br>
                <strong>当前时间:</strong> ${new Date().toLocaleString()}
            `;
            document.getElementById('configDisplay').innerHTML = configHtml;
        }

        // 调试存储桶
        async function debugStorageBuckets() {
            const logId = 'bucketDebugLog';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, '🔍 开始调试存储桶...', 'info');
            
            try {
                // 1. 检查客户端状态
                log(logId, `客户端状态: ${supabaseClient ? '正常' : '异常'}`, 'info');
                
                // 2. 尝试获取存储桶列表
                log(logId, '正在调用 supabase.storage.listBuckets()...', 'info');
                const { data: buckets, error } = await supabaseClient.storage.listBuckets();
                
                if (error) {
                    log(logId, `❌ 获取存储桶失败: ${error.message}`, 'error');
                    log(logId, `错误详情: ${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                log(logId, `✅ 成功获取存储桶列表`, 'success');
                log(logId, `找到 ${buckets ? buckets.length : 0} 个存储桶`, 'info');
                
                if (buckets && buckets.length > 0) {
                    log(logId, '存储桶详情:', 'info');
                    buckets.forEach((bucket, index) => {
                        log(logId, `  ${index + 1}. ID: ${bucket.id}, Name: ${bucket.name}, Public: ${bucket.public}`, 'info');
                    });
                } else {
                    log(logId, '⚠️ 没有找到任何存储桶', 'warning');
                }
                
                // 3. 检查必需的存储桶
                const requiredBuckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
                const existingBuckets = buckets ? buckets.map(b => b.id) : [];
                
                log(logId, '检查必需的存储桶:', 'info');
                requiredBuckets.forEach(bucket => {
                    if (existingBuckets.includes(bucket)) {
                        log(logId, `  ✅ ${bucket} - 存在`, 'success');
                    } else {
                        log(logId, `  ❌ ${bucket} - 缺失`, 'error');
                    }
                });
                
            } catch (error) {
                log(logId, `💥 调试过程中发生异常: ${error.message}`, 'error');
                log(logId, `异常堆栈: ${error.stack}`, 'error');
            }
        }

        // 列出所有存储桶
        async function listAllBuckets() {
            const logId = 'bucketDebugLog';
            log(logId, '\n📋 列出所有存储桶...', 'info');
            
            try {
                const response = await supabaseClient.storage.listBuckets();
                log(logId, `原始响应: ${JSON.stringify(response, null, 2)}`, 'info');
            } catch (error) {
                log(logId, `列出存储桶失败: ${error.message}`, 'error');
            }
        }

        // 测试存储桶访问
        async function testBucketAccess() {
            const logId = 'bucketDebugLog';
            log(logId, '\n🔐 测试存储桶访问权限...', 'info');
            
            const testBuckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
            
            for (const bucketName of testBuckets) {
                try {
                    const { data, error } = await supabaseClient.storage.from(bucketName).list();
                    if (error) {
                        log(logId, `❌ ${bucketName}: ${error.message}`, 'error');
                    } else {
                        log(logId, `✅ ${bucketName}: 可访问 (${data.length} 个文件)`, 'success');
                    }
                } catch (error) {
                    log(logId, `💥 ${bucketName}: 访问异常 - ${error.message}`, 'error');
                }
            }
        }

        // 原始 API 调用
        async function rawApiCall() {
            const logId = 'apiDebugLog';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, '🔧 执行原始 API 调用...', 'info');
            
            try {
                // 直接调用 REST API
                const response = await fetch(`${SUPABASE_URL}/storage/v1/bucket`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(logId, `HTTP 状态: ${response.status} ${response.statusText}`, 'info');
                
                const responseText = await response.text();
                log(logId, `响应内容: ${responseText}`, 'info');
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    log(logId, `解析后的数据: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log(logId, `❌ API 调用失败`, 'error');
                }
                
            } catch (error) {
                log(logId, `💥 原始 API 调用异常: ${error.message}`, 'error');
            }
        }

        // 测试认证状态
        async function testAuthentication() {
            const logId = 'apiDebugLog';
            log(logId, '\n🔐 测试认证状态...', 'info');
            
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) {
                    log(logId, `认证检查失败: ${error.message}`, 'error');
                } else if (user) {
                    log(logId, `✅ 用户已认证: ${user.email}`, 'success');
                } else {
                    log(logId, `⚠️ 用户未认证 (匿名访问)`, 'warning');
                }
                
                // 检查会话
                const { data: { session } } = await supabaseClient.auth.getSession();
                log(logId, `会话状态: ${session ? '有效' : '无效'}`, 'info');
                
            } catch (error) {
                log(logId, `认证测试异常: ${error.message}`, 'error');
            }
        }

        // 测试权限
        async function testPermissions() {
            const logId = 'permissionLog';
            document.getElementById(logId).innerHTML = '';
            
            log(logId, '🔐 测试存储权限...', 'info');
            
            // 测试每个存储桶的权限
            const buckets = ['sticker-images', 'background-images', 'world-thumbnails', 'user-uploads'];
            
            for (const bucket of buckets) {
                log(logId, `\n测试 ${bucket} 权限:`, 'info');
                
                try {
                    // 测试读取权限
                    const { data: files, error: listError } = await supabaseClient.storage.from(bucket).list();
                    if (listError) {
                        log(logId, `  ❌ 读取权限: ${listError.message}`, 'error');
                    } else {
                        log(logId, `  ✅ 读取权限: 正常`, 'success');
                    }
                } catch (error) {
                    log(logId, `  💥 权限测试异常: ${error.message}`, 'error');
                }
            }
        }

        // 测试文件上传
        async function testFileUpload() {
            const logId = 'permissionLog';
            log(logId, '\n📤 测试文件上传...', 'info');
            
            // 创建一个测试文件
            const testFile = new Blob(['测试文件内容'], { type: 'text/plain' });
            const fileName = `test-${Date.now()}.txt`;
            
            try {
                const { data, error } = await supabaseClient.storage
                    .from('user-uploads')
                    .upload(fileName, testFile);
                
                if (error) {
                    log(logId, `❌ 上传失败: ${error.message}`, 'error');
                } else {
                    log(logId, `✅ 上传成功: ${data.path}`, 'success');
                    
                    // 尝试删除测试文件
                    const { error: deleteError } = await supabaseClient.storage
                        .from('user-uploads')
                        .remove([fileName]);
                    
                    if (deleteError) {
                        log(logId, `⚠️ 清理测试文件失败: ${deleteError.message}`, 'warning');
                    } else {
                        log(logId, `🗑️ 测试文件已清理`, 'info');
                    }
                }
            } catch (error) {
                log(logId, `💥 上传测试异常: ${error.message}`, 'error');
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            displayConfig();
            log('bucketDebugLog', '调试工具已准备就绪，点击按钮开始测试', 'info');
        };
    </script>
</body>
</html>