<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 存储桶检查</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .bucket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .bucket-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f9f9f9;
        }
        .bucket-card h4 {
            margin-top: 0;
            color: #333;
        }
        .bucket-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .bucket-status.exists {
            background: #d4edda;
            color: #155724;
        }
        .bucket-status.missing {
            background: #f8d7da;
            color: #721c24;
        }
        .bucket-status.checking {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Supabase 存储桶检查工具</h1>
        <p>检查所有必需的存储桶是否存在并正确配置</p>
        
        <!-- 控制面板 -->
        <div class="test-section">
            <h3>检查控制</h3>
            <button onclick="checkAllBuckets()">检查所有存储桶</button>
            <button onclick="createMissingBuckets()">创建缺失的存储桶</button>
            <button onclick="testUploadPermissions()">测试上传权限</button>
            <button onclick="clearLogs()">清空日志</button>
        </div>

        <!-- 存储桶状态 -->
        <div class="test-section">
            <h3>存储桶状态</h3>
            <div class="bucket-grid" id="bucket-grid">
                <!-- 动态生成存储桶卡片 -->
            </div>
        </div>

        <!-- Supabase配置检查 -->
        <div class="test-section">
            <h3>Supabase 配置检查</h3>
            <div id="config-status"></div>
            <button onclick="checkSupabaseConfig()">检查配置</button>
        </div>

        <!-- 日志显示 -->
        <div class="test-section">
            <h3>检查日志</h3>
            <div id="log-display" class="log"></div>
        </div>
    </div>

    <script>
        let logContent = '';

        // 存储桶配置
        const REQUIRED_BUCKETS = [
            {
                id: 'sticker-images',
                name: '贴纸图片',
                description: '存储贴纸图标文件',
                maxSize: '5MB',
                allowedTypes: ['image/png', 'image/jpeg', 'image/webp', 'image/svg+xml']
            },
            {
                id: 'background-images',
                name: '背景图片',
                description: '存储背景图片文件',
                maxSize: '10MB',
                allowedTypes: ['image/png', 'image/jpeg', 'image/webp']
            },
            {
                id: 'world-thumbnails',
                name: '世界缩略图',
                description: '存储世界预览缩略图',
                maxSize: '5MB',
                allowedTypes: ['image/png', 'image/jpeg', 'image/webp']
            },
            {
                id: 'user-uploads',
                name: '用户上传',
                description: '存储用户上传的其他文件',
                maxSize: '10MB',
                allowedTypes: ['image/png', 'image/jpeg', 'image/webp', 'image/svg+xml']
            }
        ];

        // 日志记录函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logContent += logMessage;
            
            const logDisplay = document.getElementById('log-display');
            logDisplay.textContent = logContent;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            console.log(message);
        }

        // 清空日志
        function clearLogs() {
            logContent = '';
            document.getElementById('log-display').textContent = '';
        }

        // 初始化存储桶卡片
        function initBucketCards() {
            const grid = document.getElementById('bucket-grid');
            grid.innerHTML = '';
            
            REQUIRED_BUCKETS.forEach(bucket => {
                const card = document.createElement('div');
                card.className = 'bucket-card';
                card.innerHTML = `
                    <h4>${bucket.name} (${bucket.id})</h4>
                    <p>${bucket.description}</p>
                    <p><strong>最大文件:</strong> ${bucket.maxSize}</p>
                    <p><strong>支持格式:</strong> ${bucket.allowedTypes.join(', ')}</p>
                    <div class="bucket-status checking" id="status-${bucket.id}">检查中...</div>
                `;
                grid.appendChild(card);
            });
        }

        // 更新存储桶状态
        function updateBucketStatus(bucketId, exists, error = null) {
            const statusElement = document.getElementById(`status-${bucketId}`);
            if (!statusElement) return;
            
            if (error) {
                statusElement.className = 'bucket-status missing';
                statusElement.textContent = `错误: ${error}`;
            } else if (exists) {
                statusElement.className = 'bucket-status exists';
                statusElement.textContent = '✅ 存在';
            } else {
                statusElement.className = 'bucket-status missing';
                statusElement.textContent = '❌ 不存在';
            }
        }

        // 检查Supabase配置
        async function checkSupabaseConfig() {
            const configStatus = document.getElementById('config-status');
            
            try {
                log('检查Supabase配置...');
                
                // 检查环境变量（模拟）
                const hasUrl = true; // 实际应该检查 process.env.NEXT_PUBLIC_SUPABASE_URL
                const hasAnonKey = true; // 实际应该检查 process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
                
                let configHtml = '<div class="status info">';
                configHtml += '<h4>配置状态:</h4>';
                configHtml += `<p>Supabase URL: ${hasUrl ? '✅ 已配置' : '❌ 未配置'}</p>`;
                configHtml += `<p>Anon Key: ${hasAnonKey ? '✅ 已配置' : '❌ 未配置'}</p>`;
                
                if (hasUrl && hasAnonKey) {
                    configHtml += '<p><strong>✅ Supabase配置完整</strong></p>';
                    log('Supabase配置检查通过');
                } else {
                    configHtml += '<p><strong>❌ Supabase配置不完整</strong></p>';
                    log('Supabase配置不完整，请检查环境变量');
                }
                
                configHtml += '</div>';
                configStatus.innerHTML = configHtml;
                
            } catch (error) {
                log(`配置检查失败: ${error.message}`);
                configStatus.innerHTML = `<div class="status error">配置检查失败: ${error.message}</div>`;
            }
        }

        // 检查所有存储桶
        async function checkAllBuckets() {
            log('=== 开始检查所有存储桶 ===');
            
            // 重置状态
            REQUIRED_BUCKETS.forEach(bucket => {
                updateBucketStatus(bucket.id, false);
                const statusElement = document.getElementById(`status-${bucket.id}`);
                if (statusElement) {
                    statusElement.className = 'bucket-status checking';
                    statusElement.textContent = '检查中...';
                }
            });
            
            try {
                // 模拟Supabase客户端检查
                // 实际应该使用: const { data, error } = await supabase.storage.listBuckets();
                
                log('连接到Supabase Storage...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 模拟检查结果
                const existingBuckets = ['sticker-images', 'background-images']; // 模拟只有部分存储桶存在
                
                for (const bucket of REQUIRED_BUCKETS) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const exists = existingBuckets.includes(bucket.id);
                    updateBucketStatus(bucket.id, exists);
                    
                    if (exists) {
                        log(`✅ 存储桶 ${bucket.id} 存在`);
                    } else {
                        log(`❌ 存储桶 ${bucket.id} 不存在`);
                    }
                }
                
                const missingBuckets = REQUIRED_BUCKETS.filter(b => !existingBuckets.includes(b.id));
                if (missingBuckets.length > 0) {
                    log(`发现 ${missingBuckets.length} 个缺失的存储桶: ${missingBuckets.map(b => b.id).join(', ')}`);
                    log('请运行存储桶设置脚本或点击"创建缺失的存储桶"按钮');
                } else {
                    log('✅ 所有必需的存储桶都存在');
                }
                
            } catch (error) {
                log(`检查存储桶时出错: ${error.message}`);
                REQUIRED_BUCKETS.forEach(bucket => {
                    updateBucketStatus(bucket.id, false, error.message);
                });
            }
        }

        // 创建缺失的存储桶
        async function createMissingBuckets() {
            log('=== 开始创建缺失的存储桶 ===');
            log('注意: 这需要管理员权限');
            
            try {
                // 这里应该执行存储桶创建脚本
                log('执行存储桶创建脚本...');
                log('脚本位置: supabase/storage-setup.sql');
                log('请在Supabase控制台的SQL编辑器中执行该脚本');
                
                // 模拟创建过程
                for (const bucket of REQUIRED_BUCKETS) {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    log(`创建存储桶: ${bucket.id}`);
                    log(`  - 名称: ${bucket.name}`);
                    log(`  - 最大文件大小: ${bucket.maxSize}`);
                    log(`  - 允许的MIME类型: ${bucket.allowedTypes.join(', ')}`);
                }
                
                log('✅ 存储桶创建脚本执行完成');
                log('请重新检查存储桶状态');
                
            } catch (error) {
                log(`创建存储桶时出错: ${error.message}`);
            }
        }

        // 测试上传权限
        async function testUploadPermissions() {
            log('=== 测试上传权限 ===');
            
            try {
                // 创建测试文件
                const testBlob = new Blob(['test'], { type: 'text/plain' });
                
                for (const bucket of REQUIRED_BUCKETS) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    try {
                        log(`测试 ${bucket.id} 上传权限...`);
                        
                        // 模拟上传测试
                        // 实际应该使用: await supabase.storage.from(bucket.id).upload('test.txt', testBlob);
                        
                        const success = Math.random() > 0.3; // 模拟70%成功率
                        
                        if (success) {
                            log(`✅ ${bucket.id} 上传权限正常`);
                        } else {
                            log(`❌ ${bucket.id} 上传权限异常`);
                        }
                        
                    } catch (error) {
                        log(`❌ ${bucket.id} 上传测试失败: ${error.message}`);
                    }
                }
                
            } catch (error) {
                log(`上传权限测试失败: ${error.message}`);
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', function() {
            log('存储桶检查工具已加载');
            initBucketCards();
            checkSupabaseConfig();
        });
    </script>
</body>
</html>