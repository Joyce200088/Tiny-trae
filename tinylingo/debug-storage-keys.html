<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存储键调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .key-info {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .data-preview {
            background: #f1f3f4;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>localStorage存储键调试工具</h1>
        <p>检查所有与世界数据相关的localStorage键和数据格式</p>
        
        <button onclick="checkAllKeys()">检查所有存储键</button>
        <button onclick="checkExpectedKeys()">检查期望的存储键</button>
        <button onclick="migrateData()">迁移数据到正确格式</button>
        
        <div id="results"></div>
    </div>

    <script>
        // 检查所有localStorage键
        function checkAllKeys() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '<h2>所有localStorage键检查</h2>';
            
            // 获取所有localStorage键
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                allKeys.push(localStorage.key(i));
            }
            
            // 过滤出可能相关的键
            const relevantKeys = allKeys.filter(key => 
                key && (
                    key.includes('tinylingo') || 
                    key.includes('world') || 
                    key.includes('user')
                )
            );
            
            resultsEl.innerHTML += `<div class="success">找到 ${relevantKeys.length} 个相关键，共 ${allKeys.length} 个总键</div>`;
            
            relevantKeys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    
                    let dataType = 'unknown';
                    let worldCount = 0;
                    let dataStructure = '';
                    
                    if (Array.isArray(parsed)) {
                        dataType = 'Array';
                        worldCount = parsed.length;
                        dataStructure = `数组，包含 ${parsed.length} 个元素`;
                        if (parsed.length > 0 && parsed[0].id) {
                            dataStructure += `，第一个元素有ID: ${parsed[0].id}`;
                        }
                    } else if (typeof parsed === 'object' && parsed !== null) {
                        dataType = 'Object';
                        if (parsed.worlds) {
                            if (Array.isArray(parsed.worlds)) {
                                worldCount = parsed.worlds.length;
                                dataStructure = `对象，包含worlds数组 (${worldCount}个世界)`;
                            } else if (typeof parsed.worlds === 'object') {
                                worldCount = Object.keys(parsed.worlds).length;
                                dataStructure = `对象，包含worlds对象 (${worldCount}个世界)`;
                            }
                        } else {
                            const possibleWorlds = Object.values(parsed).filter(item => 
                                item && typeof item === 'object' && item.id
                            );
                            worldCount = possibleWorlds.length;
                            dataStructure = `对象，包含 ${Object.keys(parsed).length} 个属性，其中 ${worldCount} 个可能是世界`;
                        }
                    }
                    
                    resultsEl.innerHTML += `
                        <div class="key-info">
                            <h3>键: ${key}</h3>
                            <p><strong>数据类型:</strong> ${dataType}</p>
                            <p><strong>数据结构:</strong> ${dataStructure}</p>
                            <p><strong>世界数量:</strong> ${worldCount}</p>
                            <p><strong>数据大小:</strong> ${data.length} 字符</p>
                            <div class="data-preview">${JSON.stringify(parsed, null, 2).substring(0, 500)}${data.length > 500 ? '...' : ''}</div>
                        </div>
                    `;
                } catch (error) {
                    resultsEl.innerHTML += `
                        <div class="key-info">
                            <h3>键: ${key}</h3>
                            <div class="error">解析错误: ${error.message}</div>
                        </div>
                    `;
                }
            });
        }
        
        // 检查期望的存储键
        function checkExpectedKeys() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML += '<h2>期望的存储键检查</h2>';
            
            // 模拟WorldDataUtils期望的键格式
            const expectedKeys = [
                'tinylingo_worlds_joyce',
                'tinylingo_worlds_guest',
                'tinylingo_worlds_admin'
            ];
            
            expectedKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const worldCount = Array.isArray(parsed) ? parsed.length : 0;
                        resultsEl.innerHTML += `
                            <div class="success">
                                <h3>✅ 找到期望键: ${key}</h3>
                                <p>数据类型: ${Array.isArray(parsed) ? 'Array' : typeof parsed}</p>
                                <p>世界数量: ${worldCount}</p>
                            </div>
                        `;
                    } catch (error) {
                        resultsEl.innerHTML += `
                            <div class="error">
                                <h3>❌ 键存在但数据无效: ${key}</h3>
                                <p>错误: ${error.message}</p>
                            </div>
                        `;
                    }
                } else {
                    resultsEl.innerHTML += `
                        <div class="warning">
                            <h3>⚠️ 未找到期望键: ${key}</h3>
                        </div>
                    `;
                }
            });
        }
        
        // 迁移数据到正确格式
        function migrateData() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML += '<h2>数据迁移</h2>';
            
            try {
                // 收集所有世界数据
                const allWorlds = [];
                
                // 从tinylingo_user_data收集
                const userData = localStorage.getItem('tinylingo_user_data');
                if (userData) {
                    try {
                        const parsed = JSON.parse(userData);
                        if (parsed.worlds && typeof parsed.worlds === 'object') {
                            const worldsArray = Object.values(parsed.worlds);
                            allWorlds.push(...worldsArray.filter(w => w && w.id));
                            resultsEl.innerHTML += `<div class="success">从tinylingo_user_data收集到 ${worldsArray.length} 个世界</div>`;
                        }
                    } catch (error) {
                        resultsEl.innerHTML += `<div class="error">处理tinylingo_user_data失败: ${error.message}</div>`;
                    }
                }
                
                // 从worldData收集
                const worldData = localStorage.getItem('worldData');
                if (worldData) {
                    try {
                        const parsed = JSON.parse(worldData);
                        if (Array.isArray(parsed)) {
                            allWorlds.push(...parsed.filter(w => w && w.id));
                            resultsEl.innerHTML += `<div class="success">从worldData收集到 ${parsed.length} 个世界</div>`;
                        }
                    } catch (error) {
                        resultsEl.innerHTML += `<div class="error">处理worldData失败: ${error.message}</div>`;
                    }
                }
                
                // 从worlds收集
                const worlds = localStorage.getItem('worlds');
                if (worlds) {
                    try {
                        const parsed = JSON.parse(worlds);
                        if (typeof parsed === 'object' && parsed !== null) {
                            const worldsArray = Object.values(parsed);
                            allWorlds.push(...worldsArray.filter(w => w && w.id));
                            resultsEl.innerHTML += `<div class="success">从worlds收集到 ${worldsArray.length} 个世界</div>`;
                        }
                    } catch (error) {
                        resultsEl.innerHTML += `<div class="error">处理worlds失败: ${error.message}</div>`;
                    }
                }
                
                // 去重（基于ID）
                const uniqueWorlds = [];
                const seenIds = new Set();
                allWorlds.forEach(world => {
                    if (world && world.id && !seenIds.has(world.id)) {
                        seenIds.add(world.id);
                        uniqueWorlds.push(world);
                    }
                });
                
                resultsEl.innerHTML += `<div class="success">去重后共有 ${uniqueWorlds.length} 个唯一世界</div>`;
                
                // 保存到期望的键格式
                const targetKey = 'tinylingo_worlds_joyce'; // 假设用户是joyce
                localStorage.setItem(targetKey, JSON.stringify(uniqueWorlds));
                
                resultsEl.innerHTML += `<div class="success">✅ 数据已迁移到 ${targetKey}</div>`;
                
                // 显示迁移的数据
                resultsEl.innerHTML += `
                    <div class="key-info">
                        <h3>迁移的数据预览</h3>
                        <div class="data-preview">${JSON.stringify(uniqueWorlds, null, 2)}</div>
                    </div>
                `;
                
                // 触发存储变化事件
                window.dispatchEvent(new StorageEvent('storage', {
                    key: targetKey,
                    newValue: JSON.stringify(uniqueWorlds),
                    storageArea: localStorage
                }));
                
                resultsEl.innerHTML += `<div class="success">✅ 已触发存储变化事件</div>`;
                
            } catch (error) {
                resultsEl.innerHTML += `<div class="error">迁移失败: ${error.message}</div>`;
            }
        }
        
        // 页面加载时自动检查
        window.onload = function() {
            checkAllKeys();
        };
    </script>
</body>
</html>