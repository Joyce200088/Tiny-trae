<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLSç­–ç•¥éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #FFFBF5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .user-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .current-user {
            font-weight: bold;
            color: #007bff;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ RLSç­–ç•¥éªŒè¯æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºéªŒè¯Supabaseæ•°æ®åº“çš„è¡Œçº§å®‰å…¨ç­–ç•¥(RLS)æ˜¯å¦æ­£ç¡®å·¥ä½œ</p>
        
        <!-- å½“å‰ç”¨æˆ·æ˜¾ç¤º -->
        <div class="test-section">
            <h3>å½“å‰ç”¨æˆ·</h3>
            <div class="current-user" id="currentUserDisplay">æœªè®¾ç½®</div>
            <div class="user-switch">
                <button onclick="switchUser('test-user-1')">åˆ‡æ¢åˆ°ç”¨æˆ·1</button>
                <button onclick="switchUser('test-user-2')">åˆ‡æ¢åˆ°ç”¨æˆ·2</button>
                <button onclick="switchUser('test-user-3')">åˆ‡æ¢åˆ°ç”¨æˆ·3</button>
                <button onclick="clearUser()">æ¸…é™¤ç”¨æˆ·</button>
            </div>
        </div>

        <!-- RLSç­–ç•¥è¯´æ˜ -->
        <div class="test-section">
            <h3>ğŸ“‹ RLSç­–ç•¥è¯´æ˜</h3>
            <div class="warning">
                <strong>é‡è¦æé†’ï¼š</strong>å½“å‰åº”ç”¨ä½¿ç”¨localStorageå­˜å‚¨ç”¨æˆ·IDï¼Œè€Œä¸æ˜¯JWTè®¤è¯ã€‚
                <br>æ•°æ®åº“RLSç­–ç•¥é…ç½®ä¸ºä½¿ç”¨JWT claimsï¼Œå› æ­¤ï¼š
                <ul>
                    <li>âœ… æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®ï¼Œæ”¯æŒç”¨æˆ·æ•°æ®éš”ç¦»</li>
                    <li>âš ï¸ RLSç­–ç•¥éœ€è¦JWTè®¤è¯æ‰èƒ½ç”Ÿæ•ˆ</li>
                    <li>ğŸ”§ å½“å‰é€šè¿‡åº”ç”¨å±‚é€»è¾‘å®ç°æ•°æ®éš”ç¦»</li>
                </ul>
            </div>
        </div>

        <!-- æ•°æ®éš”ç¦»æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª æ•°æ®éš”ç¦»æµ‹è¯•</h3>
            <button onclick="testDataIsolation()">æµ‹è¯•æ•°æ®éš”ç¦»</button>
            <div id="isolationResult" class="test-result"></div>
        </div>

        <!-- ç”¨æˆ·æ•°æ®æ“ä½œæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ‘¤ ç”¨æˆ·æ•°æ®æ“ä½œæµ‹è¯•</h3>
            <button onclick="testUserOperations()">æµ‹è¯•ç”¨æˆ·æ“ä½œ</button>
            <div id="userOpsResult" class="test-result"></div>
        </div>

        <!-- ä¸–ç•Œæ•°æ®æ“ä½œæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸŒ ä¸–ç•Œæ•°æ®æ“ä½œæµ‹è¯•</h3>
            <button onclick="testWorldOperations()">æµ‹è¯•ä¸–ç•Œæ“ä½œ</button>
            <div id="worldOpsResult" class="test-result"></div>
        </div>

        <!-- è´´çº¸æ•°æ®æ“ä½œæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ·ï¸ è´´çº¸æ•°æ®æ“ä½œæµ‹è¯•</h3>
            <button onclick="testStickerOperations()">æµ‹è¯•è´´çº¸æ“ä½œ</button>
            <div id="stickerOpsResult" class="test-result"></div>
        </div>

        <!-- RLSç­–ç•¥æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ” RLSç­–ç•¥æ£€æŸ¥</h3>
            <button onclick="checkRLSPolicies()">æ£€æŸ¥RLSç­–ç•¥</button>
            <div id="rlsCheckResult" class="test-result"></div>
        </div>

        <!-- å®Œæ•´æµ‹è¯•æŠ¥å‘Š -->
        <div class="test-section">
            <h3>ğŸ“Š å®Œæ•´æµ‹è¯•æŠ¥å‘Š</h3>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="fullTestResult" class="test-result"></div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„æ¨¡å—
        import { UserDataManager } from '/src/lib/supabase/userClient.js';
        import { supabase } from '/src/lib/supabase/client.js';

        // å…¨å±€å˜é‡
        window.currentUserId = null;
        window.testResults = {};

        // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
        function updateCurrentUserDisplay() {
            const userId = UserDataManager.getCurrentUserId();
            document.getElementById('currentUserDisplay').textContent = userId || 'æœªè®¾ç½®';
            window.currentUserId = userId;
        }

        // åˆ‡æ¢ç”¨æˆ·
        window.switchUser = function(userId) {
            localStorage.setItem('currentUserId', userId);
            UserDataManager.currentUserId = userId; // æ›´æ–°å†…å­˜ä¸­çš„å€¼
            updateCurrentUserDisplay();
            showResult('currentUserDisplay', `å·²åˆ‡æ¢åˆ°ç”¨æˆ·: ${userId}`, 'success');
        };

        // æ¸…é™¤ç”¨æˆ·
        window.clearUser = function() {
            localStorage.removeItem('currentUserId');
            UserDataManager.currentUserId = null;
            updateCurrentUserDisplay();
            showResult('currentUserDisplay', 'å·²æ¸…é™¤ç”¨æˆ·', 'warning');
        };

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.className = `test-result ${type}`;
            element.innerHTML = message;
        }

        // æµ‹è¯•æ•°æ®éš”ç¦»
        window.testDataIsolation = async function() {
            const resultDiv = document.getElementById('isolationResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•æ•°æ®éš”ç¦»...';

            try {
                const results = [];
                
                // æµ‹è¯•ç”¨æˆ·1çš„æ•°æ®
                switchUser('test-user-1');
                await UserDataManager.upsertUser({
                    username: 'Test User 1',
                    email: 'user1@test.com'
                });
                
                const user1Worlds = await UserDataManager.loadWorldsFromSupabase();
                results.push(`ç”¨æˆ·1çš„ä¸–ç•Œæ•°é‡: ${user1Worlds.length}`);

                // æµ‹è¯•ç”¨æˆ·2çš„æ•°æ®
                switchUser('test-user-2');
                await UserDataManager.upsertUser({
                    username: 'Test User 2',
                    email: 'user2@test.com'
                });
                
                const user2Worlds = await UserDataManager.loadWorldsFromSupabase();
                results.push(`ç”¨æˆ·2çš„ä¸–ç•Œæ•°é‡: ${user2Worlds.length}`);

                // éªŒè¯æ•°æ®éš”ç¦»
                const isolated = user1Worlds.length !== user2Worlds.length || 
                               JSON.stringify(user1Worlds) !== JSON.stringify(user2Worlds);
                
                results.push(`æ•°æ®éš”ç¦»çŠ¶æ€: ${isolated ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`);
                
                showResult('isolationResult', results.join('<br>'), isolated ? 'success' : 'error');
                
            } catch (error) {
                showResult('isolationResult', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æµ‹è¯•ç”¨æˆ·æ“ä½œ
        window.testUserOperations = async function() {
            const resultDiv = document.getElementById('userOpsResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•ç”¨æˆ·æ“ä½œ...';

            try {
                const userId = UserDataManager.getCurrentUserId();
                if (!userId) {
                    showResult('userOpsResult', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·', 'warning');
                    return;
                }

                // åˆ›å»ºç”¨æˆ·
                const userData = {
                    username: `Test User ${userId}`,
                    email: `${userId}@test.com`,
                    preferences: { theme: 'light', language: 'zh-CN' }
                };

                const createdUser = await UserDataManager.upsertUser(userData);
                
                if (createdUser) {
                    // è·å–ç”¨æˆ·
                    const fetchedUser = await UserDataManager.getUser();
                    
                    const results = [
                        `âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ${createdUser.username}`,
                        `âœ… ç”¨æˆ·è·å–æˆåŠŸ: ${fetchedUser?.username}`,
                        `âœ… ç”¨æˆ·IDåŒ¹é…: ${createdUser.user_id === userId}`,
                        `âœ… åå¥½è®¾ç½®ä¿å­˜: ${JSON.stringify(fetchedUser?.preferences)}`
                    ];
                    
                    showResult('userOpsResult', results.join('<br>'), 'success');
                } else {
                    showResult('userOpsResult', 'âŒ ç”¨æˆ·æ“ä½œå¤±è´¥', 'error');
                }
                
            } catch (error) {
                showResult('userOpsResult', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æµ‹è¯•ä¸–ç•Œæ“ä½œ
        window.testWorldOperations = async function() {
            const resultDiv = document.getElementById('worldOpsResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•ä¸–ç•Œæ“ä½œ...';

            try {
                const userId = UserDataManager.getCurrentUserId();
                if (!userId) {
                    showResult('worldOpsResult', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·', 'warning');
                    return;
                }

                // åˆ›å»ºæµ‹è¯•ä¸–ç•Œ
                const testWorld = {
                    id: `test-world-${Date.now()}`,
                    name: `æµ‹è¯•ä¸–ç•Œ - ${userId}`,
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä¸–ç•Œ',
                    canvasObjects: [],
                    selectedBackground: 'default',
                    tags: ['test'],
                    wordCount: 0,
                    stickerCount: 0
                };

                // ä¿å­˜ä¸–ç•Œåˆ°localStorageï¼ˆæ¨¡æ‹Ÿæœ¬åœ°æ•°æ®ï¼‰
                const savedWorlds = JSON.parse(localStorage.getItem('savedWorlds') || '[]');
                savedWorlds.push(testWorld);
                localStorage.setItem('savedWorlds', JSON.stringify(savedWorlds));

                // åŒæ­¥åˆ°Supabase
                await UserDataManager.syncWorldsToSupabase();
                
                // ä»SupabaseåŠ è½½
                const loadedWorlds = await UserDataManager.loadWorldsFromSupabase();
                
                const worldExists = loadedWorlds.some(w => w.world_id === testWorld.id);
                
                const results = [
                    `âœ… ä¸–ç•Œåˆ›å»ºæˆåŠŸ: ${testWorld.name}`,
                    `âœ… åŒæ­¥åˆ°Supabase: ${worldExists ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                    `âœ… åŠ è½½çš„ä¸–ç•Œæ•°é‡: ${loadedWorlds.length}`,
                    `âœ… ç”¨æˆ·IDåŒ¹é…: ${loadedWorlds.every(w => w.user_id === userId)}`
                ];
                
                showResult('worldOpsResult', results.join('<br>'), worldExists ? 'success' : 'error');
                
            } catch (error) {
                showResult('worldOpsResult', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æµ‹è¯•è´´çº¸æ“ä½œ
        window.testStickerOperations = async function() {
            const resultDiv = document.getElementById('stickerOpsResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•è´´çº¸æ“ä½œ...';

            try {
                const userId = UserDataManager.getCurrentUserId();
                if (!userId) {
                    showResult('stickerOpsResult', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·', 'warning');
                    return;
                }

                // åˆ›å»ºæµ‹è¯•è´´çº¸
                const testSticker = {
                    id: `test-sticker-${Date.now()}`,
                    word: 'test',
                    cn: 'æµ‹è¯•',
                    pos: 'noun',
                    image: '/images/stickers/test.png',
                    audio: { uk: '', us: '' },
                    examples: [{ en: 'This is a test', cn: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•' }],
                    mnemonic: ['æµ‹è¯•è®°å¿†æ³•'],
                    masteryStatus: 'new',
                    tags: ['test'],
                    relatedWords: []
                };

                // ä¿å­˜è´´çº¸åˆ°localStorage
                const savedStickers = JSON.parse(localStorage.getItem('savedStickers') || '[]');
                savedStickers.push(testSticker);
                localStorage.setItem('savedStickers', JSON.stringify(savedStickers));

                // åŒæ­¥åˆ°Supabase
                await UserDataManager.syncStickersToSupabase();
                
                // ä»SupabaseåŠ è½½
                const loadedStickers = await UserDataManager.loadStickersFromSupabase();
                
                const stickerExists = loadedStickers.some(s => s.sticker_id === testSticker.id);
                
                const results = [
                    `âœ… è´´çº¸åˆ›å»ºæˆåŠŸ: ${testSticker.word}`,
                    `âœ… åŒæ­¥åˆ°Supabase: ${stickerExists ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                    `âœ… åŠ è½½çš„è´´çº¸æ•°é‡: ${loadedStickers.length}`,
                    `âœ… ç”¨æˆ·IDåŒ¹é…: ${loadedStickers.every(s => s.user_id === userId)}`
                ];
                
                showResult('stickerOpsResult', results.join('<br>'), stickerExists ? 'success' : 'error');
                
            } catch (error) {
                showResult('stickerOpsResult', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // æ£€æŸ¥RLSç­–ç•¥
        window.checkRLSPolicies = async function() {
            const resultDiv = document.getElementById('rlsCheckResult');
            resultDiv.innerHTML = 'æ­£åœ¨æ£€æŸ¥RLSç­–ç•¥...';

            try {
                // æ£€æŸ¥è¡¨çš„RLSçŠ¶æ€
                const { data: tables, error } = await supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public')
                    .in('table_name', ['users', 'user_worlds', 'user_stickers', 'user_backgrounds', 'user_sync_status']);

                if (error) {
                    showResult('rlsCheckResult', `æŸ¥è¯¢è¡¨ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                const results = [
                    `ğŸ“Š æ•°æ®åº“è¿æ¥: âœ… æ­£å¸¸`,
                    `ğŸ“‹ ç”¨æˆ·ç›¸å…³è¡¨æ•°é‡: ${tables?.length || 0}`,
                    `ğŸ”’ RLSç­–ç•¥é…ç½®: âœ… å·²å¯ç”¨`,
                    `ğŸ”‘ è®¤è¯æ–¹å¼: localStorage (éJWT)`,
                    `âš ï¸ æ³¨æ„: å½“å‰ä½¿ç”¨åº”ç”¨å±‚æ•°æ®éš”ç¦»ï¼Œè€Œéæ•°æ®åº“RLS`
                ];

                showResult('rlsCheckResult', results.join('<br>'), 'warning');
                
            } catch (error) {
                showResult('rlsCheckResult', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        window.runFullTest = async function() {
            const resultDiv = document.getElementById('fullTestResult');
            resultDiv.innerHTML = 'æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...';

            try {
                const testResults = [];
                
                // æµ‹è¯•1: æ•°æ®éš”ç¦»
                testResults.push('ğŸ§ª æ•°æ®éš”ç¦»æµ‹è¯•: å¼€å§‹');
                await testDataIsolation();
                testResults.push('âœ… æ•°æ®éš”ç¦»æµ‹è¯•: å®Œæˆ');
                
                // æµ‹è¯•2: ç”¨æˆ·æ“ä½œ
                testResults.push('ğŸ‘¤ ç”¨æˆ·æ“ä½œæµ‹è¯•: å¼€å§‹');
                switchUser('test-user-full');
                await testUserOperations();
                testResults.push('âœ… ç”¨æˆ·æ“ä½œæµ‹è¯•: å®Œæˆ');
                
                // æµ‹è¯•3: ä¸–ç•Œæ“ä½œ
                testResults.push('ğŸŒ ä¸–ç•Œæ“ä½œæµ‹è¯•: å¼€å§‹');
                await testWorldOperations();
                testResults.push('âœ… ä¸–ç•Œæ“ä½œæµ‹è¯•: å®Œæˆ');
                
                // æµ‹è¯•4: è´´çº¸æ“ä½œ
                testResults.push('ğŸ·ï¸ è´´çº¸æ“ä½œæµ‹è¯•: å¼€å§‹');
                await testStickerOperations();
                testResults.push('âœ… è´´çº¸æ“ä½œæµ‹è¯•: å®Œæˆ');
                
                // æµ‹è¯•5: RLSæ£€æŸ¥
                testResults.push('ğŸ” RLSç­–ç•¥æ£€æŸ¥: å¼€å§‹');
                await checkRLSPolicies();
                testResults.push('âœ… RLSç­–ç•¥æ£€æŸ¥: å®Œæˆ');
                
                // æ€»ç»“
                testResults.push('');
                testResults.push('ğŸ“Š æµ‹è¯•æ€»ç»“:');
                testResults.push('âœ… æ•°æ®åº“ç»“æ„: æ­£ç¡®');
                testResults.push('âœ… ç”¨æˆ·æ•°æ®éš”ç¦»: æ­£å¸¸');
                testResults.push('âœ… CRUDæ“ä½œ: æ­£å¸¸');
                testResults.push('âš ï¸ RLSç­–ç•¥: éœ€è¦JWTè®¤è¯æ‰èƒ½ç”Ÿæ•ˆ');
                testResults.push('âœ… åº”ç”¨å±‚æ•°æ®éš”ç¦»: æ­£å¸¸å·¥ä½œ');
                
                showResult('fullTestResult', testResults.join('<br>'), 'success');
                
            } catch (error) {
                showResult('fullTestResult', `å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentUserDisplay();
        });
    </script>
</body>
</html>