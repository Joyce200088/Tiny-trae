<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件验证测试 - TinyLingo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #FFFBF5;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📧 邮件验证测试工具</h1>
        
        <!-- Supabase 连接测试 -->
        <div class="section">
            <h2>1. Supabase 连接测试</h2>
            <button onclick="testSupabaseConnection()">测试连接</button>
            <div id="connectionLog" class="log"></div>
        </div>

        <!-- 邮件发送测试 -->
        <div class="section">
            <h2>2. 邮件发送测试</h2>
            <div class="form-group">
                <label for="testEmail">测试邮箱:</label>
                <input type="email" id="testEmail" placeholder="输入您的邮箱地址">
            </div>
            <div class="form-group">
                <label for="testPassword">密码:</label>
                <input type="password" id="testPassword" placeholder="输入密码（至少6位）">
            </div>
            <div class="form-group">
                <label for="testUsername">用户名:</label>
                <input type="text" id="testUsername" placeholder="输入用户名">
            </div>
            <button onclick="testEmailSending()">测试注册邮件发送</button>
            <button onclick="testPasswordReset()">测试密码重置邮件</button>
            <div id="emailLog" class="log"></div>
        </div>

        <!-- Supabase 邮件配置检查 -->
        <div class="section">
            <h2>3. Supabase 邮件配置检查</h2>
            <button onclick="checkEmailSettings()">检查邮件设置</button>
            <div id="settingsLog" class="log"></div>
        </div>

        <!-- 用户状态检查 -->
        <div class="section">
            <h2>4. 用户状态检查</h2>
            <button onclick="checkUserStatus()">检查当前用户状态</button>
            <button onclick="listUsers()">列出所有用户（需要管理员权限）</button>
            <div id="userLog" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';

        // 初始化 Supabase 客户端
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                flowType: 'pkce'
            }
        });

        // 日志函数
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // 1. 测试 Supabase 连接
        async function testSupabaseConnection() {
            clearLog('connectionLog');
            log('connectionLog', '开始测试 Supabase 连接...', 'info');

            try {
                // 测试基本连接
                const { data, error } = await supabaseClient.from('users').select('count').limit(1);
                
                if (error) {
                    log('connectionLog', `连接错误: ${error.message}`, 'error');
                    log('connectionLog', `错误代码: ${error.code}`, 'error');
                } else {
                    log('connectionLog', '✅ Supabase 连接成功！', 'success');
                }

                // 测试认证状态
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    log('connectionLog', `当前用户: ${user.email} (${user.id})`, 'info');
                    log('connectionLog', `邮箱已验证: ${user.email_confirmed_at ? '是' : '否'}`, user.email_confirmed_at ? 'success' : 'warning');
                } else {
                    log('connectionLog', '当前无登录用户', 'info');
                }

            } catch (error) {
                log('connectionLog', `连接异常: ${error.message}`, 'error');
            }
        }

        // 2. 测试邮件发送
        async function testEmailSending() {
            clearLog('emailLog');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const username = document.getElementById('testUsername').value;

            if (!email || !password) {
                log('emailLog', '请填写邮箱和密码', 'error');
                return;
            }

            log('emailLog', `开始测试注册邮件发送...`, 'info');
            log('emailLog', `邮箱: ${email}`, 'info');
            log('emailLog', `用户名: ${username}`, 'info');

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            display_name: username,
                        },
                        emailRedirectTo: `${window.location.origin}/auth/callback`,
                    },
                });

                log('emailLog', `Supabase 响应:`, 'info');
                log('emailLog', JSON.stringify({ data, error }, null, 2), 'info');

                if (error) {
                    log('emailLog', `❌ 注册失败: ${error.message}`, 'error');
                    
                    // 分析常见错误
                    if (error.message.includes('User already registered')) {
                        log('emailLog', '💡 该邮箱已注册，这是正常的。请尝试其他邮箱。', 'warning');
                    } else if (error.message.includes('Password should be at least')) {
                        log('emailLog', '💡 密码长度不足，请使用至少6个字符。', 'warning');
                    } else if (error.message.includes('Invalid email')) {
                        log('emailLog', '💡 邮箱格式无效。', 'warning');
                    } else if (error.message.includes('Email rate limit exceeded')) {
                        log('emailLog', '💡 邮件发送频率限制，请稍后再试。', 'warning');
                    }
                } else if (data.user) {
                    log('emailLog', `✅ 注册请求成功！`, 'success');
                    log('emailLog', `用户ID: ${data.user.id}`, 'success');
                    log('emailLog', `邮箱确认状态: ${data.user.email_confirmed_at ? '已确认' : '待确认'}`, data.user.email_confirmed_at ? 'success' : 'warning');
                    
                    if (!data.user.email_confirmed_at) {
                        log('emailLog', '📧 请检查您的邮箱（包括垃圾邮件文件夹）查看验证邮件。', 'info');
                        log('emailLog', '⏰ 验证邮件可能需要几分钟才能到达。', 'info');
                    }
                }

            } catch (error) {
                log('emailLog', `❌ 注册异常: ${error.message}`, 'error');
            }
        }

        // 测试密码重置邮件
        async function testPasswordReset() {
            clearLog('emailLog');
            const email = document.getElementById('testEmail').value;

            if (!email) {
                log('emailLog', '请填写邮箱地址', 'error');
                return;
            }

            log('emailLog', `开始测试密码重置邮件...`, 'info');

            try {
                const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/auth/callback`,
                });

                if (error) {
                    log('emailLog', `❌ 密码重置失败: ${error.message}`, 'error');
                } else {
                    log('emailLog', `✅ 密码重置邮件发送成功！`, 'success');
                    log('emailLog', '📧 请检查您的邮箱查看密码重置邮件。', 'info');
                }

            } catch (error) {
                log('emailLog', `❌ 密码重置异常: ${error.message}`, 'error');
            }
        }

        // 3. 检查邮件设置
        async function checkEmailSettings() {
            clearLog('settingsLog');
            log('settingsLog', '检查 Supabase 邮件配置...', 'info');

            // 检查客户端配置
            log('settingsLog', '客户端配置:', 'info');
            log('settingsLog', `- Supabase URL: ${SUPABASE_URL}`, 'info');
            log('settingsLog', `- 认证流程: PKCE`, 'info');
            log('settingsLog', `- 会话检测: 启用`, 'info');
            log('settingsLog', `- 邮件重定向: ${window.location.origin}/auth/callback`, 'info');

            // 检查邮件模板和设置（需要管理员权限）
            log('settingsLog', '\n⚠️ 注意：以下设置需要在 Supabase 控制台中检查：', 'warning');
            log('settingsLog', '1. Authentication > Settings > Email Templates', 'info');
            log('settingsLog', '2. Authentication > Settings > SMTP Settings', 'info');
            log('settingsLog', '3. 确保启用了 "Enable email confirmations"', 'info');
            log('settingsLog', '4. 检查邮件模板是否正确配置', 'info');
            log('settingsLog', '5. 验证 SMTP 设置或使用 Supabase 默认邮件服务', 'info');
        }

        // 4. 检查用户状态
        async function checkUserStatus() {
            clearLog('userLog');
            log('userLog', '检查用户状态...', 'info');

            try {
                // 获取当前会话
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    log('userLog', `会话错误: ${sessionError.message}`, 'error');
                } else if (session) {
                    log('userLog', '✅ 当前有活跃会话', 'success');
                    log('userLog', `用户ID: ${session.user.id}`, 'info');
                    log('userLog', `邮箱: ${session.user.email}`, 'info');
                    log('userLog', `邮箱确认时间: ${session.user.email_confirmed_at || '未确认'}`, session.user.email_confirmed_at ? 'success' : 'warning');
                    log('userLog', `创建时间: ${session.user.created_at}`, 'info');
                    log('userLog', `最后登录: ${session.user.last_sign_in_at || '未知'}`, 'info');
                } else {
                    log('userLog', '当前无活跃会话', 'info');
                }

                // 获取用户信息
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    log('userLog', `用户信息错误: ${userError.message}`, 'error');
                } else if (user) {
                    log('userLog', '\n用户详细信息:', 'info');
                    log('userLog', JSON.stringify(user, null, 2), 'info');
                } else {
                    log('userLog', '未获取到用户信息', 'warning');
                }

            } catch (error) {
                log('userLog', `检查用户状态异常: ${error.message}`, 'error');
            }
        }

        // 列出所有用户（需要管理员权限）
        async function listUsers() {
            clearLog('userLog');
            log('userLog', '尝试列出所有用户...', 'info');

            try {
                const { data, error } = await supabaseClient.from('users').select('*').limit(10);
                
                if (error) {
                    log('userLog', `❌ 查询失败: ${error.message}`, 'error');
                    log('userLog', '💡 这可能是因为 RLS 策略限制或权限不足', 'warning');
                } else {
                    log('userLog', `✅ 找到 ${data.length} 个用户:`, 'success');
                    data.forEach((user, index) => {
                        log('userLog', `${index + 1}. ${user.email} (${user.username || '无用户名'})`, 'info');
                    });
                }

            } catch (error) {
                log('userLog', `❌ 查询异常: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动测试连接
        window.addEventListener('load', () => {
            setTimeout(testSupabaseConnection, 1000);
        });
    </script>
</body>
</html>