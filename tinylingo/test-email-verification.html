<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶éªŒè¯æµ‹è¯• - TinyLingo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #FFFBF5;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“§ é‚®ä»¶éªŒè¯æµ‹è¯•å·¥å…·</h1>
        
        <!-- Supabase è¿æ¥æµ‹è¯• -->
        <div class="section">
            <h2>1. Supabase è¿æ¥æµ‹è¯•</h2>
            <button onclick="testSupabaseConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="connectionLog" class="log"></div>
        </div>

        <!-- é‚®ä»¶å‘é€æµ‹è¯• -->
        <div class="section">
            <h2>2. é‚®ä»¶å‘é€æµ‹è¯•</h2>
            <div class="form-group">
                <label for="testEmail">æµ‹è¯•é‚®ç®±:</label>
                <input type="email" id="testEmail" placeholder="è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€">
            </div>
            <div class="form-group">
                <label for="testPassword">å¯†ç :</label>
                <input type="password" id="testPassword" placeholder="è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
            </div>
            <div class="form-group">
                <label for="testUsername">ç”¨æˆ·å:</label>
                <input type="text" id="testUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
            </div>
            <button onclick="testEmailSending()">æµ‹è¯•æ³¨å†Œé‚®ä»¶å‘é€</button>
            <button onclick="testPasswordReset()">æµ‹è¯•å¯†ç é‡ç½®é‚®ä»¶</button>
            <div id="emailLog" class="log"></div>
        </div>

        <!-- Supabase é‚®ä»¶é…ç½®æ£€æŸ¥ -->
        <div class="section">
            <h2>3. Supabase é‚®ä»¶é…ç½®æ£€æŸ¥</h2>
            <button onclick="checkEmailSettings()">æ£€æŸ¥é‚®ä»¶è®¾ç½®</button>
            <div id="settingsLog" class="log"></div>
        </div>

        <!-- ç”¨æˆ·çŠ¶æ€æ£€æŸ¥ -->
        <div class="section">
            <h2>4. ç”¨æˆ·çŠ¶æ€æ£€æŸ¥</h2>
            <button onclick="checkUserStatus()">æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€</button>
            <button onclick="listUsers()">åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰</button>
            <div id="userLog" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://knizbnlzwcuniceqvmvd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuaXpibmx6d2N1bmljZXF2bXZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NjQ3ODQsImV4cCI6MjA3NTI0MDc4NH0.NJxl1MvhdG2vFUoMkCClV4VkLtjfok7eJ6zxzqSzuHQ';

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                flowType: 'pkce'
            }
        });

        // æ—¥å¿—å‡½æ•°
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // 1. æµ‹è¯• Supabase è¿æ¥
        async function testSupabaseConnection() {
            clearLog('connectionLog');
            log('connectionLog', 'å¼€å§‹æµ‹è¯• Supabase è¿æ¥...', 'info');

            try {
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                const { data, error } = await supabaseClient.from('users').select('count').limit(1);
                
                if (error) {
                    log('connectionLog', `è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                    log('connectionLog', `é”™è¯¯ä»£ç : ${error.code}`, 'error');
                } else {
                    log('connectionLog', 'âœ… Supabase è¿æ¥æˆåŠŸï¼', 'success');
                }

                // æµ‹è¯•è®¤è¯çŠ¶æ€
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    log('connectionLog', `å½“å‰ç”¨æˆ·: ${user.email} (${user.id})`, 'info');
                    log('connectionLog', `é‚®ç®±å·²éªŒè¯: ${user.email_confirmed_at ? 'æ˜¯' : 'å¦'}`, user.email_confirmed_at ? 'success' : 'warning');
                } else {
                    log('connectionLog', 'å½“å‰æ— ç™»å½•ç”¨æˆ·', 'info');
                }

            } catch (error) {
                log('connectionLog', `è¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 2. æµ‹è¯•é‚®ä»¶å‘é€
        async function testEmailSending() {
            clearLog('emailLog');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const username = document.getElementById('testUsername').value;

            if (!email || !password) {
                log('emailLog', 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            log('emailLog', `å¼€å§‹æµ‹è¯•æ³¨å†Œé‚®ä»¶å‘é€...`, 'info');
            log('emailLog', `é‚®ç®±: ${email}`, 'info');
            log('emailLog', `ç”¨æˆ·å: ${username}`, 'info');

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            display_name: username,
                        },
                        emailRedirectTo: `${window.location.origin}/auth/callback`,
                    },
                });

                log('emailLog', `Supabase å“åº”:`, 'info');
                log('emailLog', JSON.stringify({ data, error }, null, 2), 'info');

                if (error) {
                    log('emailLog', `âŒ æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                    
                    // åˆ†æå¸¸è§é”™è¯¯
                    if (error.message.includes('User already registered')) {
                        log('emailLog', 'ğŸ’¡ è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚è¯·å°è¯•å…¶ä»–é‚®ç®±ã€‚', 'warning');
                    } else if (error.message.includes('Password should be at least')) {
                        log('emailLog', 'ğŸ’¡ å¯†ç é•¿åº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨è‡³å°‘6ä¸ªå­—ç¬¦ã€‚', 'warning');
                    } else if (error.message.includes('Invalid email')) {
                        log('emailLog', 'ğŸ’¡ é‚®ç®±æ ¼å¼æ— æ•ˆã€‚', 'warning');
                    } else if (error.message.includes('Email rate limit exceeded')) {
                        log('emailLog', 'ğŸ’¡ é‚®ä»¶å‘é€é¢‘ç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•ã€‚', 'warning');
                    }
                } else if (data.user) {
                    log('emailLog', `âœ… æ³¨å†Œè¯·æ±‚æˆåŠŸï¼`, 'success');
                    log('emailLog', `ç”¨æˆ·ID: ${data.user.id}`, 'success');
                    log('emailLog', `é‚®ç®±ç¡®è®¤çŠ¶æ€: ${data.user.email_confirmed_at ? 'å·²ç¡®è®¤' : 'å¾…ç¡®è®¤'}`, data.user.email_confirmed_at ? 'success' : 'warning');
                    
                    if (!data.user.email_confirmed_at) {
                        log('emailLog', 'ğŸ“§ è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼‰æŸ¥çœ‹éªŒè¯é‚®ä»¶ã€‚', 'info');
                        log('emailLog', 'â° éªŒè¯é‚®ä»¶å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½åˆ°è¾¾ã€‚', 'info');
                    }
                }

            } catch (error) {
                log('emailLog', `âŒ æ³¨å†Œå¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å¯†ç é‡ç½®é‚®ä»¶
        async function testPasswordReset() {
            clearLog('emailLog');
            const email = document.getElementById('testEmail').value;

            if (!email) {
                log('emailLog', 'è¯·å¡«å†™é‚®ç®±åœ°å€', 'error');
                return;
            }

            log('emailLog', `å¼€å§‹æµ‹è¯•å¯†ç é‡ç½®é‚®ä»¶...`, 'info');

            try {
                const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: `${window.location.origin}/auth/callback`,
                });

                if (error) {
                    log('emailLog', `âŒ å¯†ç é‡ç½®å¤±è´¥: ${error.message}`, 'error');
                } else {
                    log('emailLog', `âœ… å¯†ç é‡ç½®é‚®ä»¶å‘é€æˆåŠŸï¼`, 'success');
                    log('emailLog', 'ğŸ“§ è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±æŸ¥çœ‹å¯†ç é‡ç½®é‚®ä»¶ã€‚', 'info');
                }

            } catch (error) {
                log('emailLog', `âŒ å¯†ç é‡ç½®å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // 3. æ£€æŸ¥é‚®ä»¶è®¾ç½®
        async function checkEmailSettings() {
            clearLog('settingsLog');
            log('settingsLog', 'æ£€æŸ¥ Supabase é‚®ä»¶é…ç½®...', 'info');

            // æ£€æŸ¥å®¢æˆ·ç«¯é…ç½®
            log('settingsLog', 'å®¢æˆ·ç«¯é…ç½®:', 'info');
            log('settingsLog', `- Supabase URL: ${SUPABASE_URL}`, 'info');
            log('settingsLog', `- è®¤è¯æµç¨‹: PKCE`, 'info');
            log('settingsLog', `- ä¼šè¯æ£€æµ‹: å¯ç”¨`, 'info');
            log('settingsLog', `- é‚®ä»¶é‡å®šå‘: ${window.location.origin}/auth/callback`, 'info');

            // æ£€æŸ¥é‚®ä»¶æ¨¡æ¿å’Œè®¾ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
            log('settingsLog', '\nâš ï¸ æ³¨æ„ï¼šä»¥ä¸‹è®¾ç½®éœ€è¦åœ¨ Supabase æ§åˆ¶å°ä¸­æ£€æŸ¥ï¼š', 'warning');
            log('settingsLog', '1. Authentication > Settings > Email Templates', 'info');
            log('settingsLog', '2. Authentication > Settings > SMTP Settings', 'info');
            log('settingsLog', '3. ç¡®ä¿å¯ç”¨äº† "Enable email confirmations"', 'info');
            log('settingsLog', '4. æ£€æŸ¥é‚®ä»¶æ¨¡æ¿æ˜¯å¦æ­£ç¡®é…ç½®', 'info');
            log('settingsLog', '5. éªŒè¯ SMTP è®¾ç½®æˆ–ä½¿ç”¨ Supabase é»˜è®¤é‚®ä»¶æœåŠ¡', 'info');
        }

        // 4. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        async function checkUserStatus() {
            clearLog('userLog');
            log('userLog', 'æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...', 'info');

            try {
                // è·å–å½“å‰ä¼šè¯
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    log('userLog', `ä¼šè¯é”™è¯¯: ${sessionError.message}`, 'error');
                } else if (session) {
                    log('userLog', 'âœ… å½“å‰æœ‰æ´»è·ƒä¼šè¯', 'success');
                    log('userLog', `ç”¨æˆ·ID: ${session.user.id}`, 'info');
                    log('userLog', `é‚®ç®±: ${session.user.email}`, 'info');
                    log('userLog', `é‚®ç®±ç¡®è®¤æ—¶é—´: ${session.user.email_confirmed_at || 'æœªç¡®è®¤'}`, session.user.email_confirmed_at ? 'success' : 'warning');
                    log('userLog', `åˆ›å»ºæ—¶é—´: ${session.user.created_at}`, 'info');
                    log('userLog', `æœ€åç™»å½•: ${session.user.last_sign_in_at || 'æœªçŸ¥'}`, 'info');
                } else {
                    log('userLog', 'å½“å‰æ— æ´»è·ƒä¼šè¯', 'info');
                }

                // è·å–ç”¨æˆ·ä¿¡æ¯
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    log('userLog', `ç”¨æˆ·ä¿¡æ¯é”™è¯¯: ${userError.message}`, 'error');
                } else if (user) {
                    log('userLog', '\nç”¨æˆ·è¯¦ç»†ä¿¡æ¯:', 'info');
                    log('userLog', JSON.stringify(user, null, 2), 'info');
                } else {
                    log('userLog', 'æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯', 'warning');
                }

            } catch (error) {
                log('userLog', `æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
        async function listUsers() {
            clearLog('userLog');
            log('userLog', 'å°è¯•åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·...', 'info');

            try {
                const { data, error } = await supabaseClient.from('users').select('*').limit(10);
                
                if (error) {
                    log('userLog', `âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                    log('userLog', 'ğŸ’¡ è¿™å¯èƒ½æ˜¯å› ä¸º RLS ç­–ç•¥é™åˆ¶æˆ–æƒé™ä¸è¶³', 'warning');
                } else {
                    log('userLog', `âœ… æ‰¾åˆ° ${data.length} ä¸ªç”¨æˆ·:`, 'success');
                    data.forEach((user, index) => {
                        log('userLog', `${index + 1}. ${user.email} (${user.username || 'æ— ç”¨æˆ·å'})`, 'info');
                    });
                }

            } catch (error) {
                log('userLog', `âŒ æŸ¥è¯¢å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            setTimeout(testSupabaseConnection, 1000);
        });
    </script>
</body>
</html>